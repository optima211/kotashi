!function(e){function t(i){if(a[i])return a[i].exports;var r=a[i]={exports:{},id:i,loaded:!1};return e[i].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var a={};return t.m=e,t.c=a,t.p="",t(0)}([function(e,t,a){e.exports=a(62)},function(e,t){e.exports=function(e,t){return{value:t,done:!!e}}},function(e,t){e.exports={}},,,function(e,t,a){var i=a(28),r=a(17),n=a(85),s=a(21),o=a(59),c=a(78),u=Object.getOwnPropertyDescriptor;t.f=a(50)?u:function(e,t){if(e=n(e),t=s(t,!0),c)try{return u(e,t)}catch(a){}return o(e,t)?r(!i.f.call(e,t),e[t]):void 0}},,function(e,t,a){"use strict";function i(e,t,a,i,r){if("Script error."!==e){var n=r?r.stack||r.message:null;s("unhandled_error",n?{err:e,stack:n}:{err:e})}l&&l.apply(this,arguments)}function r(e){e.preventDefault()}function n(){return!!window.imwl}function s(e,t){n()&&(console.error(e,t),console.trace(),(0,f.retryFn)(d.post,3,function(){return 2})("al_im.php",{act:"a_weird_log",kind:e,data:JSON.stringify(extend({errIdx:h++,ua:navigator.userAgent,noSh:1},t))}))}function o(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return s(e,extend({err:t&&t.message||t},a)),Promise.reject(t)}function c(){l=window.onerror,window.onerror=i,window.addEventListener("unhandledrejection",r)}function u(){window.onerror=l,l=void 0,window.removeEventListener("unhandledrejection",r)}Object.defineProperty(t,"__esModule",{value:!0}),t.isWeirdLogging=n,t.imWeirdLog=s,t.imWeirdCatch=o,t.startLoggingAllUnhandled=c,t.stopLoggingAllUnhandled=u;var l,d=a(127),f=a(10),h=1},function(e,t,a){"use strict";var i=a(93),r=a(69),n=a(50),s=a(129)("species");e.exports=function(e){var t=i[e];n&&t&&!t[s]&&r.f(t,s,{configurable:!0,get:function(){return this}})}},,function(e,t){"use strict";function a(e,t){return new Promise(function(a){setTimeout(a.bind(null,t),1e3*e)})}function i(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=0;return function n(){for(var s=arguments.length,o=Array(s),c=0;s>c;c++)o[c]=arguments[c];return Promise.resolve().then(function(){return e.apply(void 0,o)})["catch"](function(e){if(r++,t>=r){var s="function"==typeof i?i(r):0;return 0===s?n.apply(void 0,o):a(s).then(function(){return n.apply(void 0,o)})}throw e})}}function r(e,t,a){var i=void 0,r=void 0;return function(){for(var n=arguments.length,s=Array(n),o=0;n>o;o++)s[o]=arguments[o];return new Promise(function(e,n){var o=function(){i=null,r=null,a||e(s)},c=a&&!i;clearTimeout(i),r&&r.reject("debounce"),i=setTimeout(o,t),c?e(s):a&&n("debounce"),r={resolve:e,reject:n}}).then(function(t){return e.apply(void 0,t)})}}function n(e,t){var a=void 0,i=new Promise(function(i){a=i,setTimeout(i.bind(null,t),1e3*e)});return{pause:function(){return i},abort:function(){a(t)}}}Object.defineProperty(t,"__esModule",{value:!0}),t.pause=a,t.retryFn=i,t.debouncedPromise=r,t.abortablePause=n},,function(e,t,a){"use strict";function i(){return!curFastChat.version||!curFastChat.tabs}var r=a(42),n=a(87),s=a(81),o=1e4;window.curFastChat||(window.curFastChat={}),window.FastChat={init:function(e){extend(curFastChat,{tabs:{},needPeers:{},gotPeers:{},needMedia:{},gotMedia:{},ldb:(0,r.mount)(vk.id),myTypingEvents:{},typingEvents:{},inited:!0,options:e,posSeq:0,error_timeout:1}),delete curFastChat.standby,delete curFastChat.standbyTO,Notifier.addRecvClbk("fastchat",0,FastChat.lcRecv,!0),Notifier.addRecvClbk("logged_off",0,FastChat.standby,!0),FastChat.lcSend("needSettings",{version:e.version,lang_id:langConfig.id}),clearTimeout(curFastChat.getSettingsTO),curFastChat.getSettingsTO=setTimeout(FastChat.getSettings,300)},getSettings:function(){var e=ls.get("fcFriends"+vk.id);ajax.post("al_im.php",{act:"a_get_fast_chat",friends:e&&e.version,cache_time:FastChat.cachedStickersKeywordsTime()},{onDone:function(t){-1==t.friends?(t.friends_version=e.version,t.friends=e.list):ls.set("fcFriends"+vk.id,{version:t.friends_version,list:t.friends}),FastChat.gotSettings(t),FastChat.sendSettings()},onFail:function(){return!0}})},cachedStickersKeywordsTime:function(){var e=ls.get("stickers_keywords");return e&&e.time?Math.floor(e.time/1e3):0},gotSettings:function(e){e.emoji_stickers&&(window.emojiStickers=e.emoji_stickers),window.Emoji&&Emoji.updateTabs(),clearTimeout(curFastChat.getSettingsTO),window.lang=extend(window.lang||{},e.lang),extend(curFastChat,e,{lang_id:langConfig.id}),curNotifier.is_server&&(e.im_queue?curFastChat.lpInited||FastChat.initLp():(clearTimeout(curFastChat.lp_error_to),curFastChat.lp_error_to=setTimeout(FastChat.updateQueueKeys.bind(FastChat),1e3*(curNotifier.error_timeout||1)))),curFastChat.friendsCnt=Object.keys(curFastChat.friends),setTimeout(FastChat.clistCache.pbind(!1),10),FastChat.initUI()},sendSettings:function(){clearTimeout(curFastChat.sendSettingsTO);var e,t={},a=["friends","friends_version","onlines","tpl","lang","me","version","im_queue","cl_queue"];for(e in a){if("cl_queue"!=a[e]&&void 0===curFastChat[a[e]])return;t[a[e]]=curFastChat[a[e]]}clearTimeout(curFastChat.sendSettingsTO),curFastChat.sendSettingsTO=setTimeout(function(){FastChat.lcSend("settings",{settings:t})},curNotifier.is_server?0:irand(50,100))},becameServer:function(){!curFastChat.lpInited&&curFastChat.version&&(delete curNotifier.addQueues["fastchat"+vk.id],delete curNotifier.addQueues["contacts"+vk.id],curFastChat.im_queue?curFastChat.lpInited||FastChat.initLp():(clearTimeout(curFastChat.lp_error_to),curFastChat.lp_error_to=setTimeout(FastChat.updateQueueKeys.bind(FastChat),1e3*(curNotifier.error_timeout||1))))},destroy:function(){return curFastChat.inited?(curFastChat.ldb.unmount(),FastChat.stopLp(),each(curFastChat.tabs||{},function(e,t){t.box.destroy()}),curFastChat.clistBox&&curFastChat.clistBox.destroy(),each(curFastChat.el||{},function(){cleanElems(this)}),clearInterval(curFastChat.updateFriendsInt),clearInterval(curFastChat.updateTypingsInt),clearTimeout(curFastChat.correspondentsTO),clearTimeout(curFastChat.lp_error_to),curFastChat={inited:!1},!0):!1},isChatOpen:function(e){return window.curFastChat&&curFastChat.inited&&e&&(curFastChat.tabs&&curFastChat.tabs[e]&&curFastChat.tabs[e].box.visible||curFastChat.clistBox&&curFastChat.clistBox.visible)?!0:!1},standby:function(e){FastChat.destroy(),curFastChat.standby=!0;var t=1,a=function i(){return curNotifier.is_server?void ajax.post("notifier.php?act=a_get_reload",{version:e},{onDone:function(e,t){FastChat.lcSend("gotConfig",{navVersion:e,config:t}),FastChat.gotConfig(e,t)},onFail:function(){return t*=2,clearTimeout(curFastChat.standbyTO),curFastChat.standbyTO=setTimeout(i,1e3*t),!0}}):(clearTimeout(curFastChat.standbyTO),void(curFastChat.standbyTO=setTimeout(i,1e3*t)))};a()},gotConfig:function(e,t){clearTimeout(curFastChat.standbyTO),curFastChat.standby&&setTimeout(function(){e>stVersions.nav&&(debugLog("appending al loader"),headNode.appendChild(ce("script",{type:"text/javascript",src:"/js/loader_nav"+e+"_"+vk.lang+".js"}))),setTimeout(function(){return e<=stVersions.nav?void stManager.add(["notifier.js","notifier.css","emoji.js"],function(){FastChat.init(t)}):void setTimeout(arguments.callee,100)},0)},curNotifier.is_server?0:irand(1e3,2e3))},updateVersion:function(e){FastChat.lcSend("standby",{version:e}),FastChat.standby(e)},lcSend:function(e,t){Notifier.lcSend("fastchat",extend({act:e,__id:curFastChat.me&&curFastChat.me.id||vk.id},t))},lcRecv:function(e){if(!isEmpty(e)){var t=e.act;e.__id==(curFastChat.me&&curFastChat.me.id||vk.id)&&(delete e.act,delete e.__id,FastChat.lcFeed(t,e))}},lcFeed:function(e,t){switch(e){case"needSettings":curFastChat.version<t.version||t.lang_id==curFastChat.lang_id&&FastChat.sendSettings();break;case"settings":!curFastChat.version&&curFastChat.options&&t.settings.version==curFastChat.options.version&&FastChat.gotSettings(t.settings),clearTimeout(curFastChat.sendSettingsTO);break;case"standby":if(i())break;FastChat.standby(t.version);break;case"gotConfig":FastChat.gotConfig(t.navVersion,t.config);break;case"clFeed":if(i())break;FastChat.clFeed(t.events);break;case"clistOnlines":if(i())break;FastChat.clistGotOnlines(t);break;case"imFeeds":if(i())break;FastChat.imFeeds(t);break;case"needPeer":if(i())break;var a,r=t.id,n=curFastChat.tabs[r],s=!1;if(void 0!==n){s={name:n.name,photo:n.photo,fname:n.fname,hash:n.hash,sex:n.sex,data:n.data,online:n.online};for(var o in n.msgs){s.history=[n.log.innerHTML,n.msgs];break}}else(a=curFastChat.friends[r+"_"])&&(s={name:a[0],photo:a[1],fname:a[2],hash:a[3],data:a[4],online:curFastChat.onlines[r]});if(s===!1)break;curFastChat.gotPeers[r]=setTimeout(function(){var e={};e[r]=s,FastChat.lcSend("gotPeers",e)},curNotifier.is_server?0:irand(50,100));break;case"fetchingPeers":if(i())break;each(t,function(e,t){var a=curFastChat.needPeers[e];a&&(t&a[0])==a[0]&&clearTimeout(a[2])});break;case"gotPeers":if(i())break;FastChat.gotPeers(t);break;case"stateChange":if(i())break;FastChat.onStateChanged(t);break;case"queueSet":extend(curFastChat,t);break;case"queueClean":curNotifier.is_server||(delete curFastChat.im_queue,delete curFastChat.cl_queue);break;case"needMedia":var c=t.msgId,u=curFastChat.gotMedia[c];if(void 0===u||0===u)break;curFastChat.gotMedia[c][3]=setTimeout(function(){FastChat.lcSend("gotMedia",{msgId:c,peer:u[0],text:u[1],msgOpts:u[2]})},curNotifier.is_server?0:irand(50,100));break;case"fetchingMedia":var c=t.msgId,l=curFastChat.needMedia[c];if(void 0===l||0===curFastChat.gotMedia[c])break;clearTimeout(l[1]),l[1]=setTimeout(FastChat.loadMsgMedia.pbind(l[0],c),1e3);break;case"gotMedia":var c=t.msgId,u=curFastChat.gotMedia[c];isArray(u)&&clearTimeout(u[3]),FastChat.gotMsgMedia(t.peer,c,t.text,t.msgOpts)}},initLp:function(){curFastChat.lpInited=!0,FastChat.checkLp(),curFastChat.checkLpInt=setInterval(FastChat.checkLp,2e4)},stopLp:function(){curFastChat.lpInited=!1,clearInterval(curFastChat.checkLpInt),delete curFastChat.im_queue,delete curFastChat.cl_queue},checkLp:function(){curNotifier.is_server&&curFastChat.im_queue&&(Notifier.addKey({queue:curFastChat.im_queue.id,key:curFastChat.im_queue.key,ts:curFastChat.im_queue.ts},FastChat.imChecked,!0),curFastChat.cl_queue&&Notifier.addKey({queue:curFastChat.cl_queue.id,key:curFastChat.cl_queue.key,ts:curFastChat.cl_queue.ts},FastChat.clChecked,!0),FastChat.lcSend("queueSet",{im_queue:curFastChat.im_queue,cl_queue:curFastChat.cl_queue}))},updateQueueKeys:function(){curFastChat.updatingQueues||(curFastChat.updatingQueues=1,FastChat.lcSend("queueClean"),FastChat.stopLp(),ajax.post("al_im.php",{act:"a_get_fc_queue"},{onDone:function(e){return e.version>curFastChat.version?void FastChat.updateVersion(e.version):(delete curFastChat.updatingQueues,extend(curFastChat,e),FastChat.lcSend("queueSet",e),void(curNotifier.is_server&&(FastChat.initLp(),FastChat.clistUpdate())))},onFail:function(){return delete curFastChat.updatingQueues,FastChat.destroy(),!0}}))},clChecked:function(e,t){if(curFastChat.inited&&curFastChat.ready&&curFastChat.cl_queue){if(t.failed)return clearTimeout(curFastChat.lp_error_to),void(curFastChat.lp_error_to=setTimeout(FastChat.updateQueueKeys.bind(FastChat),1e3*(curNotifier.error_timeout||1)));t.ts&&(t.key&&(curFastChat.cl_queue.key=t.key),curFastChat.cl_queue.ts=t.ts,FastChat.lcSend("queueSet",{cl_queue:curFastChat.cl_queue})),isArray(t.events)&&t.events.length&&(FastChat.clFeed(t.events),FastChat.lcSend("clFeed",{events:t.events}))}},clFeed:function(e){if(curFastChat.inited&&curFastChat.ready&&curFastChat.tabs){var t=!1,a=!1;each(e,function(){var e=this.split("<!>"),i=e[0],r=e[1],n=e[2],s=e[3]?e[3]:1,o=curFastChat.tabs[n],c=curFastChat.onlines[n];if(i!=curFastChat.version)return FastChat.updateVersion(i),a=!0,!1;if(curFastChat.friends[n+"_"]||o)switch(r){case"online":if(c==s)break;curFastChat.onlines[n]=s,FastChat.tabNotify(n,"online",s),t=!0;break;case"offline":if(!c)break;delete curFastChat.onlines[n],re("fc_contact"+n)&&curFastChat.clistBox.visible&&FastChat.clistShowMore(),FastChat.tabNotify(n,"offline")}}),a||(t&&curFastChat.clistBox.visible&&curNotifier.idle_manager&&!curNotifier.idle_manager.is_idle&&(curFastChat.el.clist.scrollTop<100||curRBox.active!=curFastChat.clistBox.id)?FastChat.clistRender():FastChat.clistUpdateTitle())}},imChecked:function(e,t){if(curFastChat.inited&&curFastChat.ready&&curFastChat.im_queue){if(t.failed)return clearTimeout(curFastChat.lp_error_to),void(curFastChat.lp_error_to=setTimeout(FastChat.updateQueueKeys.bind(FastChat),1e3*(curNotifier.error_timeout||1)));if(t.ts&&curFastChat.im_queue&&(t.key&&(curFastChat.im_queue.key=t.key),curFastChat.im_queue.ts=t.ts,FastChat.lcSend("queueSet",{im_queue:curFastChat.im_queue})),isArray(t.events)&&t.events.length){var a={},i=!1;each(t.events,function(){var e=this.split("<!>"),t=e[0],r=e[1],n=e[2],s=0;if(t!=curFastChat.version)return FastChat.updateVersion(t),i=!0,!1;switch(r){case"read":case"sebastianov":break;case"typing":s=1;break;case"new":s=2&e[4]?0:2;break;default:return}a[n]||(a[n]=[0]),a[n][0]|=s,a[n].push(e)}),i||isEmpty(a)||(FastChat.lcSend("imFeeds",a),FastChat.imFeeds(a))}}},imFeeds:function(e){curFastChat.inited&&curFastChat.ready&&each(e,function(e,t){t.shift(),FastChat.imFeed(e,t)})},blinkEl:function(e,t,a){return t>10?(a(),!1):void(t%2==0?animate(e,{opacity:0},400,function(){FastChat.blinkEl(e,t+1,a)}):animate(e,{opacity:1},400,function(){setTimeout(function(){FastChat.blinkEl(e,t+1,a)},400)}))},blinkTyping:function(e){var t=ge("chat_tab_icon_"+e);if(t){var a=geByClass1("chat_tab_typing_wrap",t);fadeIn(a,150,function(){FastChat.blinkEl(a.firstChild,0,function(){fadeOut(a,150)})})}},imFeed:function(e,t){var a=curFastChat.tabs[e],i=vkNow();return each(t,function(t,a){switch(a[1]){case"new":1===(3&a[4])&&FastChat.changePeerCounter(e,1);break;case"read":var i=1;each(a[3].split(","),function(e,t){i+=1}),FastChat.changePeerCounter(e,-i);break;case"typing":Chat.tabs[e]&&FastChat.blinkTyping(e)}}),a?(each(t,function(t,r){switch(r[1]){case"new":stManager.add(["imn.js"],function(){intval(r[8])&&(0,s.confirmDelivery)(r[3]),each(a.sentmsgs,function(e,t){var a=ge("fc_msg"+t),i=a&&a.parentNode;re(a)&&i&&!geByClass("fc_msg",i).length&&re(domClosest("fc_msgs_wrap",i))});var t=ge("fc_msg"+r[3]);t||(FastChat.addMsg(FastChat.prepareMsgData(r.slice(2))),a.msgs[r[3]]=[2&r[4]?1:0,1&r[4]],1===(3&r[4])&&a.unread++,FastChat.scroll(e)),FastChat.blinkTab(e)});break;case"read":var n=[],o=intval(r[3]);each(a.msgs,function(e){intval(e)<=o&&a.msgs[e][1]&&n.push(intval(e))}),each(n,function(e,t){var i,r=ge("fc_msg"+t);r&&(i=a.msgs[t]&&a.msgs[t][0]?r.parentNode.parentNode:r.parentNode,a.msgs[t]&&a.msgs[t][1]&&(a.msgs[t][1]=0,a.msgs[t][0]||a.unread--),removeClass(r,"fc_msg_unread"),hasClass(i.parentNode,"fc_msgs_unread")&&each(i.childNodes,function(){return hasClass(this,"fc_msg_unread")?void 0:(removeClass(i.parentNode,"fc_msgs_unread"),!1)}))});break;case"typing":e>2e9?(curFastChat.typingEvents[e]||(curFastChat.typingEvents[e]={}),curFastChat.typingEvents[e][r[3]]=i):curFastChat.typingEvents[e]=i,FastChat.updateTyping(e);break;case"sebastianov":var c=a.msgs[r[3]];c&&(delete curFastChat.gotMedia[r[3]],r[4]=(c[0]?2:0)+(c[1]?1:0),FastChat.sebastianovMsg(FastChat.prepareMsgData(r.slice(2))))}}),a.unread>0&&(a.unread=0,each(a.msgs,function(){!this[0]&&this[1]&&a.unread++})),a.auto&&!a.unread&&(a.box._close(!0),delete curFastChat.tabs[e]),void FastChat.updateUnreadTab(e)):!1},tabNotify:function(e,t,a){var i=curFastChat.tabs[e],r=void 0;if(e>0&&2e9>e&&isFunction(cur.onPeerStatusChanged)&&cur.onPeerStatusChanged(e,t,a),!(0>=e)&&i&&i.box&&!i.box.minimized){switch(clearTimeout(i.hideNotifyTO),t){case"online":r=getLang("mail_im_user_became_online",3-i.sex),FastChat.blinkTab(e);break;case"offline":r=getLang("mail_im_user_became_offline",3-i.sex),FastChat.blinkTab(e);break;case"unavail":r=getLang("mail_im_not_online",3-i.sex).replace(/\.$/,"")}r=r.replace("{user}",i.fname),val(i.notify,'<div class="fc_tab_notify fc_tab_notify_'+t+'">'+r+"</div>");var n=i.notify.firstChild;clearTimeout(i.hideNotifyTO),i.hideNotifyTO=setTimeout(function(){fadeOut(n,200,function(){val(i.notify,"")})},5e3)}},hideChatCtrl:function(){removeClass(Chat.wrap,"chat_active"),removeEvent(document,"mousedown",FastChat.onDocClick)},showChatCtrl:function(){addClass(Chat.wrap,"chat_active"),setTimeout(function(){addEvent(document,"mousedown",FastChat.onDocClick)},0)},hideUI:function(){addClass(bodyNode,"chat_onl_hidden")},showUI:function(){removeClass(bodyNode,"chat_onl_hidden")},initUI:function(){if(curFastChat.options){var e=curFastChat.el={},t=getWndInner();re("rb_box_fc_clist"),e.clistWrap=se(curFastChat.tpl.clist),e.clist=geByClass1("fc_contacts",e.clistWrap,"div"),e.clistTitle=geByClass1("fc_tab_title",e.clistWrap,"div"),e.clistOnline=geByClass1("fc_clist_online",e.clistWrap,"div");var a=curFastChat.options.state||!1,i=!curFastChat.friendsCnt||(a&&void 0!==a.clist.min?a.clist.min:t[1]<1200||curFastChat.friendsCnt<5);curFastChat.clistW=270,curFastChat.clistH=299;var r={id:"fc_clist",movable:geByClass1("fc_tab_head",e.clistWrap),hider:geByClass1("fc_tab_close_wrap",e.clistWrap,"a"),startHeight:curFastChat.clistH,startWidth:curFastChat.clistW,resizeableH:e.clist,resize:!1,minH:150,fixed:i,onHide:function(t){val("fc_clist_filter",curFastChat.q=""),addClass(curFastChat.clistBox.wrap,"fc_fixed"),curFastChat.clistBox.fixed=!0,FastChat.stateChange({op:"clist_toggled",val:0}),setStyle(curFastChat.clistBox.wrap,{top:"auto",bottom:0,right:72,left:"auto"}),show(e.topLink),FastChat.hideChatCtrl()},onShow:function(){FastChat.showChatCtrl()},onDragEnd:function(e,t){FastChat.stateChange({op:"clist_moved",y:e,x:t})},onResize:function(e,t){curFastChat.clistBoxScroll&&curFastChat.clistBoxScroll.update(!1,!0)}};a&&!i&&(a.clist.x!==!1&&(-1==a.clist.x?r.startRight=0:r.startLeft=t[1]*a.clist.x),a.clist.y!==!1&&(-1==a.clist.y?r.startBottom=0:r.startTop=t[0]*a.clist.y)),i&&(r.noshow=!0),void 0===r.startTop&&void 0===r.startBottom&&(r.startTop=t[0]<800?0:.1*t[0]),void 0===r.startLeft&&void 0===r.startRight&&(r.startRight=0),curFastChat.clistBox=new RBox(e.clistWrap,r),r.noshow||void 0===r.startLeft&&void 0===r.startTop||curFastChat.clistBox._wnd_resize(t[0],t[1],!0),curFastChat.clistBoxScroll=new Scrollbar(e.clist,{prefix:"fc_",scrollChange:FastChat.clistShowMore,nomargin:!0,global:!0,nokeys:!0,right:vk.rtl?"auto":1,left:vk.rtl?1:"auto"}),curFastChat.updateFriendsInt=setInterval(FastChat.clistUpdate,18e4),curFastChat.updateTypingsInt=setInterval(FastChat.updateTypings,5e3);var n=ge("fc_clist_filter");if(placeholderInit(n,{global:!0}),curFastChat.q="",addEvent(n,"keyup "+(browser.opera?"keypress":"keydown"),function(e){if(e.keyCode==KEY.ESC)return FastChat.clistHide(),cancelEvent(e);var t=FastChat.clistFilterKey(e);return void 0!==t?t:(curFastChat.q=trim(val(this)),void FastChat.clistRender())}),e.clistOnline){var s;bodyNode.appendChild(s=ce("nobr",{className:"fl_l",innerHTML:getLang("mail_im_clist_onlines")},{visibility:"hidden",position:"absolute"})),re(s),addEvent(e.clistOnline,"mouseover",function(t){showTooltip(this,{text:getLang("mail_im_clist_onlines"),forcetoup:1,shift:[12,4,3],className:"tt_fc_onlines",init:function(){browser.msie&&(e.clistOnline.tt.isFixed=!1)},black:1})}),addEvent(e.clistOnline,"click",function(e){(e.originalEvent||e).cancelBubble=!0,FastChat.clistToggleOnlines(),FastChat.clistRender()}),a&&a.clist&&a.clist.onlines&&FastChat.clistToggleOnlines(!0)}i?FastChat.clistUpdateTitle():FastChat.clistRender(),curFastChat.ready=!0,a&&a.tabs&&each(a.tabs,function(e,a){e=intval(e);var i={nofocus:1};this.min&&(i.minimized=!0),this.h&&(i.startHeight=this.h*t[0]),this.w&&(i.startWidth=this.w*t[1]),void 0!==this.x&&this.x<=1&&(this.x<0?i.startRight=0:i.startLeft=t[1]*this.x),void 0!==this.y&&this.y<=1&&(this.y<0?i.startBottom=0:i.startTop=t[0]*this.y),a.fx?(i.fixedLoad=!0,FastChat.prepareTabIcon(e,i,!0)):(i.noAnim=!0,FastChat.addPeer(e,!1,!1,i))}),addEvent(Chat.itemsCont,"mousemove mouseover",FastChat.itemsTT),addEvent(Chat.itemsCont,"mouseout",FastChat.itemsOut)}},itemsOffset:12,itemsTT:function(e){for(var t=e.target,a=!1;t&&t!=Chat.itemsCont;){if(hasClass(t,"chat_tab_wrap")){a=t;break}t=t.parentNode}if(!a)return clearTimeout(Chat.ttOutTimeout),Chat.ttOutTimeout=!1,!1;var i=a.id.split("_")[3],r=Chat.tabs[i];return r?curFastChat.activeBox&&curFastChat.activeBox.visible&&curFastChat.activeBox.options.peer==i?(FastChat.itemsOut(),!1):(clearTimeout(Chat.ttOutTimeout),Chat.ttOutTimeout=!1,showTooltip(a,{text:r.name,slideX:15,black:1,asrtl:1,appendEl:Chat.ttNode,className:"tt_black_side",shift:[-58,-37,0]}),void(Chat.ttPeer=a)):!1},itemsOut:function(){return Chat.ttOutTimeout?!1:void(Chat.ttOutTimeout=setTimeout(function(){return Chat.ttOutTimeout=!1,Chat.ttPeer?(triggerEvent(Chat.ttPeer,"mouseout"),void(Chat.ttPeer=!1)):!1},0))},stateChange:function(e){ajax.post("al_im.php",extend({act:"a_state_fc",hash:curFastChat.options.state_hash||""},e),{onFail:function(){return!0}}),FastChat.lcSend("stateChange",e)},onStateChanged:function(e){var t=e.peer?curFastChat.tabs[e.peer]:!1,a=e.peer?t&&t.box:curFastChat.clistBox,i=getWndInner();switch(e.op){case"added":if(t){delete t.auto;break}e.fixed?FastChat.prepareTabIcon(e.peer,{fixedLoad:!0}):FastChat.addPeer(e.peer);break;case"unfixed":var r={startHeight:intval(i[0]*e.h),startWidth:intval(i[1]*e.w)};-1==e.y?r.startBottom=0:r.startTop=intval(i[0]*e.y),-1==e.x?r.startRight=0:r.startLeft=intval(i[1]*e.x),FastChat.addPeer(e.peer,!1,!1,r);break;case"closed":if(Chat.tabs[e.peer]&&FastChat.closeTabIcon(e.peer),!t||!a)break;a.close();break;case"hidden":if(!t||!a)break;a.close();break;case"minimized":if(!t||!a)break;e.val?a.unminimize():a.minimize();break;case"moved":setStyle(a.wrap,{bottom:-1==e.y?0:"auto",top:-1!=e.y?intval(i[0]*e.y):"auto",right:-1==e.x?0:"auto",left:-1!=e.x?intval(i[1]*e.x):"auto"}),a.toBottom=-1==e.y,a.toRight=-1==e.x;break;case"resized":setStyle(a.wrap,{bottom:-1==e.y?0:"auto",top:-1!=e.y?intval(i[0]*e.y):"auto",right:-1==e.x?0:"auto",left:-1!=e.x?intval(i[1]*e.x):"auto"}),a.toBottom=-1==e.y,a.toRight=-1==e.x;var n=intval(i[1]*e.w);setStyle(a.resizeableH,"height",intval(i[0]*e.h)),setStyle(a.resizeableW,"width",n),FastChat.fixResized(t,n);break;case"clist_toggled":e.val?a.show(0,!0):a.hide(0,!0),toggle(curFastChat.el.topLink,!e.val);break;case"clist_moved":setStyle(a.wrap,{bottom:-1==e.y?0:"auto",top:-1!=e.y?intval(i[0]*e.y):"auto",right:-1==e.x?0:"auto",left:-1!=e.x?intval(i[1]*e.x):"auto"}),a.toBottom=-1==e.y,a.toRight=-1==e.x;break;case"onlines_toggled":FastChat.clistToggleOnlines(e.val),FastChat.clistRender()}},onUnidle:function(){curNotifier.version&&curFastChat.clistBox&&(curFastChat.clistBox.visible&&(curFastChat.el.clist.scrollTop<100||curRBox.active!=curFastChat.clistBox.id)?FastChat.clistRender():FastChat.clistUpdateTitle(),each(curFastChat.tabs,function(e){FastChat.restoreDraft(e)}))},clistUpdate:function(){var e=vkNow();if(curNotifier.is_server&&!(curFastChat.clistUpdatedTs&&e-curFastChat.clistUpdatedTs<6e4)){curFastChat.clistUpdatedTs=e;var t,a=[];for(t in curFastChat.tabs)a.push(t);for(t in Chat.tabs)a.push(t);ajax.post("al_im.php",{act:"a_onlines",peer:a.join(",")},{onDone:function(e){FastChat.clistGotOnlines(e),FastChat.lcSend("clistOnlines",e)}})}},clistGotOnlines:function(e){var t=curFastChat.onlines,a=[];curFastChat.onlines=e,curNotifier.idle_manager&&curNotifier.idle_manager.is_idle||!curFastChat.tabs&&Chat.tabs||(each(curFastChat.tabs,function(i){curFastChat.onlines[i]!=t[i]&&(FastChat.tabNotify(i,e[i]?"online":"offline",e[i]),e[i]||(a[i]=1))}),each(Chat.tabs,function(a){if(curFastChat.onlines[a]!=t[a]){var i=geByClass1("_chat_tab_image",ge("chat_tab_icon_"+a));toggleClass(i,"online",e[a]),toggleClass(i,"mobile",e[a]&&mobPlatforms[e[a]])}}),a=arrayKeyDiff(t,e,a),each(a,function(e){FastChat.tabNotify(e,"offline")}),FastChat.clistRender())},clistShow:function(){var e=hasClass(Chat.wrap,"chat_active");FastChat.clistRender(),curFastChat.clistBox.visible?curFastChat.clistBox.focus():(curFastChat.activeBox&&curFastChat.activeBox!=curFastChat.clistBox&&curFastChat.activeBox.hide(),curFastChat.clistBox.show(),FastChat.setActive(curFastChat.clistBox),curFastChat.clistBoxScroll&&curFastChat.clistBoxScroll.update(!1,!0),curFastChat.el.topLink&&hide(curFastChat.el.topLink)),elfocus("fc_clist_filter"),FastChat.movePointer(!1,e)},clistHide:function(){curFastChat.clistBox.hide(),curFastChat.activeBox==curFastChat.clistBox&&FastChat.setActive(!1)},clistRender:function(e){var t=[],a=!e,i=1+(e?40:20),r=curFastChat.q,n=!1,s=!1,o=!1;if(r?(o=[],each(FastChat.clistCache(r),function(){o.push(escapeRE(this))}),o=new RegExp("([ -]|^|s|&nbsp;|\b)("+o.join("|")+")","gi"),n=curFastChat.clistCache[r]||{}):curFastChat.clOnlines&&(n=curFastChat.onlines),curFastChat.clHasMore=!1,each(curFastChat.friends,function(e){var r=intval(e),c=!n||n[r];if(!a)return void(r==curFastChat.clOffset&&(a=!0));if(c){if(!--i)return curFastChat.clHasMore=!0,!1;t.push(FastChat.clistWrapPeer(r,this,o)),s=r}}),s!==!1||e||r?r&&!curFastChat.clHasMore&&t.push(FastChat.getCorrespondents(r,o,s===!1)):t.push('<div class="fc_clist_empty">'+getLang(r?"mail_im_clist_notfound":"mail_im_clist_empty")+"</div>"),curFastChat.clOffset=s,e){for(var c=ce("div",{innerHTML:t.join("")}),u=document.createDocumentFragment();c.firstChild;)u.appendChild(c.firstChild);curFastChat.el.clist.appendChild(u),curFastChat.clHasMore||FastChat.clistUpdateTitle(!0)}else val(curFastChat.el.clist,t.join("")),FastChat.clistUpdateTitle(!0),(browser.chrome||browser.safari)&&setTimeout(function(){setStyle(curFastChat.el.clist.firstChild,{width:curFastChat.el.clist.firstChild.clientWidth}),setTimeout(function(){setStyle(curFastChat.el.clist.firstChild,{width:""})},0)},0);if(curFastChat.clSel){var l=ge("fc_contact"+curFastChat.clSel);l?FastChat.clistPeerOver(l,1):curFastChat.clSel=!1}else{var l=geByClass1("fc_contact",curFastChat.el.clist);FastChat.clistPeerOver(l,1)}curFastChat.clistBoxScroll&&curFastChat.clistBoxScroll.update()},clistWrapPeer:function(e,t,a){var i,r,n=curFastChat.tabs[e]?curFastChat.tabs[e].unread:0,s=curFastChat.onlines[e],o=onlinePlatformClass(s),c=(t[0]||"").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");if(a&&(c=c.replace(a,'$1<em class="fc_clist_hl">$2</em>')),e>0&&2e9>e?(i="/id"+e,r='onmousemove="FastChat.clistPeerOver(this.parentNode, 2);"  onmouseout="FastChat.clistPeerOver(this.parentNode, 1);"'):(i="/im?sel="+e,r=""),e>2e9&&t[3])var u=t[3];else var u='<img src="'+Notifier.fixPhoto(t[1])+'" class="fc_contact_photo"/>';return'<a href="'+i+'" class="fc_contact clear_fix" id="fc_contact'+e+'" onclick="return FastChat.selectPeer('+e+', event);" onmousedown="event.cancelBubble = true;" onmouseover="FastChat.clistPeerOver(this, 1, event);"  onmouseout="FastChat.clistPeerOver(this, 0, event);"><span class="fc_contact_photo'+o+'" '+r+">"+u+'</span><span class="fc_contact_status"></span><span class="fc_contact_name">'+c+'<span id="fc_contact_unread'+e+'" class="fc_contact_unread">'+(n?" <b>+"+n+"</b>":"")+"</span></span></a>"},clistPeerOver:function(e,t,a){if(e&&checkOver(a,e)){var i=e.id.substr(10);curFastChat.clSel&&t&&curFastChat.clSel!=i&&FastChat.clistPeerOver(ge("fc_contact"+curFastChat.clSel),0),toggleClass(e,"fc_contact_over",t),t?curFastChat.clSel=i:curFastChat.clSel==i&&(curFastChat.clSel=!1)}},authorOver:function(e,t){var a=e.getAttribute("data-title"),i=gpeByClass("fc_tab_log",e),r=!1,n=e.getBoundingClientRect().top,s=i.getBoundingClientRect().top;if(10>n-s&&(r=!0),a){var o=e.getAttribute("data-date");o&&(a+="<br>"+o),showTooltip(e,{text:'<div class="fc_author_tt">'+a+"</div>",black:1,center:1,forcetodown:r,shift:[1,8,0]})}},getCorrespondents:function(e,t,a){return clearTimeout(curFastChat.correspondentsTO),curFastChat.correspondents&&void 0!==curFastChat.correspondents[e]?FastChat.wrapCorrespondents(curFastChat.correspondents[e])||a&&'<div class="fc_clist_empty">'+getLang("mail_im_clist_notfound")+"</div>"||"":(curFastChat.correspondentsTO=setTimeout(FastChat.loadCorrespondents.pbind(e,t),100),'<div id="fc_correspondents"></div>')},loadCorrespondents:function(e,t){e==curFastChat.q&&ajax.post("hints.php",{act:"a_json_friends",str:e,from:"fc",allow_multi:1},{onDone:function(a){curFastChat.correspondents||(curFastChat.correspondents={});var i,r={};if(each(a,function(){i=this[3]+"_",curFastChat.friends[i]||(r[i]=[this[1],this[2],this[3],this[4]||""])}),curFastChat.correspondents[e]=r,e==curFastChat.q){var n=ge("fc_correspondents");if(n){var s=n.parentNode,o=ce("div",{innerHTML:FastChat.wrapCorrespondents(r,t)}),c=document.createDocumentFragment();if(o.firstChild)for(;o.firstChild;)c.appendChild(o.firstChild);else s.firstChild==n&&c.appendChild(ce("div",{className:"fc_clist_empty",innerHTML:getLang("mail_im_clist_notfound")}));s.replaceChild(c,n),FastChat.clistUpdateTitle(!0),curFastChat.clistBoxScroll&&curFastChat.clistBoxScroll.update()}}}})},wrapCorrespondents:function(e,t){var a=[];return each(e,function(e){a.push(FastChat.clistWrapPeer(intval(e),this,t))}),a.join("")},updateFriends:function(e){if(window.Chat&&Chat.inited){var t=Chat.onl;t&&(e>0?(val(t,e),show(Chat.wrap)):hide(Chat.wrap))}},onDocClick:function(e){if(curFastChat.activeBox){var t=e.target;if(curBox())return!0;for(;t;){if("fc_tab_wrap"==t.className||"chat_onl_wrap"==t.id||"custom_menu_cont"==t.id||"layer_wrap"==t.id||"box_layer_wrap"==t.id||"wk_layer_wrap"==t.id)return!0;t=t.parentNode}var a=curFastChat.tabs[curFastChat.activeBox.options.peer];return a&&(trim(Emoji.editableVal(a.txt))||a.imMedia&&a.imMedia.getMedias().length)?!0:void curFastChat.activeBox.hide()}},clistCache:function(e){if(e){var t,a,i,r,n,s,o,c,u,l=[e];if((a=parseLatin(e))&&l.push(a),(a=parseLatKeys(e))&&l.push(a),(a=parseCyr(e))&&l.push(a),void 0!==curFastChat.clistCache[e])return l;u=curFastChat.clistCache[e]={};for(i in l)if(t=l[i],n=curFastChat.clistCache[" "+t.charAt(0).toLowerCase()]){o=new RegExp("(^|\\s|\\()"+escapeRE(t),"gi");for(r in n)c=curFastChat.friends[r+"_"],isArray(c)&&null!==c[0].match(o)&&(u[r]=1)}r=0;for(i in u)r++;return u._num=r,l}var s,d,f;curFastChat.clistCache={};for(i in curFastChat.friends)for(s=curFastChat.friends[i][0],i=intval(i),d=0;f=" "+s.charAt(d).toLowerCase(),curFastChat.clistCache[f]||(curFastChat.clistCache[f]={}),curFastChat.clistCache[f][i]=1,d=s.indexOf(" ",d+1),-1!=d;)++d},clistShowMore:function(){if(curFastChat.clHasMore){var e=curFastChat.el.clist,t=e.scrollTop,a=e.clientHeight,i=e.scrollHeight;t+3*a>i&&FastChat.clistRender(!0)}},clistUpdateTitle:function(e){var t,a=0,i=0;for(t in curFastChat.friends)curFastChat.onlines[intval(t)]?(i++,a++):curFastChat.clOnlines||a++;var r=window.newVal=(i?getLang("mail_im_X_onlines_title",i):getLang("mail_im_onlines_title")).toString();FastChat.updateFriends(i),val(curFastChat.el.clistTitle,r),val(curFastChat.el.topLink,r.toLowerCase()),curFastChat.clistBoxScroll&&(!curFastChat.clHasMore&&e?a=curFastChat.el.clist.childNodes.length:curFastChat.q&&(a=intval((curFastChat.clistCache[curFastChat.q]||{})._num)),curFastChat.clistBoxScroll.options.contHeight=50*a)},clistToggleOnlines:function(e){void 0===e&&(e=!curFastChat.clOnlines,FastChat.stateChange({op:"onlines_toggled",val:e?1:0})),toggleClass(curFastChat.el.clistOnline,"fc_clist_online_active",e),curFastChat.clOnlines=e},clistFilterKey:function(e){var t;switch(e.keyCode){case KEY.DOWN:case KEY.UP:if("keyup"!=e.type){if(t=curFastChat.clSel&&ge("fc_contact"+curFastChat.clSel)){var a=e.keyCode==KEY.DOWN?"nextSibling":"previousSibling",i=t;do i=i[a];while(i&&(1!=i.nodeType||!hasClass(i,"fc_contact")))}else curFastChat.clSel||e.keyCode!=KEY.DOWN||(i=geByClass1("fc_contact",curFastChat.el.clist,"a"));if(i&&i!=t){FastChat.clistPeerOver(i,1);var r=curFastChat.el.clist;i.offsetTop+16>r.clientHeight+r.scrollTop?(r.scrollTop=i.offsetTop+16-r.clientHeight,curFastChat.clistBoxScroll.update()):i.offsetTop-36<r.scrollTop&&(r.scrollTop=i.offsetTop-36,curFastChat.clistBoxScroll.update())}}break;case KEY.LEFT:case KEY.RIGHT:return!0;case KEY.ENTER:if("keyup"==e.type||!(t=curFastChat.clSel&&ge("fc_contact"+curFastChat.clSel)))break;e.ctrlKey||e.metaKey&&browser.mac?nav.go(t.href.match(/\b(vkontakte\.ru|vk\.com)(\/[^\/]+?)$/)[2]):FastChat.selectPeer(curFastChat.clSel);
case KEY.ESC:if("keyup"!=e.type){var n=ge("fc_clist_filter"),s=val(n)||curFastChat.clSel;n.blur(),val(n,curFastChat.q=""),curFastChat.clSel=!1,s&&FastChat.clistRender()}break;default:return}return cancelEvent(e)},changePeerCounter:function(e,t,a){if(!Chat.tabs[e])return!1;var i=ge("chat_tab_icon_"+e),r=geByClass1("chat_tab_counter",i);r||(r=ce("div",{className:"chat_tab_counter"}),i.appendChild(r)),void 0===a?Chat.counters[e]=positive((Chat.counters[e]||0)+t):Chat.counters[e]=a,Chat.counters[e]?r.innerHTML=Chat.counters[e]:re(r)},prepareTabIcon:function(e,t,a){var i=curFastChat.friends&&curFastChat.friends[e+"_"];if(i){var r={name:i[0],photo:i[1],online:curFastChat.onlines[e]};FastChat.addTabIcon(e,r,a)}else{var n=3;curFastChat.needPeers[e]=[n,!1,setTimeout(FastChat.getPeers,irand(150,200)),t],FastChat.lcSend("needPeer",{id:e,mask:n})}},addTabIcon:function(e,t,a){if(Chat.itemsCont&&!Chat.tabs[e]){if(e>2e9)var i=t.data.members_grid_fc||"";else var i='<img class="chat_tab_img" src="'+t.photo+'"/>';if(e>2e9)var r="im?sel=c"+(e-2e9);else var r=t.alink||"/id"+e;var n=onlinePlatformClass(t.online),s=se('<a class="chat_tab_wrap'+(a?"":" chat_tab_beforeanim")+'" id="chat_tab_icon_'+e+'" href="'+r+'" onclick="FastChat.itemsOut();return FastChat.togglePeer('+e+', event);"><div class="chat_tab_imgcont _chat_tab_image'+n+'"><div class="chat_tab_close" onclick="return FastChat.closeTabIcon('+e+', event)"></div>'+i+'</div><div class="chat_tab_typing_wrap"><div class="chats_sp chat_tab_typing_icon"></div></div></a>');Chat.itemsCont.insertBefore(s,Chat.itemsCont.firstChild),Chat.tabs[e]={el:s,name:t.name},addClass(Chat.wrap,"chat_expand"),a||removeClass(s,"chat_tab_beforeanim"),FastChat.checkChatHeight(),Chat.scrollNode.scrollTop=0}},checkChatHeight:function(){function e(){addEvent(Chat.scrollNode,browserFeatures.wheelEvent,FastChat.scrollWrap)}function t(){removeEvent(Chat.scrollNode,browserFeatures.wheelEvent,FastChat.scrollWrap)}var a=getSize(Chat.itemsCont)[1];Chat.lastHeight=a,a>Chat.maxHeight?(Chat.fixH||(Chat.fixH=!0,addClass(Chat.scrollNode,"chat_fix_height"),setStyle(Chat.scrollNode,{height:Chat.maxHeight}),addEvent(Chat.scrollNode,"mouseenter",e),addEvent(Chat.scrollNode,"mouseleave",t),FastChat.checkShadow()),Chat.scrollNode.scrollTop=a-Chat.maxHeight):Chat.fixH&&(Chat.fixH=!1,removeClass(Chat.scrollNode,"chat_fix_height"),setStyle(Chat.scrollNode,{height:"auto"}),removeEvent(Chat.scrollNode,browserFeatures.wheelEvent,FastChat.scrollWrap),removeEvent(Chat.scrollNode,"mouseenter",e),removeEvent(Chat.scrollNode,"mouseleave",t),FastChat.checkShadow())},checkShadow:function(){var e=intval(Chat.scrollNode.scrollTop);e&&Chat.fixH?Chat.shadowTop||(addClass(Chat.wrap,"chat_scroll_top"),fadeIn(geByClass1("chat_cont_sh_top",Chat.wrap),200),Chat.shadowTop=!0):Chat.shadowTop&&(fadeOut(geByClass1("chat_cont_sh_top",Chat.wrap),200),Chat.shadowTop=!1),Chat.lastHeight-e>Chat.maxHeight&&Chat.fixH?Chat.shadowBottom||(fadeIn(geByClass1("chat_cont_sh_bottom",Chat.wrap),200),Chat.shadowBottom=!0):Chat.shadowBottom&&(fadeOut(geByClass1("chat_cont_sh_bottom",Chat.wrap),200),Chat.shadowBottom=!1)},scrollWrap:function(e){e||(e=window.event);var t=0;return e.wheelDeltaY||e.wheelDelta?t=(e.wheelDeltaY||e.wheelDelta)/2:e.detail&&(t=10*-e.detail),Chat.scrollNode.scrollTop-=t,curFastChat.activeBox==curFastChat.clistBox?(curFastChat.pointerMargin=0,FastChat.setPointer(!1,curFastChat.pointerMargin,curFastChat.prevPointer)):(curFastChat.pointerMargin=-Chat.scrollNode.scrollTop,FastChat.setPointer(!0,curFastChat.pointerMargin,curFastChat.prevPointer)),FastChat.checkShadow(),setStyle(Chat.ttNode,{top:-Chat.scrollNode.scrollTop}),cancelEvent(e)},togglePeer:function(e,t){return curFastChat.activeBox&&curFastChat.activeBox.options.peer==e?(curFastChat.activeBox.hide(),FastChat.setActive(!1),!1):FastChat.selectPeer(e,t)},selectPeer:function(e,t,a){if(checkEvent(t))return!0;var i=hasClass(Chat.wrap,"chat_active");if(curFastChat.tabs&&curFastChat.tabs[e]){var r=curFastChat.tabs[e].box;r.minimized&&r.unminimize(!0),FastChat.activateTab(e),FastChat.movePointer(e,i)}else a||(a={}),a.fixed=!0,a.onPeerAdded=function(){FastChat.movePointer(e,i)},a.onHistoryLoaded=FastChat.readLastMsgs.pbind(e),FastChat.addPeer(e,!1,!0,a);return curFastChat.tabs[e]&&curFastChat.tabs[e].iman&&curFastChat.tabs[e].iman.unidle(),!1},closeTabIcon:function(e,t,a){curFastChat.activeBox&&curFastChat.activeBox.options.peer==e&&!a&&(curFastChat.activeBox.hide(),FastChat.setActive(!1));var i=ge("chat_tab_icon_"+e);addClass(i,"chat_tab_hiding"),delete Chat.tabs[e],curFastChat.tabs[e]&&curFastChat.tabs[e].box.options.fixed&&(curFastChat.tabs[e].iman.stop(),delete curFastChat.tabs[e]);var r=function(){re(i),i&&(i=!1,curFastChat.activeBox&&FastChat.movePointer(curFastChat.activeBox.options.peer,!0));var e=Chat.scrollNode.scrollTop;FastChat.checkChatHeight(),Chat.scrollNode.scrollTop=e};animate(i,{height:0,opacity:0},{duration:100,onComplete:r}),a||FastChat.stateChange({op:"closed",peer:e});var n=Object.keys(Chat.tabs).length;return n||removeClass(Chat.wrap,"chat_expand"),FastChat.itemsOut(),cancelEvent(t)},getPointerShift:function(e,t,a){var i=a-t,r=Chat.maxHeight+32;return e&&62>i?i-62:e&&i>r?i-r:0},setPointer:function(e,t,a){if(!curFastChat.activeBox)return!1;var i=FastChat.getPointerShift(e,t,a),r=geByClass1("fc_tab_pointer",curFastChat.activeBox.wrap);return setStyle(r,{marginTop:t+i}),i},movePointer:function(e,t){if(!curFastChat.activeBox)return!1;var a=geByClass1("fc_pointer_offset",curFastChat.activeBox.wrap);if(e){var i=ge("chat_tab_icon_"+e);if(!i)return!1;if(!Chat.fixH&&i.nextSibling)var r=getXY(i.nextSibling)[1]-50;else if(i.nextSibling||Chat.fixH)var r=getXY(i)[1]+Chat.scrollNode.scrollTop;else var r=getXY(ge("chat_tab_wrap"))[1]-50;var n=23+getXY(Chat.cont)[1]-r,s=-Chat.scrollNode.scrollTop}else var n=28,s=0;var o=FastChat.setPointer(e,s,n);if(t){if(curFastChat.prevPointer){var c=FastChat.getPointerShift(!0,s+o,curFastChat.prevPointer);setStyle(a,{bottom:curFastChat.prevPointer-c+o})}animate(a,{bottom:n},{duration:100})}else setStyle(a,{bottom:n});curFastChat.prevPointer=n},setActive:function(e){curFastChat.activeBox=e,e&&FastChat.moveBoxesLeft(e.pos[1])},moveBoxesLeft:function(e,t){var e=e-8,a=!1,i=0;for(var r in curFastChat.tabs){var n=curFastChat.tabs[r];if(t||(n.box.movedLeft=!1),n&&!n.box.options.fixed&&n.box.toBottom&&!n.box.movedLeft&&!n.box.noMove){var s=n.box.pos;s[1]+s[3]>=e&&s[1]>i&&(a=n,i=s[1])}}if(a){var o=e-a.box.pos[3],c=a.box.pos[0];0>o&&(o=0),a.box.movedLeft=!0,animate(a.box.wrap,{left:o},200),a.box.pos=[c,o,a.box.pos[2],a.box.pos[3]];var u=getWndInner();FastChat.stateChange({op:"moved",peer:a.box.options.peer,y:c/u[0],x:o/u[1]}),o&&FastChat.moveBoxesLeft(o,!0)}else FastChat.moveLeftY=0},moveBoxAway:function(e,t){for(var a=t-e.pos[3]-20,i=e.pos[3],r=e.pos[0],n=!1;a>0&&!n;){n=!0;for(var s in curFastChat.tabs){var o=curFastChat.tabs[s].box.pos;o[0]+o[2]/2>r&&o[1]+o[3]>a&&o[1]<a+i&&(a-=o[3],n=!1)}}0>a&&(a=positive(Math.random()*t)),animate(e.wrap,{left:a},300);var c=getWndInner();FastChat.stateChange({op:"moved",peer:e.options.peer,y:r/c[0],x:a/c[1]})},pinTab:function(e,t,a){if(-1==e)var i=curFastChat.clistBox;else var i=curFastChat.tabs[e].box;i.options.fixed=!1,removeClass(i.wrap,"fc_fixed"),FastChat.hideChatCtrl(),FastChat.setActive(!1);var r=i.wrap.offsetTop,n=i.wrap.offsetLeft-10;setStyle(i.wrap,{left:i.wrap.offsetLeft,top:i.wrap.offsetTop,right:"auto",bottom:"auto"}),a||animate(i.wrap,{left:n,top:r},300),i.pos=[r,n,i.pos[2],i.pos[3]],i.toRight=!1,i.toBottom=!0,addClass(i.wrap,"fc_tobottom");var s=i.resizeableW.clientWidth-intval(getStyle(i.resizeableW,"paddingRight"))-intval(getStyle(i.resizeableW,"paddingLeft")),o=i.resizeableH.clientHeight-intval(getStyle(i.resizeableH,"paddingBottom"))-intval(getStyle(i.resizeableH,"paddingTop")),c=getWndInner();-1==e?FastChat.stateChange({op:"clist_toggled",val:1,y:i.toBottom?-1:i.pos[0]/c[0],x:i.toRight?-1:i.pos[1]/c[1]}):FastChat.stateChange({op:"unfixed",peer:e,y:i.toBottom?-1:i.pos[0]/c[0],x:i.toRight?-1:i.pos[1]/c[1],h:o/c[0],w:s/c[1]}),i.noMove=!0,FastChat.moveBoxesLeft(n),i.noMove=!1},addPeer:function(e,t,a,i){i||(i={});var r=curFastChat.friends&&curFastChat.friends[e+"_"],n=0;if(a?FastChat.stateChange({op:"added",peer:e,fixed:i.fixed}):curNotifier.idle_manager&&!curNotifier.idle_manager.is_idle&&t&&(a=!0),r){var s={name:r[0],photo:r[1],fname:r[2],hash:r[3],online:curFastChat.onlines[e],sex:r[4]};FastChat.addTabIcon(e,s,i.noAnim),FastChat.addBox(e,s,i),t?(curFastChat.tabs[e].auto=1,FastChat.imFeed(e,t)):(i&&i.nofocus||FastChat.activateTab(e),curFastChat.onlines[e]||FastChat.tabNotify(e,"unavail"),n|=2)}else n=3;n&&(a?(curFastChat.needPeers[e]=[n,t,!1,i],FastChat.getPeers()):(curFastChat.needPeers[e]=[n,t,setTimeout(FastChat.getPeers,irand(150,200)),i],FastChat.lcSend("needPeer",{id:e,mask:n})))},getPeers:function(){var e=[],t={};each(curFastChat.needPeers,function(a){e.push(a),e.push(this[0]),clearTimeout(this[2]),t[a]=this[0]}),e.length&&(FastChat.lcSend("fetchingPeers",t),ajax.post("al_im.php",{act:"a_get_fc_peers",peers:e.join(",")},{onDone:function(e){FastChat.gotPeers(e),FastChat.lcSend("gotPeers",e)}}))},gotPeers:function(e){i()||each(curFastChat.needPeers,function(t){if(e[t]){e[t]<2e9&&(curFastChat.friends[t+"_"]=[e[t].name,e[t].photo,e[t].fname,e[t].hash,intval(e[t].sex)]);var a=this[1],i=this[3];2&this[0]&&void 0===e[t].history||(clearTimeout(this[2]),delete curFastChat.needPeers[t]),curFastChat.tabs[t]?FastChat.gotHistory(t,e[t].history):i.fixedLoad?FastChat.addTabIcon(t,e[t]):(FastChat.addTabIcon(t,e[t]),FastChat.addBox(t,e[t],i),a?(curFastChat.tabs[t].auto=1,FastChat.imFeed(t,a)):(2&this[0]&&FastChat.gotHistory(t,e[t].history),i&&i.nofocus||FastChat.activateTab(t))),i.onHistoryLoaded&&i.onHistoryLoaded()}})},gotHistory:function(e,t){if(isArray(t)&&t.length&&t[0]){var a=curFastChat.tabs[e],i=t[0],r=t[1];a.offset=t[2],extend(a.msgs,r),each(r,function(e,t){!t[0]&&t[1]&&a.unread++}),val(a.log,i),a.logWrap.scrollTop=a.logWrap.scrollHeight,setTimeout(function(){a.logWrap.scrollTop=a.logWrap.scrollHeight,a.scroll&&a.scroll.update(!1,!0)},10)}},decHashCb:function(e){!function(e){curFastChat.decodedHashes[e]=function(e){for(var t=ge?"":"___",a=0;a<e.length;++a)t+=e.charAt(e.length-a-1);return geByClass?t:"___"}(e.substr(e.length-5)+e.substr(4,e.length-12))}(e)},decodehash:function(e){return curFastChat.decodedHashes||(curFastChat.decodedHashes={}),curFastChat.decodedHashes[e]||FastChat.decHashCb(e),curFastChat.decodedHashes[e]},onMyTyping:function(e){e=intval(e);var t=curFastChat.tabs[e];if(!(-2e9>=e)&&t){var a=vkNow();curFastChat.myTypingEvents[e]&&a-curFastChat.myTypingEvents[e]<5e3||(curFastChat.myTypingEvents[e]=a,ajax.post("al_im.php",{act:"a_typing",peer:e,hash:t.sendhash,from:"fc"}))}},updateTypings:function(){each(curFastChat.tabs||{},function(e,t){FastChat.updateTyping(e)})},updateTyping:function(e,t){var a,i=curFastChat.tabs[e],r=[],n=curFastChat.typingEvents[e],s=vkNow(),o=ge("fc_tab_typing"+e),c=geByClass1("_fc_tab_typing_progress",o),u=geByClass1("_fc_tab_typing_name",o);if(2e9>e)n&&6e3>s-n&&(r.push(i.fname||i.name||""),a=i.sex);else{var l=i.data.members;each(n||{},function(e,t){t&&6e3>s-t&&l[e]&&l[e].first_name&&(r.push(l[e].first_name||""),a=l[e].sex)})}if(!r.length)return hide(c),t?setStyle(o,"opacity",0):fadeTo(o,1e3,0);if(1==r.length)val(u,langSex(a,lang.mail_im_typing).replace("{user}",r[0]));else{var d=r.pop();val(u,getLang("mail_im_multi_typing").replace("{users}",r.join(", ")).replace("{last_user}",d))}return show(c),t?setStyle(o,"opacity",1):fadeTo(o,200,1)},readLastMsgs:function(e){var t=curFastChat.tabs[e];if(e&&t){if(!t.markingRead&&t.unread){var a=[];for(var i in t.msgs)!t.msgs[i][0]&&t.msgs[i][1]&&a.push(i);FastChat.markRead(e,a)}FastChat.changePeerCounter(e,0,0)}},markRead:function(e,t){if(t.length){var a=curFastChat.tabs[e];a.markingRead=!0,ajax.post("al_im.php",{act:"a_mark_read",peer:e,ids:t,hash:a.sendhash,from:"fc"},{onDone:function(i){a.markingRead=!1;for(var r in t){var n=t[r],s=ge("fc_msg"+n),o=s&&s.parentNode;s&&(a.msgs[n]&&a.msgs[n][1]&&(a.msgs[n][1]=0,a.msgs[n][0]||a.unread--),removeClass(s,"fc_msg_unread"),hasClass(o.parentNode,"fc_msgs_unread")&&each(o.childNodes,function(){return hasClass(this,"fc_msg_unread")?void 0:(removeClass(o.parentNode,"fc_msgs_unread"),!1)}))}a.unread>0&&(a.unread=0,each(a.msgs,function(){!this[0]&&this[1]&&a.unread++})),FastChat.updateUnreadTab(e)},onFail:function(){a.markingRead=!1}})}},mkMsg:function(e){var t=clean(e).replace(/\n/g,"<br>"),a=!1;return t=(0,s.replaceHyperLinks)(t||"",s.linksReplacer.bind(null,a)),t=(0,s.replaceMentions)(t),t=(0,s.replaceEmailLinks)(t),t=Emoji.emojiToHTML(t,1)},getEditCont:function(e){return stManager.add(["emoji.js"]),'<div class="emoji_cont _emoji_field_wrap">'+Emoji.tplSmile(getLang("mail_emoji_hint"))+'<div class="fc_editable dark" tabindex="0" contenteditable="true" placeholder="'+getLang("mail_chat_placeholder")+'"></div></div>'},getVal:function(e){return Emoji?Emoji.editableVal(e):""},onTxtResize:function(e){var t=curFastChat.tabs[e],a=geByClass1("fc_tab_txt",t.wrap),i=getSize(a)[1];if(i>40){var r=positive(i-40),n=intval(getSize(t.box.resizeableH)[1]);n+t.hDiff-r<40&&(r=n+t.hDiff-40),setStyle(t.box.resizeableH,{height:n+(t.hDiff||0)-r}),t.hDiff=r,FastChat.fixResized(t,t.wrap.clientWidth,!0)}else if(t.hDiff){var n=intval(getSize(t.box.resizeableH)[1]);setStyle(t.box.resizeableH,{height:n+t.hDiff}),t.hDiff=0,FastChat.fixResized(t,t.wrap.clientWidth,!0)}},initTab:function(e,t,a){var i=geByClass1("fc_editable",a),r=curFastChat.tabs[e]={name:t.name,fname:t.fname,photo:t.photo,link:t.alink||"/id"+e,hash:t.hash,sendhash:FastChat.decodehash(t.hash),sex:t.sex||0,data:t.data||{},online:t.online,msgs:{},msgscount:0,unread:0,sent:0,sentmsgs:[],box:!1,wrap:a,editable:1,txt:i,txtWrap:i.parentNode.parentNode,logWrap:geByClass1("fc_tab_log",a),log:geByClass1("fc_tab_log_msgs",a),notify:geByClass1("fc_tab_notify_wrap",a),title:geByClass1("fc_tab_title",a)},s=30;if(r.addMediaBtn=geByClass1("fc_tab_attach",a),r.editable)cur.t=r,r.emojiId=Emoji.init(r.txt,{controlsCont:geByClass1("fc_tab_txt_wrap",a),ttDiff:-46,ttShift:0,rPointer:!0,global:!0,noRce:!0,peer:e,isChat:!0,noCtrlSend:!0,onSend:FastChat.send.pbind(e),checkEditable:FastChat.checkEditable,onResize:function(){FastChat.onTxtResize(e)},addMediaBtn:r.addMediaBtn,onShow:function(){cssAnim(r.scroll.scrollbar,{opacity:0},{duration:400})},onHide:function(){cssAnim(r.scroll.scrollbar,{opacity:1},{duration:400})},onEsc:function(e){return r.box.hide(),cancelEvent(e)},onStickerSend:function(t,a){--r.sent,FastChat.send(e,t,a)}});else{var o=15;autosizeSetup(r.txt,{minHeight:o,maxHeight:42}),r.txt.autosize.options.onResize=function(e){if(!r.box.minimized){var t=42==e?42:o;t!=e&&setStyle(r.txt,"height",t),t!=s&&(setStyle(r.logWrap,"height",r.logWrap.clientHeight-t+s),s=t,r.scroll&&r.scroll.update(!1,!0))}}}return r.imPeerMedias={},r.imSortedMedias={},r.previewEl=geByClass1("fc_tab_preview",a),stManager.add(["page.js","page.css","ui_media_selector.js","ui_media_selector.css"],function(){r.imMedia=new MediaSelector(r.addMediaBtn,r.previewEl,[["photo",getLang("profile_wall_photo")],["video",getLang("profile_wall_video")],["audio",getLang("profile_wall_audio")],["doc",getLang("profile_wall_doc")],["map",getLang("profile_wall_map")]],{limit:10,hideAfterCount:0,maxShown:0,mail:1,tooltip:1,topOffset:0,forceUp:1,global:1,toId:vk.id}),r.imMedia.onChange=setTimeout.pbind(function(){if(curFastChat.sendOnUpload)FastChat.send(curFastChat.sendOnUpload),curFastChat.sendOnUpload=void 0;else{var t=(0,n.loadDraftForPeer)(curFastChat.ldb,e);t.removeAllAttaches(),r.imMedia.getMedias().forEach(function(e){return t.addAttach(e[0],e[1])}),t.destroy()}FastChat.onTxtResize(e)},0)}),r},addBox:function(e,t,a){if(void 0===curFastChat.tabs[e]){var i=FastChat.getEditCont(Emoji.last);a=a||{},curFastChat.tabs[e]={};var r=se(rs(FastChat.tplBox,{id:e,name:t.name,myphoto:Notifier.fixPhoto(curFastChat.me.photo,!0),cont:i}));a.fixed&&curFastChat.activeBox&&curFastChat.activeBox.hide(0,!1,{noState:!0});var n=FastChat.initTab(e,t,r),s=getWndInner(),o={id:"fc_peer"+e,marginFixedToLayer:!0,peer:e,movable:geByClass1("fc_tab_head",r),closer:geByClass1("fc_tab_close_wrap",r,"a"),resizeableH:n.logWrap,startHeight:250,startWidth:270,fixed:a.fixed,minH:150,minW:270,nofocus:!0,onFocus:function(t){n.auto&&(FastChat.stateChange({op:"added",peer:e}),delete n.auto),FastChat.restoreDraft(e),n.editable?Emoji.editableFocus(n.txt,!1,!0):elfocus(n.txt),n.wrap.clientWidth&&setStyle(n.title,{maxWidth:n.wrap.clientWidth-71}),n.editable||setStyle(n.txt.autosize.helper,{width:getStyle(n.txt,"width",!1)}),n.scroll&&n.scroll.update(!1,!0),setTimeout(elfocus.pbind(n.txt),10)},onHide:function(){a.fixed&&FastChat.hideChatCtrl(),curFastChat.activeBox&&e==curFastChat.activeBox.options.peer&&FastChat.setActive(!1)},onClose:function(t){AudioMessagePlayer.loaded&&AudioMessagePlayer.detachPlayer(),this.onHide(),a&&a.beforeClose&&a.beforeClose();var i=curFastChat.tabs,r=i[e].posSeq;if(delete i[e],curNotifier.isIdle||FastChat.stateChange({op:"hidden",peer:e}),r){var n,s,o,c,u,l={},d=[];for(each(i,function(){this.posSeq>r&&(l[this.posSeq]=this,d.push(this.posSeq))}),d.unshift(r),d.sort(),u=!browser.msie&&d.length<10,n=1;n<d.length;n++)s=d[n],o=l[s].box,c=n>1?l[d[n-1]].box.pos:t,u?animate(o.wrap,{left:c[1]},100,function(e){e._update_pos()}.pbind(o)):setStyle(o.wrap,{left:c[1]});if(!u)for(n=1;n<d.length;n++)o=l[d[n]].box,o._update_pos()}},onMinimize:function(t){FastChat.stateChange({op:"minimized",peer:e,val:t}),FastChat.fixResized(n,n.wrap.clientWidth,!0),t||(n.txt.blur(),FastChat.restoreDraft(e))},onResizeEnd:function(t,a){var i=getWndInner(),r=n.box.pos;n.scroll&&n.scroll.show(),FastChat.fixResized(n,a,!0),FastChat.stateChange({op:"resized",peer:e,h:t/i[0],w:a/i[1],y:n.box.toBottom?-1:r[0]/i[0],x:n.box.toRight?-1:r[1]/i[1]})},onResize:function(e,t){FastChat.fixResized(n,t);var a=geByClass1("fc_tab_title",n.box.content);setStyle(a,{width:t-78})},onResizeStart:function(){delete n.posSeq,n.scroll&&n.scroll.hide(),val(n.notify,""),clearTimeout(n.hideNotifyTO)},onDragEnd:function(t,a){delete n.posSeq,FastChat.stateChange({op:"moved",peer:e,y:t,x:a})}};if(a&&extend(o,a),void 0===o.startLeft&&void 0===o.startRight){var c=[],u=s[0]-350,l=curFastChat.clistBox.pos,d=!1;if(window.Call&&(Call.box||Call.invitation)){var f=Call.calcBoxPos();c.push([f.x,f.x+f.w]),d=!0}l[0]+l[2]>u&&(curFastChat.clistBox.visible||!d)&&c.push([l[1],l[1]+l[3]]),each(curFastChat.tabs,function(t){(l=this.box&&this.box.pos)&&t!=e&&l[0]+l[2]>u&&c.push([l[1],l[1]+l[3]])});var h,p,_,m=lastWindowWidth-262-sbWidth(),g=0,v=!1,b=!1,C=g>m?1:-1;for(h=m;C*g>C*h;h+=135*C){for(p=0,_=0;_<c.length;_++)h>c[_][0]-260&&h<c[_][1]&&p++,h>c[_][0]-10&&h<c[_][0]+10&&(p+=1.1);(v===!1||b>p)&&(v=h,b=p)}d&&b&&(v=m),extend(o,{startBottom:0,startLeft:v})}var y,w=!0;for(y in a||{})if("nofocus"!=y){w=!1;break}w&&(n.posSeq=++curFastChat.posSeq),o.fixed&&(o.startHeight=curFastChat.clistH,o.startWidth=curFastChat.clistW,o.onShow=FastChat.showChatCtrl),n.box=new RBox(r,o),n.iman=new IdleManager({id:"tab"+e,element:n.box.content,onUnIdleCb:function(){FastChat.readLastMsgs(e)},parentManager:curNotifier.idle_manager,idleTimeout:1e4}),curFastChat.tabs[e].iman.start(),o.fixed&&FastChat.setActive(n.box),n.scroll=new Scrollbar(n.logWrap,{prefix:"fc_",nomargin:!0,nokeys:!0,global:!0,right:vk.rtl?"auto":1,left:vk.rtl?1:"auto",onScroll:FastChat.onScroll.pbind(n)}),o.minimized||!a||void 0===a.startLeft&&void 0===a.startTop&&void 0===a.startWidth&&void 0===a.startHeight||n.box._wnd_resize(s[0],s[1],!0),n.wrap.clientWidth&&setStyle(n.title,{maxWidth:n.wrap.clientWidth-71}),addEvent(n.txt,"keydown focus mousedown keyup",function(t){if("mousedown"==t.type)return void(curRBox.active==n.box.id&&((t.originalEvent||t).cancelBubble=!0));if("keydown"==t.type&&t.ctrlKey&&t.keyCode==KEY.RETURN){var a=this.value;if("number"==typeof this.selectionStart&&"number"==typeof this.selectionEnd){var i=this.selectionStart;this.value=a.slice(0,i)+"\n"+a.slice(this.selectionEnd),this.selectionStart=this.selectionEnd=i+1}else if(document.selection&&document.selection.createRange){this.focus(t);var r=document.selection.createRange();r.text="\r\n",r.collapse(!1),browser.opera&&(r.moveEnd("character",0),r.moveStart("character",0)),r.select()}return n.editable?FastChat.checkEditable(n.emojiId,n.txt):(n.txt.autosize.update(),setTimeout(function(){n.txt.autosize.update()},0)),!1}if("focus"==t.type)curFastChat.peer=e;else if("keyup"==t.type){var s=n.lastVal||"",o=FastChat.getVal(this);(o.length!=s.length||o!=s)&&(o&&FastChat.onMyTyping(e),n.lastVal=o),clearTimeout(n.saveDraftTO),n.saveDraftTO=setTimeout(FastChat.saveDraft.pbind(e),o.length?300:0),FastChat.checkEditable(n.emojiId,n.txt)}}),FastChat.restoreDraft(e),o.onPeerAdded&&o.onPeerAdded()}},onScroll:function(e){var t=e.scroll.obj.scrollTop,a=geByClass1("_fc_msgs_more",e.logWrap);200>t&&isVisible(a)&&a.click()},loadMore:function(e,t){var a=curFastChat.tabs[e],i=a.offset;return a.moreLoading?!1:(a.moreLoading=!0,void ajax.post("al_im.php",{act:"a_history",peer:e,offset:i,from:"fc"},{onDone:function(e){e[3]||hide(t);var i=t.parentNode,r=i.clientHeight;i.insertBefore(cf(e[0]),t.nextSibling);var n=i.clientHeight-r;n&&(a.logWrap.scrollTop+=n),a.scroll.update(),a.offset=e[2],a.moreLoading=!1,FastChat.onScroll(a)},onFail:function(){a.moreLoading=!1},showProgress:lockButton.pbind(t),hideProgress:unlockButton.pbind(t)}))},sendOnResponse:function(e,t,a){if(e.version&&intval(e.version)>curFastChat.version)return void FastChat.updateVersion(e.version);var i=ge("fc_msg"+t),r=e.msg_id,n=indexOf(t,a.newmsgs);if(i){if(e.media){var s={sticker:intval(e.sticker)};FastChat.lcSend("gotMedia",{msgId:t,peer:a.box.options.peer,text:e.media,msgOpts:s}),FastChat.gotMsgMedia(a.box.options.peer,t,e.media,s)}++a.msgscount,-1!=n&&a.newmsgs.splice(n,1),i.id="fc_msg"+r,a.msgs[r]=[1,1]}},checkEditable:function(e,t){Emoji.checkEditable(e,t,{height:52})},fixResized:function(e,t,a){e&&(e.logWrap.scrollTop=e.logWrap.scrollHeight,t>0&&setStyle(e.title,{maxWidth:t-71}),a&&(e.editable||setStyle(e.txt.autosize.helper,{width:getStyle(e.txt,"width",!1)}),e.scroll&&e.scroll.update(!1,!0)))},activateTab:function(e){var t=curFastChat.tabs[e].box;curFastChat.activeBox&&curFastChat.activeBox!=t&&curFastChat.activeBox.hide(0,!1,{noState:!0}),t.show(),t.options.fixed&&FastChat.setActive(t)},updateUnreadTab:function(e){var t=curFastChat.tabs[e];t&&(val(t.title,t.name+(t.unread?' <span class="fc_tab_count">('+t.unread+")</span>":"")),val("fc_contact_unread"+e,t.unread?" <b>+"+t.unread+"</b>":""),FastChat.changePeerCounter(e,!1,t.unread))},blinkTab:function(e){var t=curFastChat.tabs[e];if(!t.blinking&&curFastChat.peer!=e){t.blinking=!0,clearTimeout(t.blinkingTO);var a=t.box.wrap,i=a.className,r=Math.min(o,intval(getStyle(a,"zIndex")));setStyle(a,{zIndex:o}),removeClass(a,"rb_inactive"),t.blinkingTO=setTimeout(function(){delete t.blinking,delete t.blinkingTO,getStyle(a,"zIndex")==o&&(setStyle(a,{zIndex:r}),a.className=i)},2e3)}},createProgress:function(e,t,a){var i=ce("span",{innerHTML:rs(vk.pr_tpl,{id:"",cls:""}),className:"fc_msg_progress",id:"fc_msg_progress"+t});return e.insertBefore(i,a),i},removeProgress:function(e){re("fc_msg_progress"+e)},send:function(e,t,a){var i=curFastChat.tabs[e],r=trim(i.editable?Emoji.editableVal(i.txt):val(i.txt));if(t){var n=[["sticker",t]];r=""}else var n=i.imMedia?i.imMedia.getMedias():[];var s=ge("fc_tab_typing"+e),o=geByClass1("page_progress_preview",i.wrap);if(o&&o.childNodes.length>0){curFastChat.sendOnUpload=e;var c=geByClass("fc_tab_log",i.wrap)[0];return FastChat.createProgress(c,e,c.lastChild),void(s.style.visibility="hidden")}if(curFastChat.sendOnUpload=!1,FastChat.removeProgress(e),s.style.visibility="visible",!r&&!n.length)return void(i.editable?Emoji.editableFocus(i.txt,!1,!0):elfocus(i.txt));var u=--i.sent,l={act:"a_send",to:e,hash:i.sendhash,msg:r,from:"fc",media:[]};a&&(l.sticker_referrer=a);for(var d,f=0,h=n.length;h>f;++f)(d=n[f])&&l.media.push(d[0]+":"+d[1]);l.media=l.media.join(","),i.sending=!0,Emoji.ttHide(i.emojiId),ajax.post("al_im.php",l,{onDone:function(t){clearTimeout(i.saveDraftTO),FastChat.saveDraft(e),FastChat.sendOnResponse(t,u,i)},onFail:function(t){FastChat.error(e,t||getLang("global_unknown_error")),elfocus(i.txt),val(i.txt,r),i.editable?FastChat.checkEditable(i.emojiId,i.txt):i.txt.autosize.update();var a=ge("fc_msg"+u);return a?(a.appendChild(ce("span",{className:"fc_msg_error",innerHTML:getLang("global_error")})),FastChat.scroll(e),!0):void 0},showProgress:function(){i.sending=!0,i.sendProgressTO=setTimeout(function(){var e=ge("fc_msg"+u);e&&FastChat.createProgress(e,u,e.firstChild)},2e3)},hideProgress:function(){i.sending=!1,clearTimeout(i.sendProgressTO),FastChat.removeProgress(u)}}),re("fc_error"+e),i.sentmsgs.push(u),t||(val(i.txt,""),i.imMedia&&i.imMedia.unchooseMedia());var p=l.media?1:0;t&&(p+=8),FastChat.addMsg(FastChat.prepareMsgData([e,u,3,FastChat.mkMsg(r),p])),delete curFastChat.myTypingEvents[e],i.editable?FastChat.checkEditable(i.emojiId,i.txt):i.txt.autosize.update(!1,!0),elfocus(i.txt),FastChat.scroll(e)},saveDraft:function(e){var t=curFastChat.tabs[e],a=(t||{}).txt;if(a&&t){var i=Emoji.editableVal(a),r=(0,n.loadDraftForPeer)(curFastChat.ldb,e);r.setText(trim(i)||""),r.destroy()}},restoreDraft:function(e){var t=curFastChat.tabs[e],a=t.txt,i=(0,n.loadDraftForPeer)(curFastChat.ldb,e);return!a||!t||val(a).length>i.dData.txt.length&&!i.hasAttaches()?!1:(t.editable?a.innerHTML=Emoji.emojiToHTML(i.dData.txt,1):val(a,i.dData.txt),setTimeout(function(){for(var e=i.dData.attaches,a=0;a<e.length;a++)t.imMedia&&t.imMedia.chooseMedia(e[a].type,e[a].id,e[a].object||{});i.destroy()},40),FastChat.checkEditable(t.emojiId,a),setTimeout(function(){a.scrollTop=a.scrollHeight},10),!0)},error:function(e,t){e=e||curFastChat.peer;var a=curFastChat.tabs[e];re("fc_error"+e),a.log.appendChild(ce("div",{id:"fc_error"+e,className:"fc_msgs_error",innerHTML:t||getLang("global_error")})),FastChat.scroll(e)},scroll:function(e){e=e||curFastChat.peer;var t=curFastChat.tabs[e];t&&(t.logWrap.scrollTop=t.logWrap.scrollHeight,t.scroll&&t.scroll.update(!1,!0))},mkdate:function(e){var t=new Date(1e3*e),a=new Date,i=function(e){return(e+"").length<2?"0"+e:e};if(t.getDay()==a.getDay())return i(t.getHours())+":"+i(t.getMinutes());var r=i(t.getDate())+"."+i(t.getMonth()+1);return t.getFullYear()!=a.getFullYear()&&(r+="."+(t.getFullYear()+"").substr(2)),r},prepareMsgData:function(e){var t,a=e[0],i=intval(e[2]),r=2&i?curFastChat.me.id:a>2e9?e[5]:a,n=intval(vkNow()/1e3),s=e[4],o="",c={id:e[1],peer:a,from_id:r,text:e[3],out:2&i?!0:!1,unread:1&i?!0:!1,date:n,date_str:FastChat.mkdate(n)};return s&&(1&s&&(o+=rs(vk.pr_tpl,{id:"",cls:""}),e[1]>0&&setTimeout(FastChat.needMsgMedia.pbind(a,e[1]),5)),6&s&&(o+=rs(curFastChat.tpl.msg_fwd,{msg_id:e[1],peer_nice:FastChat.nicePeer(a),label:getLang(2&s?"mail_im_fwd_msg":"mail_im_fwd_msgs")})),8&s&&(c.sticker=!0),o&&(c.text+='<div class="fc_msg_attachments" id="fc_msg_attachments'+c.id+'">'+o+"</div>")),t=2&i?curFastChat.me:a>2e9?curFastChat.tabs[a].data.members[r]:curFastChat.tabs[a],extend(c,{from_id:r,link:t.link,photo:t.photo,name:t.name,fname:a>2e9?t.fname||t.first_name:""}),c},needMsgMedia:function(e,t){0>=t||(FastChat.lcSend("needMedia",{msgId:t}),curFastChat.needMedia[t]=[e,setTimeout(FastChat.loadMsgMedia.pbind(e,t),curNotifier.is_server?0:irand(150,250))])},loadMsgMedia:function(e,t){0>=t||void 0!==curFastChat.gotMedia[t]&&0!==curFastChat.gotMedia[t]||(FastChat.lcSend("fetchingMedia",{msgId:t}),curFastChat.gotMedia[t]=0,ajax.post("al_im.php",{act:"a_get_media",id:t,from:"fc"},{onDone:function(a,i,r){FastChat.lcSend("gotMedia",{msgId:t,peer:e,text:a,msgOpts:r}),FastChat.gotMsgMedia(e,t,a,r)}}))},gotMsgMedia:function(e,t,a,i){if(val("fc_msg_attachments"+t,a),i&&i.sticker){var r=ge("fc_msg"+t),n=r&&r.parentNode;r&&addClass(n.parentNode,"fc_msg_sticker")}FastChat.scroll(e),curFastChat.gotMedia[t]=[e,a,i],i.stickers&&window.Emoji&&Emoji.updateTabs(i.stickers,i.keywords),void 0!==curFastChat.needMedia[t]&&(clearTimeout(curFastChat.needMedia[t][1]),delete curFastChat.needMedia[t])},replaceSpecialSymbols:function(e){return e.replace(/&lt;&lt;/g,"&laquo;").replace(/&gt;&gt;/g,"&raquo;").replace(/ \-\-/g," &mdash;").replace(/\-\- /g,"&mdash; ").replace(/(^|[\s.,:\'\";>\)\(])(\*|@)([A-Za-z0-9_\.]{2,32})\s*\((.+?)\)/g,"$1$4")},addMsg:function(e){var t=e.peer,a=curFastChat.tabs[t],i=a.log,r=i.lastChild;if(r&&"fc_msgs_error"==r.className&&(r=r.previousSibling),!a||e.out||!a.box.visible||a.iman.is_idle||curNotifier.idle_manager.is_idle||(e.unread=!1,FastChat.markRead(e.peer,[e.id])),!r||!hasClass(r,"fc_msgs_wrap")||!hasClass(r,"fc_msgs_unread")&&e.unread===!0||r.getAttribute("data-from")!=e.from_id||e.date-intval(r.getAttribute("data-date"))>=300||e.sticker||hasClass(r,"fc_msg_sticker")){re("fc_log_empty"+t);var n=(e.out?"fc_msgs_out ":"")+(e.unread?"fc_msgs_unread":"");e.sticker&&(n+=" fc_msg_sticker");var s=e.out?curFastChat.tpl.msgs_out:curFastChat.tpl.msgs;r=se(rs(s,{from_id:e.from_id,link:e.link,photo:Notifier.fixPhoto(e.photo),name:e.from_id==curFastChat.me.id?getLang("mail_im_thats_u"):stripHTML(e.name),classname:n,date:e.date,date_str:e.date_str,msgs:""})),i.appendChild(r)}else e.unread||removeClass(r,"fc_msgs_unread");var o=geByClass1("fc_msgs",r,"div"),c=geByClass1("fc_msgs_date",o),u=geByClass1("fc_msg_last",o);u&&removeClass(u,"fc_msg_last");var l=se(rs(curFastChat.tpl.msg,{msg_id:e.id,classname:(e.unread?"fc_msg_unread":"")+" fc_msg_last",text:FastChat.replaceSpecialSymbols(e.text)}));domFC(o)&&"BR"==domFC(o).tagName&&re(domFC(o)),c?o.insertBefore(l,c):o.appendChild(l),vk.id!=e.from_id&&(delete curFastChat.typingEvents[t],FastChat.updateTyping(t,1)),a.scroll&&a.scroll.update()},sebastianovMsg:function(e){var t=(e.peer,e.id),a=ge("fc_msg"+t);if(a){var i=se(rs(curFastChat.tpl.msg,{msg_id:t,classname:a.getAttribute("class"),text:FastChat.replaceSpecialSymbols(e.text)}));a.parentNode.replaceChild(i,a)}},showMsgFwd:function(e){return!showBox("al_im.php",{act:"a_show_forward_box",id:vk.id+"_"+e,from:"mail"},{stat:["im.css"],dark:1,params:{onHide:function(){AudioMessagePlayer.loaded&&AudioMessagePlayer.detachPlayer(!0)}}})},closeTab:function(e){var t=curFastChat.tabs[e].box;t.close()},openSnapsterLayer:function(e){return checkEvent(e)?void 0:(showBox("/snapster.php",{act:"show"},{containerClass:"chronicle_layer",dark:1}),cancelEvent(e))},nicePeer:function(e){return e>2e9?"c"+intval(e-2e9):-2e9>e?"e"+intval(-e-2e9):e},tplBox:'<div class="fc_tab_wrap"><div class="fc_tab_head clear_fix"><a class="fc_tab_close_wrap"><div class="chats_sp fc_tab_close"></div></a><a class="fc_tab_max_wrap" href="/im?sel=%id%" onmousedown="event.cancelBubble = true;" onclick="return nav.go(this, event);"><div class="chats_sp fc_tab_max"></div></a><a class="fc_tab_pin_wrap" onmousedown="event.cancelBubble = true;" onclick="return FastChat.pinTab(%id%, event);"><div class="chats_sp fc_tab_pin"></div></a><div class="fc_tab_title noselect">%name%</div></div><div class="fc_tab"><div class="fc_tab_log_wrap"><div class="fc_tab_notify_wrap"></div><div class="fc_tab_log"><div class="fc_tab_log_msgs"></div><div class="fc_tab_typing" id="fc_tab_typing%id%"><div class="pr fc_tab_typing_icon _fc_tab_typing_progress" id=""><div class="pr_bt"></div><div class="pr_bt"></div><div class="pr_bt"></div></div><div class="fc_tab_typing_name _fc_tab_typing_name"></div></div></div></div><div class="fc_tab_txt_wrap"><a class="fc_tab_attach"></a><div class="fc_tab_txt">%cont%<div class="fc_tab_preview"></div></div></div></div><div class="fc_pointer_offset"><div class="fc_tab_pointer fc_tab_pointer_peer"></div></div></div>',tplTab:'<div class="fc_tab_log_wrap"><div class="fc_tab_notify_wrap"></div><div class="fc_tab_log"><div class="fc_tab_log_msgs"></div><div class="fc_tab_typing" id="fc_tab_typing%id%"><div class="pr fc_tab_typing_icon _fc_tab_typing_progress" id=""><div class="pr_bt"></div><div class="pr_bt"></div><div class="pr_bt"></div></div><div class="fc_tab_typing_name _fc_tab_typing_name"></div></div></div></div><div class="fc_tab_txt_wrap"><div class="fc_tab_txt">%cont%</div></div>'
}},function(e,t,a){var i=a(68),r=a(95);e.exports=function(e){return function(t,a){var n,s,o=String(r(t)),c=i(a),u=o.length;return 0>c||c>=u?e?"":void 0:(n=o.charCodeAt(c),55296>n||n>56319||c+1===u||(s=o.charCodeAt(c+1))<56320||s>57343?e?o.charAt(c):n:e?o.slice(c,c+2):(n-55296<<10)+(s-56320)+65536)}}},function(e,t,a){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t["default"]=e,t}function r(e){return e.get?e.get():e}function n(e,t){var a=r(e),i=a.tabs[a.peer];return Object.keys(i.msgs).filter(function(a){var r=v(e,t,a);return!(0,j.isOut)(r)&&intval(a)>i.in_up_to})[0]}function s(e){var t=r(e);return t.peer}function o(e,t){var a=r(e);return a.tabs[t]}function c(e){var t=r(e);return t.peer?t.tabs[t.peer]:null}function u(e){var t=r(e);return t.selectedMessages}function l(e,t,a){var i=o(e,t),r=u(e)[0];if("undefined"==typeof r)return[a];var n=Math.min(a,r),s=Math.max(a,r);return Object.keys(i.msgs).filter(function(e){return e>=n&&s>=e}).filter(function(t){return!(0,W.isServiceMsg)(v(e,e.get().peer,t))}).map(intval)}function d(e,t){var a=r(t),i=o(a,e),n=0;for(var s in i.msgs){var c=v(t,e,s);(0,j.isOut)(c)||(n+=(0,j.isUnread)(i,c)?1:0)}return n}function f(e,t,a){var i=o(e,t);return Object.keys(i.msgs).filter(function(i){return intval(v(e,t,i).randomId)===a}).length>0}function h(e,t,a){var i=f(e,t,a);return!!i}function p(e,t){var a=r(e),i=a.msg_local_ids_sort&&a.msg_local_ids_sort[t];return"undefined"!=typeof i?2e9+i:t}function _(e,t,a){var i=o(e,t),r=v(e,t,a),n=Object.keys(i.msgs).filter(function(a){var i=v(e,t,a);return!r.local&&i.local?!1:r.local&&!i.local?!0:p(e,r.messageId)>p(e,i.messageId)}),s=n.pop();return s?v(e,t,s):null}function m(e){return e&&e.length>0?z.addMessageEvent([0].concat(e)):e}function g(e,t,a){var i=o(e,t),n=v(e,t,a),s=r(e);return(0,j.isOut)(n)?(0,G.oCacheGet)(e,s.id).name:n.userId!==n.peerId?(0,G.oCacheExists)(e,n.userId)?(0,G.oCacheGet)(e,n.userId).name:!1:i.tab}function v(e,t,a){var i=o(e,t),r=i&&i.msgs&&i.msgs[a];return r?m(r):null}function b(e){var t=r(e);return t.gid||t.isClassic}function C(e){return r(e).gid}function y(e){return r(e).gid}function w(e){return r(e).gid}function N(e,t){var a=r(t);return a.tabs[e]||a.mapped_index[e]}function T(e){var t=r(e);return w(e)?19542789!==t.gid&&103416369!=t.gid?!1:t.active_tab===U.FOLDER_UNRESPOND||t.active_tab===U.FOLDER_UNREAD?!0:!1:!1}function F(e,t){e=r(e);var a=e.tabs[t]&&"undefined"!=typeof e.tabs[t].history;return e.tabs[t]&&e.tabs[t].msgs&&a?!0:!1}function k(e){var t=e.get().go_to_end_visible;return t?t[0]:!1}function E(e){var t=e.get().go_to_end_visible;return t?t[1]:0}function S(e){var t=r(e);return!t.lockedSending}function x(e){return e>-2e9&&0>e}function L(e,t){return x(t)?!!o(e,t).blocked_community:!1}function I(e){var t=r(e);return t.voice_message_available}function O(e){var t=r(e);return!(!M(t)&&!t.recentSearch)}function M(e){var t=r(e);return t.searchText}function R(e,t){var a=r(e);return t&&t!==M(e)||a.recentSearch?!0:!1}function P(e){var t=r(e);return t.recentSearch}function A(e){var t=c(e);return t&&t.pinned&&m(t.pinned)}function B(e){var t=e.get().popular_sugg;return t&&t.length>0}function D(e){return 1==r(e).isSebastianoving}function H(e){return e.draft||(e.draft=(0,V.loadDraftForPeer)(cur.imDb,e.peerId)),e.draft}Object.defineProperty(t,"__esModule",{value:!0}),t.unpackStore=r,t.getFirstUnread=n,t.getPeer=s,t.getTab=o,t.getCurrentTab=c,t.getSelectedMessages=u,t.getMessageRangeFromSelection=l,t.countUnread=d,t.getMessageByRid=f,t.isRidExist=h,t.getLocalId=p,t.getLastMessage=_,t.parserMessage=m,t.getAuthorFullName=g,t.getMessage=v,t.isClassicInterface=b,t.isLocksAvailable=C,t.isFoldersAvailable=y,t.isCommunityInterface=w,t.getBareTab=N,t.isReversedDialogs=T,t.isFullyLoadedTab=F,t.isGoToEndVisible=k,t.getUnreadScrollBottom=E,t.isSendingAvailable=S,t.isCommunityPeer=x,t.isCommunityBlocked=L,t.checkVoiceMessageAvailable=I,t.isSearching=O,t.getSearchText=M,t.isSearchingValue=R,t.isRecentSearchesActive=P,t.getPinnedMessage=A,t.doPopularSuggExist=B,t.isAnyMessageBeingSebastianoved=D,t.getTabDraft=H;var j=a(102),q=a(74),z=i(q),U=a(94),W=a(56),G=a(97),V=a(87)},function(e,t,a){a(55),a(26),a(105),a(41),e.exports=a(124).Map},,function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},,function(e,t,a){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function r(e){var t=l.get(e.currentTarget);if(t){var a=t[e.type];if(a)for(var i,r=0;r<a.length;r++){var n,s=o(a[r],2),c=s[0],u=s[1];if(hasClass(e.target,c)?n=u(e,e.target):(i=gpeByClass(c,e.target,e.currentTarget))&&(n=u(e,i)),n===!1)break}}}function n(e,t,a,i){var n=l.get(e);n||(l.set(e,{}),n=l.get(e));for(var s=t.split(" "),o=0;o<s.length;o++){var c=s[o];n[c]||(n[c]=[],addEvent(e,c,r)),n[c].push([a,i])}}function s(e,t,a,i){var n=l.get(e);if(n){var s=(t.split(" ").forEach(function(t){n[t]&&(n[t]=n[t].filter(function(e){return e[0]!==a||e[1]!==i}),0===n[t].length&&removeEvent(e,t,r))}),Object.keys(n).map(function(e){return n[e].length}).reduce(function(e,t){return e+t}));0===s&&l["delete"](e)}}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){var a=[],i=!0,r=!1,n=void 0;try{for(var s,o=e[Symbol.iterator]();!(i=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);i=!0);}catch(c){r=!0,n=c}finally{try{!i&&o["return"]&&o["return"]()}finally{if(r)throw n}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.addDelegateEvent=n,t.removeDelegateEvent=s;var c=a(15),u=i(c),l=new u["default"]},function(module,exports,__webpack_require__){"use strict";var _im_shared_helpers=__webpack_require__(81),ACTIVE_TAB_SWITCH_SERVER_TIMEOUT=browser.safari?3e3:1e4,LC_SERVER_SWITCH_TO_ACTIVE_FLAG="lc_server_switch_to_active_flag";window.curNotifier||(window.curNotifier={addQueues:{},recvClbks:{},recvData:{},onConnectionId:[]}),window.Notifier={debug:!1,init:function(e){if(!window.curNotifier||!curNotifier.connection_id){if(Notifier.notificationsGc(),curNotifier=extend({q_events:[],q_shown:[],q_closed:[],negotiations:{},currentIm:{},q_max:3,uiNotifications:[],q_idle_max:5,browser_shown:{},done_events:{},addQueues:curNotifier.addQueues||{},recvClbks:curNotifier.recvClbks||{},recvData:curNotifier.recvData||{},error_timeout:1,request_timeout:1e3,sound:new Sound("mp3/bb1"),sound_im:new Sound("mp3/bb2"),sound_im_current:new Sound("mp3/bb3"),onConnectionId:[]},e),!this.initFrameTransport())return!1;this.initIdleMan(),this.initCommunityQueues(),(curNotifier.cont=ge("notifiers_wrap"))||bodyNode.insertBefore(curNotifier.cont=ce("div",{id:"notifiers_wrap",className:"fixed"}),ge("page_wrap"))}},initCommunityQueues:function(e){var t=ls.get("im_m_comms_key"),a=t&&t.split?t.split(";"):[];return"empty"===a[0]&&a[1]&&Date.now()-a[1]<6e4?t="empty":"empty"===a[0]&&(t=!1),t?Notifier.proccessCommunityQueues(t,e||0):void ajax.post("al_im.php",{act:"a_get_comms_key"},{onDone:function(t){"empty"===t?t+=";"+Date.now():Notifier.proccessCommunityQueues(t,e||0),ls.set("im_m_comms_key",t)},onFail:function(){return!0}})},notificationsGc:function(){curNotifier.uiGcTo=setTimeout(function(){for(var e=curNotifier.uiNotifications,t=[],a=0;a<e.length;a++){var i=e[a];vkNow()-i[1]>1e4?i[0].close():t.push(i)}curNotifier.uiNotifications=t,Notifier.notificationsGc()},5e3)},resetCommConnection:function(e){var t=ls.get("im_m_comms_key");t&&delete curNotifier.addQueues[t.queue],ls.set("im_m_comms_key",!1),Notifier.initCommunityQueues(e||0)},proccessCommunityQueues:function(e,t){return"empty"!==e&&e?void Notifier.addKey(e,function(e,a){if(a.failed)return t++,void(50>t&&setTimeout(Notifier.resetCommConnection.pbind(t),100));var e=ls.get("im_m_comms_key");e&&(e.ts=a.ts,ls.set("im_m_comms_key",e));var i=a.events;i&&i.map(function(e){return e.split("<!>")}).forEach(function(e){if("update_cnt"===e[1]){var t=e[5],a=e[4];handlePageCount("mgid"+t,a)}})}):!1},destroy:function(){Notifier.hideAllEvents(),curNotifier.idle_manager.stop(),curNotifier.uiGcTo&&clearTimeout(curNotifier.uiGcTo),curNotifier={},re("notifiers_wrap"),re("queue_transport_wrap")},reinit:function(){ajax.post("notifier.php?act=a_get_params",{},{onDone:function(e){e?(curNotifier.error_timeout=1,this.init(e)):(curNotifier.error_timeout=curNotifier.error_timeout||1,setTimeout(this.reinit.bind(this),1e3*curNotifier.error_timeout),curNotifier.error_timeout<256&&(curNotifier.error_timeout*=2))}.bind(this),onFail:function(){return curNotifier.error_timeout=curNotifier.error_timeout||1,setTimeout(this.reinit.bind(this),1e3*curNotifier.error_timeout),curNotifier.error_timeout<256&&(curNotifier.error_timeout*=2),!0}.bind(this)})},standby:function(e){this.destroy(),curNotifier.error_timeout=e||1,setTimeout(this.reinit.bind(this),1e3*curNotifier.error_timeout)},freezeEvents:function(){curNotifier.frozen=!0,each(curNotifier.q_shown,function(){clearTimeout(this.fadeTO),getStyle(this.baloonEl,"opacity")<1&&animate(this.baloonEl,{opacity:1},100)})},unfreezeEvents:function(){curNotifier.frozen=!1,each(curNotifier.q_shown,function(){this.fadeTO=setTimeout(this.startFading,hasAccessibilityMode()?3e4:5e3)})},getTransportWrap:function(){return ge("queue_transport_wrap")||utilsNode.appendChild(ce("div",{id:"queue_transport_wrap"}))},setFocus:function(e){var t=(e?"1":"0")+curNotifier.instance_id;"flash"==curNotifier.transport&&curNotifier.flash_transport?curNotifier.flash_transport.setInstanceFocused(t):"frame"==curNotifier.transport&&(Notifier.lcSend("focus",{instance_id:t}),this.onInstanceFocus(t))},initIdleMan:function(){curNotifier.idle_manager&&curNotifier.idle_manager.started||(curNotifier.idle_manager=new IdleManager({onIdleCb:function(){Notifier.freezeEvents(),Notifier.setFocus(0),cur.onIdle&&each(cur.onIdle,function(e,t){t()})},onUnIdleCb:function(){Notifier.unfreezeEvents(),Notifier.setFocus(1),cur.onUnidle&&each(cur.onUnidle,function(e,t){t()}),FastChat&&FastChat.onUnidle(),vk.spentLastSendTS=vkNow()},id:"window",element:document,focusElement:window}),curNotifier.idle_manager.start())},initFrameTransport:function(){if(!ls.checkVersion()||browser.msie8||!("onmessage"in window||"postMessage"in window))return!1;curNotifier.connection_id="queue_connection_"+curNotifier.queue_id,curNotifier.lc_prev_value="",curNotifier.is_server=!1,curNotifier.lp_connected=!1,curNotifier.error_timeout=1;var e=browser.version.split("."),t=intval(e[0]),a=intval(e[1]);curNotifier.post_message=Notifier.debug||!(browser.opera&&intval(browser.version)<15||browser.msie||browser.mozilla&&t>=31||browser.safari&&(t>7||7==t&&a>=1)),curNotifier.transport="frame",this.lcInit();for(var i in curNotifier.onConnectionId)curNotifier.onConnectionId[i]();return curNotifier.onConnectionId=[],!0},onActivated:function(){curNotifier.idle_manager&&!curNotifier.idle_manager.is_activated?curNotifier.idle_manager.activate():curNotifier.idle_manager&&curNotifier.idle_manager.is_idle||Notifier.setFocus(1),removeEvent(document,"mousemove keydown touchstart",Notifier.onActivated)},onConnectionInit:function(){addEvent(document,"mousemove keydown touchstart",Notifier.onActivated)},onConnectionFailed:function(){},onRelogin:function(){setTimeout(function(){Notifier.standby()},0)},onMessage:function onMessage(msg){if(!curNotifier.focus_instance||curNotifier.focus_instance==curNotifier.instance_id)try{var events=eval("("+msg+")");Notifier.pushEvents(events)}catch(e){debugLog(e.message)}},onInstanceFocus:function(e){var t=e.charAt(0);return e=e.substr(1),"1"!=t?void(curNotifier.focus_instance==e&&(curNotifier.focus_instance="")):(curNotifier.focus_instance=e,void(e!=curNotifier.instance_id&&(curNotifier.idle_manager.is_idle||curNotifier.idle_manager.idle(),Notifier.hideAllEvents())))},onInstanceServer:function(e){curNotifier.is_server=!!intval(e)},pushEvents:function(e,t){var a=0;each(e,function(e,i){a|=Notifier.pushEvent(i,t)}),a&&!ls.get("sound_notify_off")&&curNotifier.is_server&&(2&a?curNotifier.sound_im.play():curNotifier.sound.play())},pushEvent:function pushEvent(msg,cnt){if("nop"!=msg){if(msg=msg.split("<!>"),msg[0]!=curNotifier.version)return debugLog("Notifier old version"),!1;if("update_cnt"==msg[1])return"nws"===msg[3]?(handlePageCount("ntf",msg[9]),0):(handlePageCount(msg[3],msg[4],msg[5],msg[6]),0);var ev={type:msg[1],title:msg[2],author_photo:psr(msg[3]||""),author_link:msg[4]||"",text:psr(msg[5]),add_photo:psr(msg[6])||"",link:msg[7],onclick:msg[8],add:msg[9],id:msg[10],author_id:msg[11],top_count:msg[12]},push=cnt?0:1;if(msg[13]&&(ev.custom=eval("("+msg[13]+")")),!curNotifier.done_events[ev.id]){switch(curNotifier.done_events[ev.id]=1,void 0!==ev.top_count&&-1!=ev.top_count&&handlePageCount("ntf",ev.top_count),ev.type){case"video_process_ready":if(ev.add&&window.Video&&Video.isVideoPlayerOpen(ev.add))return;break;case"mail":handlePageCount("msg",ev.add),window.Call&&Call.params.call_id&&intval(ev.author_id)==intval(Call.params.far_uid)&&Call.showChat(),"im"!=cur.module&&FastChat.prepareTabIcon(intval(ev.author_id),{fixedLoad:1});break;case"mail_failed":var peer=intval(ev.author_id);if("im"==nav.objLoc[0]&&cur.tabs[peer]){var msg=ge("mess"+ev.add);if(msg&&hasClass(msg,"im_new_msg")){removeClass(msg,"im_new_msg"),addClass(msg,"im_failed");var n=geByClass1("im_log_author_chat_name",msg);n&&(n.innerHTML+=" &nbsp;<span>"+cur.lang.mail_send_failed+"</span>"),push=2}}break;case"friend_request":handlePageCount("fr",ev.add);break;case"ach_achieved":handlePageCount("ach",ev.add),ev.author_photo=ev.custom[0];break;case"ach_achieved_upd":handlePageCount("ach",ev.add),push=0;break;case"bt_upd":case"bt_upd_upd":handlePageCount("bt",ev.add,ev.custom[0],ev.custom[1]),"bt_upd_upd"==ev.type&&(push=0);var bt=ge("bt_tab_updates");bt&&val(geByClass1("ui_tab_count",bt),ev.add>0?ev.add:"");break;case"push_settings":push=0;var muted=JSON.parse(ev.add);curNotifier.mutedPeers=curNotifier.mutedPeers.filter(function(e){return e!==muted.peer_id}),0!==muted.disabled_until&&curNotifier.mutedPeers.push(muted.peer_id);break;case"mail_cnt":handlePageCount("msg",ev.add),push=0;break;case"clear_notify":Notifier.hideAllEvents(),push=0;break;case"support_reply":handlePageCount("spr",ev.add,"support",ev.author_id?"act=show&id="+ev.author_id:"act=show"),toggle("l_spr",ev.add>0);break;case"support_cnt":handlePageCount("spr",ev.add,"support",ev.author_id?"act=show&id="+ev.author_id:"act=show"),toggle("l_spr",ev.add>0),push=0;break;case"balance_changed":updateMoney(ev.add),ev.custom&&"app"==ev.custom[0]&&cur.app&&cur.app.params.api_id==ev.custom[1]&&cur.app.balanceUpdated(ev.custom[2]);break;case"gift_sent":re("left_block10_0");var left_block=ev.add;if(left_block){var leftBlocksElem=ge("left_blocks"),left_unpaid_gifts=se(left_block);leftBlocksElem&&(leftBlocksElem.firstChild?leftBlocksElem.insertBefore(left_unpaid_gifts,leftBlocksElem.firstChild):leftBlocksElem.appendChild(left_unpaid_gifts))}break;case"call_start":window.Call?Call.incomingReceive(ev):stManager.add(["call.js","call.css","notifier.css"],function(){Call.incomingReceive(ev)}),push=0;break;case"call":window.Call?Call.processNotify(ev):debugLog("wnd Call event without call obj"),push=0;break;case"call_app":var callId=ev.custom.call_id,onScriptCame=function onScriptCame(script){clearTimeout(curNotifier.appCallTimeout),script=script&&script[0]==callId?script[1]:!1,script&&-1!=script&&stManager.add(["call.js","call.css","apps.js","apps.css"],function(){eval(script)})};curNotifier.appCallTimeout=setTimeout(function(){var e=curNotifier.recvData.apps_call_receive;e=e&&e[0]==callId?e[1]:!1,e||(ajax.post("/al_apps.php",{act:"call_receive"},{onDone:function(e){debugLog("script came"),e=[callId,e],Notifier.lcSend("apps_call_receive",e),onScriptCame(e)},stat:["call.js","call.css","apps.js","apps.css"]}),Notifier.lcSend("apps_call_receive",[callId,-1]))},0),Notifier.setRecvClbk("apps_call_receive",onScriptCame),push=0;break;case"call_app_reject":"app"==cur.module&&cur.aid==ev.custom.aid&&cur.app.runCallback("onCallReject",ev.custom.key),push=0;break;case"call_app_accept":"app"==cur.module&&cur.aid==ev.custom.aid&&cur.app.runCallback("onCallAccept",ev.custom.key),push=0;break;case"notify_tt":case"login_attempt":ev.add&&(ev.add=eval("("+ev.add+")"),TopNotifier.showTooltip(ev.add.text,ev.add.key)),push=0;break;case"reload_stickers":window.Emoji&&window.Emoji.stickers&&(Emoji.stickers=!1),push=0}return"mail"===ev.type&&(push=this.sendMailNotification(ev)),1&push&&(curNotifier.q_events.push(ev),curNotifier.q_events.length>30&&curNotifier.q_events.splice(0,curNotifier.q_events.length-30),this.checkEvents()),push}}},isActive:function(){return window.curNotifier&&curNotifier.idle_manager&&!curNotifier.idle_manager.is_idle},sendImProxy:function(e){e.text=winToUtf(e.text),curNotifier.browser_shown[e.id]||(curNotifier.browser_shown[e.id]=!0,Notifier.trySendBrowserNotification(e,!0),setTimeout(function(){curNotifier.browser_shown[e.id]=void 0},2e3))},shouldShowNotification:function(e){return"im"!==cur.module&&!FastChat.isChatOpen(e.author_id)},sendSimpleNotification:function(e){return Notifier.playSound(e),Notifier.shouldShowNotification(e)?3:0},sendBrowserNotification:function(e){"im"!==cur.module?Notifier.negotiate({message:"send_im_notification",onSuccess:function(t){Notifier.lcSend("negotiate_back",{token:t.msg,ev:e})},onFail:function(){Notifier.showBrowserNotification(e)}}):(e.onclick="IM.activateTab("+e.author_id+");",Notifier.showBrowserNotification(e))},shouldPlaySound:function(e){return!ls.get("sound_notify_off")&&Notifier.shouldDisturb(e)},shouldDisturb:function(e){return cur.focused!=e.author_id&&!inArray(e.author_id,cur.mutedPeers)&&!inArray(e.author_id,curNotifier.mutedPeers)},shouldPlayCurrentSound:function(e){return!ls.get("sound_notify_off")&&cur.focused==e.author_id&&hasAccessibilityMode()&&!inArray(e.author_id,cur.mutedPeers)},playSound:function(e){curNotifier.sound_im&&curNotifier.sound_im.play&&Notifier.shouldPlaySound(e)?e.author_id==cur.peer&&hasAccessibilityMode()?curNotifier.sound_im_current.play():curNotifier.sound_im.play():Notifier.shouldPlayCurrentSound(e)&&curNotifier.sound_im_current&&curNotifier.sound_im_current.play()},trySendBrowserNotification:function(e,t){Notifier.negotiate({message:"who_is_active",msg:e.author_id,onFail:function(){!Notifier.canNotifyUi()||cur.peer==e.author_id&&Notifier.isActive()?t?Notifier.playSound(e):(Notifier.lcSend("show_notification",e),Notifier.shouldShowNotification(e)&&Notifier.showEvent(e,!0),Notifier.playSound(e)):Notifier.sendBrowserNotification(e)}})},showBrowserNotification:function(e){Notifier.showEventUi(e),Notifier.playSound(e)},proxyIm:function(e){return this.isActive()?(this.playSound(e),void(Notifier.canNotifyUi()&&cur.peer!=e.author_id&&Notifier.shouldDisturb(e)&&Notifier.showEventUi(e))):void(curNotifier.is_server?(e.onclick="IM.activateTab("+e.author_id+");",this.sendImProxy(e)):curNotifier.is_server||this.lcSend("message_from_im",e))},sendMailNotification:function(e){if("im"==cur.module?e.onclick="IM.activateTab('"+e.author_id+"');":e.onclick="FastChat.selectPeer('"+e.author_id+"');",this.isActive()&&Notifier.canNotifyUi())this.playSound(e),this.shouldDisturb(e)&&cur.peer!=e.author_id&&this.showEventUi(e);else{if(this.isActive()&&this.shouldDisturb(e))return this.sendSimpleNotification(e);curNotifier.is_server&&this.shouldDisturb(e)&&this.trySendBrowserNotification(e)}return 0},checkEvents:function(){if(!(!curNotifier.q_events.length||curNotifier.q_shown.length>=(curNotifier.idle_manager.is_idle?curNotifier.q_idle_max:curNotifier.q_max)||!curNotifier.idle_manager.is_idle&&curNotifier.frozen)){var e=curNotifier.q_events.shift();this.showEvent(e)}},showEvent:function showEvent(ev,force){ev.custom&&ev.custom.ttl&&(0,_im_shared_helpers.confirmDelivery)(ev.custom.id),curNotifier.q_shown.push(ev);var thumbEl="";thumbEl="video_process_ready"==ev.type?'<div class="notifier_video_thumb" style="background-image: url('+Notifier.fixPhoto(ev.author_photo)+')"></div>':'<img src="'+Notifier.fixPhoto(ev.author_photo)+'" class="notifier_image" />';var typeClassName="notifier_type_"+ev.type;ev.baloonWrapEl=ce("div",{className:"notifier_baloon_wrap",innerHTML:'<div class="notifier_baloon '+typeClassName+'"><div class="notifier_baloon_head clear_fix"><a class="notifier_close_wrap" role="link" title="'+getLang("global_close")+'" aria-label="'+getLang("global_close")+'"></a><h4 class="notifier_baloon_title">'+ev.title+'</h4></div><div class="notifier_baloon_body clear_fix">'+(ev.author_photo&&'<div class="notifier_image_wrap">'+(ev.author_link&&'<a href="'+ev.author_link+'">')+thumbEl+(ev.author_link&&"</a>")+"</div>")+(ev.add_photo&&'<div class="notifier_add_image_wrap"><img src="'+ev.add_photo+'" class="notifier_add_image" /></div>')+'<div class="notifier_baloon_msg wrapped">'+ev.text+"</div></div></div>"}),ev.baloonEl=ev.baloonWrapEl.firstChild,ev.closeEl=geByClass1("notifier_close_wrap",ev.baloonEl),addEvent(ev.baloonEl,"mouseover mouseout",function(e){ev.over="mouseover"==e.type,ev.over?Notifier.freezeEvents():Notifier.unfreezeEvents()}),addEvent(ev.baloonEl,"mousedown click",function(e){e=e.originalEvent||e||window.event;var btn=e.which,nohide=!1;if(1==btn&&(e.ctrlKey||browser.mac&&e.metaKey)&&(btn=2,browser.mac&&(nohide=!0)),"A"!=(e.target||e.srcElement).tagName){switch(btn){case 1:eval(ev.onclick),Notifier.hideEvent(ev);break;case 2:var wnd=window.open(ev.link,"_blank");try{wnd.blur(),window.focus()}catch(e){}nohide||Notifier.hideEvent(ev);break;case 3:if(browser.mozilla)return}return cancelEvent(e)}switch(btn){case 1:break;case 3:}}),addEvent(ev.baloonEl,"contextmenu",function(e){return setTimeout(function(){Notifier.hideEvent(ev,!1,!1,!0)},10),cancelEvent(e)}),addEvent(ev.closeEl,"mousedown click",function(e){return Notifier.hideEvent(ev,!1,!1,!0),cancelEvent(e)}),ev.startFading=function(){ev.fading=animate(ev.baloonEl,{opacity:0},1e3,Notifier.hideEvent.bind(Notifier).pbind(ev,!1)),ev.over&&ev.fading.stop()},curNotifier.cont.insertBefore(ev.baloonWrapEl,curNotifier.cont.firstChild);var h=ev.baloonWrapEl.offsetHeight;re(ev.baloonWrapEl),curNotifier.cont.appendChild(ev.baloonWrapEl),setStyle(curNotifier.cont,{bottom:-h}),setStyle(ev.baloonWrapEl,{visibility:"visible"}),animate(curNotifier.cont,{bottom:0},200),(!curNotifier.idle_manager.is_idle||force)&&(ev.fadeTO=setTimeout(ev.startFading,hasAccessibilityMode()?35e3:7e3))},canNotifyUi:function(){return!ls.get("im_ui_notify_off")&&DesktopNotifications.supported()&&DesktopNotifications.checkPermission()<=0},showEventUi:function showEventUi(ev){if(!this.canNotifyUi())return!1;var title,text;if(ev.custom&&ev.custom.ttl&&(0,_im_shared_helpers.confirmDelivery)(ev.custom.id),"mail"===ev.type){var div=ce("div");div.innerHTML=ev.text,title=div.firstChild.textContent.trim(),text=stripHTML(replaceEntities(ev.text.replace(/<br\/?>/g,"\n")).replace(/<span class='notifier_author_quote'.*<\/span>(.*?)/,"$1").replace(/<img.*?alt="(.*?)".*?>/gi,"$1")).replace(/&laquo;|&raquo;/gi,'"').trim()}else title=ev.title,text=ev.text;var notification=ev.uiNotification=DesktopNotifications.createNotification(ev.author_photo,title,text);return curNotifier.uiNotifications.push([notification,vkNow()]),notification.onclick=function(e){window.focus(),"IM"===ev.onclick.substr(0,2)&&"im"!==cur.module?FastChat.selectPeer(intval(ev.author_id)):eval(ev.onclick),Notifier.hideEvent(ev)},notification.onclose=function(){Notifier.hideEvent(ev,!0)},notification.show(),ev.closeTO=setTimeout(Notifier.hideEvent.bind(Notifier).pbind(ev),5e3),!0},hideEvent:function(e,t,a,i){clearTimeout(e.closeTO),clearTimeout(e.fadeTO),e.fading&&e.fading.stop();var r,n=indexOf(curNotifier.q_shown,e);-1!=n&&curNotifier.q_shown.splice(n,1),Notifier.unfreezeEvents(),t||(e.baloonWrapEl?(cleanElems(e.closeEl,e.baloonEl),re(e.baloonWrapEl)):e.uiNotification&&e.uiNotification.cancel()),i===!0&&isArray(curNotifier.q_closed)&&(curNotifier.q_closed.unshift(vkNow()),(r=curNotifier.q_closed.length)>3&&(curNotifier.q_closed.splice(3,r-3),r=3),3==r&&curNotifier.q_closed[0]-curNotifier.q_closed[2]<700&&Notifier.hideAllEvents()),-1!=i&&this.checkEvents(),"frame"!=curNotifier.transport||a||this.lcSend("hide",{event_id:e.id}),i!==!0&&curNotifier.idle_manager.is_idle||curNotifier.q_events.length||curNotifier.q_shown.length||ajax.post("notifier.php",{act:"a_clear_notifier"})},hideAllEvents:function(){curNotifier.q_events=[],each(clone(curNotifier.q_shown),function(){Notifier.hideEvent(this,!1,!0,-1)}),curNotifier.q_shown=[],curNotifier.q_closed=[]},onEventHide:function(e){e&&(each(curNotifier.q_shown,function(){return this.id==e?(Notifier.hideEvent(this,!1,!0),!1):void 0}),each(curNotifier.q_events,function(t){return this.id==e?(curNotifier.q_events.splice(t,1),!1):void 0}))},lcInit:function(){if(curNotifier.post_message){addEvent(window,"message",this.lcOnMessage.bind(this));var e=curNotifier.storage_el=ce("iframe",{id:"queue_storage_frame",name:"queue_storage_frame",src:"/notifier.php?act=storage_frame&from="+location.host+(Notifier.debug?"&debug="+vkNow():"&4")+"#"+curNotifier.connection_id});Notifier.getTransportWrap().appendChild(e),curNotifier.storage_frame=e.contentWindow,curNotifier.storage_frame_origin=location.protocol+"//"+locHost}else browser.msie&&intval(browser.version)<9?addEvent(document,"storage",this.lcOnStorage.bind(this)):addEvent(window,"storage",this.lcOnStorage.bind(this)),this.lcStart()},lcStart:function(){Notifier.lcCheckServer()?this.lcServer():(this.lcSend("check"),clearTimeout(curNotifier.becomeServerTO),curNotifier.becomeServerTO=setTimeout(this.lcServer.bind(this).pbind(!0),500)),curNotifier.checkServerInt=setInterval(function(){curNotifier.is_server||(!curNotifier.idle_manager.is_idle&&curNotifier.idle_manager.getActiveTime()>ACTIVE_TAB_SWITCH_SERVER_TIMEOUT&&(Notifier.debug&&debugLog("this tab wants to become server"),ls.set(LC_SERVER_SWITCH_TO_ACTIVE_FLAG,!0),this.lcServer(!0)),vkNow()-curNotifier.last_succ>8e3&&Notifier.lcCheckServer()&&(Notifier.debug&&debugLog("timeout"),this.lcServer(!0)))}.bind(this),1e3+intval(rand(-100,100))),curNotifier.isServerBroadcastInt=setInterval(function(){curNotifier.is_server&&(Notifier.lcCheckServer()?this.lcSend("check_ok"):(Notifier.debug&&debugLog("no server from server broadcast"),this.lcNoServer()))}.bind(this),5e3+intval(rand(-100,100))),void 0!==curNotifier.fc&&stManager.add(["emoji.js"],function(){FastChat.init(curNotifier.fc)})},lcStop:function(){clearInterval(curNotifier.isServerBroadcastInt),clearInterval(curNotifier.checkServerInt),clearTimeout(curNotifier.becomeServerTO)},lcSend:function(e,t){if(!curNotifier.connection_id)return curNotifier.onConnectionId.push(Notifier.lcSend.pbind(e,t)),!1;Notifier.debug&&debugLog(curNotifier.instance_id+": sending",e,t||"");var a=extend({__client:curNotifier.instance_id,__act:e,__rnd:Math.random()},t||{});if(curNotifier.post_message)try{curNotifier.storage_frame.postMessage(curNotifier.connection_id+":"+JSON.stringify(a),curNotifier.storage_frame_origin)}catch(i){debugLog(i,i.message,i.stack)}else ls.set(curNotifier.connection_id,a)},lcRecv:function(e){if(!isEmpty(e)&&e.__client!=curNotifier.instance_id){var t=e.__act;switch(delete e.__client,delete e.__act,delete e.__rnd,Notifier.debug&&debugLog(curNotifier.instance_id+": recv",t,e),t){case"new_server":curNotifier.last_succ=vkNow()+1e3;break;case"feed":curNotifier.timestamp=e.ts,curNotifier.key=e.key,Notifier.pushEvents(e.events,!e.full);break;case"addfeed":Notifier.addFeed(e[0],e[1]);break;case"new_key":debugLog("new key",e),curNotifier.timestamp=e.ts,curNotifier.key=e.key;break;case"new_addkey":var a=e.queue||e.key,i=curNotifier.addQueues[a],r=!i&&curNotifier.is_server;i?i[0]=vkNow():curNotifier.addQueues[a]=[vkNow(),e.ts,e.key],r&&Notifier.lpReset(Notifier.lpCheck.bind(Notifier));break;case"clear_addkeys":curNotifier.addQueues={};break;case"check_ok":curNotifier.last_succ=vkNow(),curNotifier.becomeServerTO&&(clearTimeout(curNotifier.becomeServerTO),curNotifier.becomeServerTO=!1),curNotifier.lp_connected||(curNotifier.lp_connected=!0,Notifier.onConnectionInit());break;case"focus":Notifier.onInstanceFocus(e.instance_id);break;case"hide":Notifier.onEventHide(e.event_id);break;case"check_playlist":var n=ls.get("pad_playlist");n&&n.instance==curNotifier.instance_id&&ls.set("pad_pltime",vkNow());break;case"who_is_active":Notifier.isActive()&&(intval(e.msg)>2e9&&"im"===cur.module||intval(e.msg)<2e9)&&this.lcSend("negotiate_back",e);break;case"show_notification":Notifier.shouldShowNotification(e)&&Notifier.showEvent(e,!0);break;case"send_im_notification":if("im"===cur.module){var s=Notifier.createNegotiationSlot({onSuccess:function(e){e.ev.onclick="IM.activateTab("+e.ev.author_id+");",Notifier.showBrowserNotification(e.ev)}});Notifier.lcSend("negotiate_back",{msg:s.token,token:e.token})}break;case"negotiate_back":Notifier.endNegotiation(e);break;case"recent_emoji_set":window.Emoji&&Emoji.setRecentEmojiList(e);break;default:if(curNotifier.recvClbks&&curNotifier.recvClbks[t])for(var o in curNotifier.recvClbks[t])curNotifier.recvClbks[t][o](e);else curNotifier.recvData[t]=e}if(curNotifier.is_server)switch(t){case"new_server":case"new_key":case"check_ok":Notifier.debug&&debugLog("no server from lcRecv",t),Notifier.lcNoServer();break;case"check":this.lcSend("check_ok");break;case"message_from_im":Notifier.sendImProxy(e)}}},negotiate:function(e){e=this.createNegotiationSlot(e),this.lcSend(e.message,{token:e.token,msg:e.msg})},createNegotiationSlot:function(e){var t="negotiations_"+Date.now()+Math.round(rand(0,1e4));return e=extend({timeout:3e3,token:t,msg:""},e),curNotifier.negotiations[e.token]={},curNotifier.negotiations[e.token].timer=setTimeout(function(){e.onFail&&e.onFail(),curNotifier.negotiations[e.token]&&(curNotifier.negotiations[e.token]=void 0)},e.timeout),curNotifier.negotiations[e.token].success=e.onSuccess,e},endNegotiation:function(e){var t=e.token,a=curNotifier.negotiations[t];a&&(clearTimeout(a.timer),curNotifier.negotiations[t].success&&curNotifier.negotiations[t].success(e),curNotifier.negotiations[t]=void 0)},lcOnStorage:function(e){e=e||window.event,Notifier.debug&&debugLog("onstorage",e.key,e.newValue,e);var t=e.key,a=e.newValue;if(a){if(t){if(e.key!=curNotifier.connection_id)return}else{if(t=curNotifier.connection_id,a=localStorage.getItem(t),a==curNotifier.lc_prev_value)return;curNotifier.lc_prev_value=a}this.lcRecv(JSON.parse(a)||{})}},lcOnMessage:function(e){if(e=e||window.event,Notifier.debug&&debugLog("onmessage",e.data,e.origin,e),!(e.origin&&e.origin!=curNotifier.storage_frame_origin||"string"!=typeof e.data||e.data.indexOf("q_st"))){var t,a=e.data.substr(4);if("ready"==a)curNotifier.storage_frame=e.source,this.lcStart();else{if(-1==(t=a.indexOf(":"))||a.substr(0,t)!=curNotifier.connection_id||!a.substr(t+1))return;this.lcRecv(JSON.parse(a.substr(t+1)))}}},lcServer:function(e){Notifier.debug&&debugLog("becoming server"),this.lpInit(),this.lcSend("new_server"),Notifier.lcCheckServer(!0),curNotifier.is_server=!0,Notifier.onInstanceServer(1),curNotifier.lp_connected||(curNotifier.lp_connected=!0,Notifier.onConnectionInit()),window.curFastChat&&curFastChat.inited&&FastChat.becameServer(),this.lpStop(),e?this.lpReset(this.lpStart.bind(this)):this.lpStart()},lcNoServer:function(){this.lpStop(),curNotifier.is_server&&(Notifier.debug&&debugLog("not server now"),this.onInstanceServer(0),curNotifier.is_server=!1)},lcCheckServer:function(e){var t,a="server_"+curNotifier.connection_id,i=vkNow();return!e&&isArray(t=ls.get(a))&&t[0]!=curNotifier.instance_id&&i-t[1]<8e3?!1:(ls.set(a,[curNotifier.instance_id,i]),!0)},lpInit:function(){curNotifier.lpMakeRequest||(delete curNotifier.lpMakeRequest,re("queue_transport_frame"),Notifier.getTransportWrap().appendChild(ce("iframe",{id:"queue_transport_frame",name:"queue_transport_frame",src:curNotifier.frame_path})))},lpStart:function(){curNotifier.lp_started=!0,
curNotifier.lpInvalid?Notifier.lpGetKey():Notifier.lpCheck()},lpStop:function(){curNotifier.lp_started=!1,clearTimeout(curNotifier.lp_check_to),clearTimeout(curNotifier.lp_error_to),clearTimeout(curNotifier.lp_req_check_to)},lpCheck:function lpCheck(){if(curNotifier.lp_started&&!curNotifier.lpActive&&!curNotifier.lpInvalid){if(!curNotifier.lpMakeRequest)return clearTimeout(curNotifier.lp_check_to),void(curNotifier.lp_check_to=setTimeout(this.lpCheck.bind(this),1e3));if(!Notifier.lcCheckServer())return Notifier.debug&&debugLog("no server from check"),void this.lcNoServer();var now=vkNow(),add_queues=[],completed=!1,params={act:"a_check",ts:curNotifier.timestamp,key:curNotifier.key,id:curNotifier.uid,wait:25};each(curNotifier.addQueues,function(e,t){return now-t[0]>3e4&&!e.match(/nccts/)?(debugLog("drop key",e,now-t[0]),void delete curNotifier.addQueues[e]):(add_queues.push(e),params.ts+="_"+t[1],void(params.key+=t[2]))});var onFail=function(e){completed||(completed=!0,curNotifier.lpActive=!1,clearTimeout(curNotifier.lp_req_check_to),curNotifier.error_timeout=curNotifier.error_timeout||1,clearTimeout(curNotifier.lp_error_to),curNotifier.lp_error_to=setTimeout(this.lpCheck.bind(this),1e3*curNotifier.error_timeout+irand(1e3,1e4)),curNotifier.error_timeout<64&&(curNotifier.error_timeout*=2))}.bind(this);curNotifier.lpActive=!0,clearTimeout(curNotifier.lp_req_check_to),curNotifier.lp_req_check_to=setTimeout(onFail,1e3*(params.wait+5)),curNotifier.lpMakeRequest(curNotifier.frame_url,params,function(text){if(!completed&&(completed=!0,curNotifier.lpActive=!1,curNotifier.lp_started)){this.lcSend("check_ok");try{var response=eval("("+text+")"),main_response=response,add_response,add_queue,busy=0;if(isArray(response))for(main_response=response.shift();(add_response=response.shift())&&(add_queue=add_queues.shift());)2!=add_response.failed||4!=add_response.err?(this.lcSend("addfeed",[add_queue,add_response]),this.addFeed(add_queue,add_response),add_response.failed&&delete curNotifier.addQueues[add_queue]):(Notifier.debug&&debugLog("!!notifier key busy!! "+curNotifier.instance_id),busy|=1);else if(response.failed){for(;add_queue=add_queues.shift();)this.lcSend("addfeed",[add_queue,response]),this.addFeed(add_queue,response),delete curNotifier.addQueues[add_queue];this.lcSend("clear_addkeys")}switch(this.lpChecked(main_response)){case 0:break;case 1:return;case 2:busy|=2;break;default:return}busy?ls.get(LC_SERVER_SWITCH_TO_ACTIVE_FLAG)?ls.remove(LC_SERVER_SWITCH_TO_ACTIVE_FLAG):this.lcNoServer():(clearTimeout(curNotifier.lpCheckTO),curNotifier.lpCheckTO=setTimeout(this.lpCheck.bind(this),curNotifier.request_timeout||1e3),curNotifier.error_timeout=Math.max(1,(curNotifier.error_timeout||1)/1.5))}catch(e){text&&-1==text.indexOf("Ad Muncher")&&(topError("Notifier error: "+e.message,{dt:-1,type:5,stack:e.stack,answer:text+"\n\nbusy:"+busy+"\nserver:"+curNotifier.is_server+"\ninstance:"+curNotifier.instance_id,url:curNotifier.frame_url,query:params&&ajx2q(params)}),debugLog(e.message,e.stack,e)),curNotifier.error_timeout=curNotifier.error_timeout||1,clearTimeout(curNotifier.lp_error_to),curNotifier.lp_error_to=setTimeout(this.lpCheck.bind(this),1e3*curNotifier.error_timeout),curNotifier.error_timeout<64&&(curNotifier.error_timeout*=2)}}}.bind(this),onFail)}},lpChecked:function(e){var t=e.failed;if(2==t)return 4==e.err?2:(curNotifier.lpInvalid=!0,debugLog("notifier lpCheck error",e),clearTimeout(curNotifier.lp_error_to),curNotifier.lp_error_to=setTimeout(this.lpGetKey.bind(this),1e3*curNotifier.error_timeout),curNotifier.error_timeout<64&&(curNotifier.error_timeout*=2),1==e.err?1:3);if(t)throw getLang("global_unknown_error");return this.lcSend("feed",extend({full:curNotifier.idle_manager&&curNotifier.idle_manager.is_idle&&!this.canNotifyUi(),key:curNotifier.key},e)),curNotifier.timestamp=e.ts,Notifier.pushEvents(e.events),0},lpOnReset:function(){curNotifier.lpOnReset&&curNotifier.lpOnReset()},lpReset:function(e){curNotifier.lpOnReset=e,clearTimeout(curNotifier.resetTO),curNotifier.resetTO=setTimeout(function(){if(curNotifier.is_server&&!curNotifier.lp_started)return void Notifier.lpStart();if(curNotifier.lpMakeRequest&&!curNotifier.lpInvalid){var e=curNotifier.key,t=curNotifier.timestamp;each(curNotifier.addQueues,function(a,i){e+=i[2],t+="_"+i[1]}),curNotifier.lpMakeRequest(curNotifier.frame_url,{act:"a_release",key:e,ts:t,id:curNotifier.uid,wait:25},Notifier.lpOnReset,Notifier.lpOnReset)}else ajax.post("notifier.php?act=a_reset",!1,{onDone:Notifier.lpOnReset,onFail:function(){return Notifier.lpOnReset(),!0}})},100)},lpGetKey:function(){ajax.post("notifier.php?act=a_get_key",{id:curNotifier.uid},{onDone:function(e,t){curNotifier.timestamp=t,curNotifier.key=e,curNotifier.lpInvalid=!1,debugLog("notifier lpGetKey done"),this.lcSend("new_key",{ts:t,key:e}),this.lpCheck()}.bind(this),onFail:function(e){switch(debugLog("notifier lpGetKey fail",e),e){case 1:case 3:return void Notifier.standby();case 4:return void Notifier.standby(300);case 2:return void Notifier.onRelogin()}return curNotifier.error_timeout=64,clearTimeout(this.lp_error_to),this.lp_error_to=setTimeout(this.lpGetKey.bind(this),1e3*curNotifier.error_timeout),!0}.bind(this)})},addKey:function(e,t,a){if(curNotifier.flash_transport||!e)return!1;var i=e.queue||e.key,r=curNotifier.addQueues[i],n=!r&&curNotifier.is_server;return r?(r[0]=vkNow(),r[3]=t,r[4]=a):curNotifier.addQueues[i]=[vkNow(),e.ts,e.key,t,a],a||Notifier.lcSend("new_addkey",e),n&&Notifier.lpReset(Notifier.lpCheck.bind(Notifier)),!0},addFeed:function(e,t){var a=curNotifier.addQueues[e];isArray(a)&&a.length&&(a[1]=t.ts,isFunction(a[3])&&a[3](e,t))},addRecvClbk:function(e,t,a,i){curNotifier.recvClbks||(curNotifier.recvClbks={}),curNotifier.recvClbks[e]||(curNotifier.recvClbks[e]={}),(!curNotifier.recvClbks[e][t]||i)&&(curNotifier.recvClbks[e][t]=a)},setRecvClbk:function(e,t){curNotifier.recvClbks||(curNotifier.recvClbks={}),curNotifier.recvClbks[e]=[t]},fixPhoto:function(e,t){return e=clean(e),-1==e.indexOf("question_c.gif")?e:t?"/images/question_inv_xc.png":"/images/question_inv_c.png"}}},function(e,t,a){var i=a(38);e.exports=function(e,t){if(!i(e))return e;var a,r;if(t&&"function"==typeof(a=e.toString)&&!i(r=a.call(e)))return r;if("function"==typeof(a=e.valueOf)&&!i(r=a.call(e)))return r;if(!t&&"function"==typeof(a=e.toString)&&!i(r=a.call(e)))return r;throw TypeError("Can't convert object to primitive value")}},,function(e,t){e.exports=function(e,t,a,i){if(!(e instanceof t)||void 0!==i&&i in e)throw TypeError(a+": incorrect invocation!");return e}},,function(e,t){var a=0,i=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++a+i).toString(36))}},function(e,t,a){"use strict";var i=a(13)(!0);a(139)(String,"String",function(e){this._t=String(e),this._i=0},function(){var e,t=this._t,a=this._i;return a>=t.length?{value:void 0,done:!0}:(e=i(t,a),this._i+=e.length,{value:e,done:!1})})},,function(e,t){t.f={}.propertyIsEnumerable},,function(e,t,a){var i=a(93),r=a(96),n=a(59),s=a(25)("src"),o="toString",c=Function[o],u=(""+c).split(o);a(124).inspectSource=function(e){return c.call(e)},(e.exports=function(e,t,a,o){var c="function"==typeof a;c&&(n(a,"name")||r(a,"name",t)),e[t]!==a&&(c&&(n(a,s)||r(a,s,e[t]?""+e[t]:u.join(String(t)))),e===i?e[t]=a:o?e[t]?e[t]=a:r(e,t,a):(delete e[t],r(e,t,a)))})(Function.prototype,o,function(){return"function"==typeof this&&this[s]||c.call(this)})},function(e,t,a){var i=a(68),r=Math.min;e.exports=function(e){return e>0?r(i(e),9007199254740991):0}},function(e,t,a){"use strict";var i=a(132),r=a(1),n=a(2),s=a(85);e.exports=a(139)(Array,"Array",function(e,t){this._t=s(e),this._i=0,this._k=t},function(){var e=this._t,t=this._k,a=this._i++;return!e||a>=e.length?(this._t=void 0,r(1)):"keys"==t?r(0,a):"values"==t?r(0,e[a]):r(0,[a,e[a]])},"values"),n.Arguments=n.Array,i("keys"),i("values"),i("entries")},,,function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},,,function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t){"use strict";function a(e){var t=extend({},nav.objLoc,e);Object.keys(t).filter(function(e){return""===t[e]}).forEach(function(e){delete t[e]});var a=nav.toStr(t);nav.setLoc(a)}function i(){var e={};return{scheduleNav:function(t){e=extend(e,t)},commitNav:function(){a(e),e={}},scheduleNavWithTimeOut:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;e=extend(e,t),setTimeout(function(){a(e),e={}},i)}}}Object.defineProperty(t,"__esModule",{value:!0}),t.updateLocation=a,t.updateLazyLocation=i},function(e,t,a){"use strict";function i(e){return{unmount:function(){(0,n.destroyModule)(e)}}}function r(e,t,a){var r=(0,n.createMutations)(i),s=(r.callMutations,r.bindMutations),o=(0,n.createModule)({handlers:function(e,t){}});return s(o)}Object.defineProperty(t,"__esModule",{value:!0}),t.mount=r;var n=a(44)},function(e,t,a){"use strict";var i=a(51);e.exports=a(138)("Map",function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}},{get:function(e){var t=i.getEntry(this,e);return t&&t.v},set:function(e,t){return i.def(this,0===e?0:e,t)}},i,!0)},function(e,t){"use strict";function a(e){return"im_store_"+e}function i(e){return ls.get(a(e))||{}}function r(e,t,i){if(ls.checkVersion()){var r=JSON.stringify(t);rand(0,1e5)<=1&&statlogsValueEvent("im_local_store_size",r.length),i(a(e),r)}}function n(e,t,a){return t===d?e[t]||[]:t===f?e[t]&&e[t][a]:e[t]?extend(!0,{},e[t][a]):null}function s(e,t,a){switch(e[t]||(e[t]={}),t){case d:var i=a;i&&i.length>0?e[t]=i:delete e[t];break;case f:var r=l(a,2),n=r[0],s=r[1];s?e[t][n]=+s:delete e[t][n]}return e}function o(e,t){for(var a=["fwd","draft","bind_attach"],n=i(e),s=!1,o=a.length;o--;)a[o]in n&&(delete n[a[o]],s=!0);s&&r(e,n,t)}function c(e,t,i){i.key===a(e)&&(t.db=JSON.parse(i.newValue),t.checkTime=Date.now())}function u(e){var t=debounce(function(e,t){localStorage.setItem(e,t)},300);ls.checkVersion()&&o(e,t);var a={db:i(e),checkTime:Date.now()},u=c.bind(null,e,a);return window.addEventListener("storage",u,!1),{select:function(t,r){return Date.now()-a.checkTime>1e3&&(a.db=i(e)),n(a.db,t,r)},selectByKey:function(t){return Date.now()-a.checkTime>1e3&&(a.db=i(e)),a.db[t]},update:function(i,n){var o=s(a.db,i,n);return a.db=o,a.checkTime=Date.now(),r(e,o,t)},updateByKey:function(i,n){return a.db[i]=n,a.checkTime=Date.now(),r(e,a.db,t)},unmount:function(){window.removeEventListener("storage",u,!1)}}}Object.defineProperty(t,"__esModule",{value:!0});var l=function(){function e(e,t){var a=[],i=!0,r=!1,n=void 0;try{for(var s,o=e[Symbol.iterator]();!(i=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);i=!0);}catch(c){r=!0,n=c}finally{try{!i&&o["return"]&&o["return"]()}finally{if(r)throw n}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.deleteOldStoredFormat=o,t.mount=u;var d=t.RECENT_SEARCH_OP="recent_search",f=t.PIN_HIDDEN_ID_OP="pin_hide"},function(e,t,a){var i=a(67),r=a(101),n=a(65),s=a(99),o=a(31),c=a(140);e.exports=function(e,t,a,u,l){var d,f,h,p=l?function(){return e}:c(e),_=i(a,u,t?2:1),m=0;if("function"!=typeof p)throw TypeError(e+" is not iterable!");if(n(p))for(d=o(e.length);d>m;m++)t?_(s(f=e[m])[0],f[1]):_(e[m]);else for(h=p.call(e);!(f=h.next()).done;)r(h,_,f.value,t)}},function(e,t,a){"use strict";function i(e){return{callMutations:function(){if("function"==typeof e)throw console.trace(),new Error("Mutations are not initialized");return e},bindMutations:function(){return e=e.apply(void 0,arguments)}}}function r(e,t,a,i){addEvent(t,a,i),e._registeredHandlers.push(["bind",t,a,i])}function n(e,t,a,i,r){(0,c.addDelegateEvent)(t,a,i,r),e._registeredHandlers.push(["delegate",t,a,i,r])}function s(e){var t={_registeredHandlers:[]};return e.handlers(r.bind(null,t),n.bind(null,t)),t}function o(e){e._registeredHandlers.forEach(function(e){var t=e.slice(1);"delegate"===e[0]?c.removeDelegateEvent.apply(void 0,t):removeEvent.apply(void 0,t)}),e._registeredHandlers=[]}Object.defineProperty(t,"__esModule",{value:!0}),t.createMutations=i,t.createModule=s,t.destroyModule=o;var c=a(19)},function(e,t,a){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t["default"]=e,t}function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function n(e){return e.resync_in_process?e.resync_in_process:Promise.resolve(!1)}function s(e){if(!e.renew_hashes){var t=e.last_hashes_update||0;if(Date.now()-t<1e4)return Promise.resolve();var a=Object.keys(e.tabs).filter(function(t){return(0,qt.isFullyLoadedTab)(e,t)});e.renew_hashes=(0,Rt.post)(Rt.CONTROLLER,{act:"a_renew_hash",peers:a.join(","),gid:e.gid}).then(function(t){var i=Mt(t,1),r=i[0];return a.forEach(function(t){e.tabs[t].hash=r[t]}),delete e.renew_hashes,e.last_hashes_update=Date.now(),e})}return e.renew_hashes}function o(e,t,a){return n(e).then(function(i){return i?t.apply(void 0,a):s(e).then(function(e){return t.apply(void 0,a)})})}function c(e){return function(){var t=arguments,a=t[t.length-1];return e.apply(void 0,t)["catch"](function(i){if(i&&i.match&&i.match(/1001;/))return o(a,e,t);throw i})}}function u(e){return"string"==typeof e?se("<div>"+e+"</div>"):e}function l(e,t){var a=e.indexOf(t);-1===a&&e.push(t)}function d(e,t){var a=e.indexOf(t);-1!==a&&e.splice(a,1)}function f(e){return"string"==typeof e?e:e.innerHTML}function h(e,t){return t.block_states=extend(t.block_states,e),Promise.resolve(t)}function p(e,t,a,i,r){return r.tabHistoryNotChanged=!1,(0,Dt.retryFn)(Rt.post,3,function(e){return e-1})(Rt.CONTROLLER,{act:"a_start",peer:e,msgid:a,history:t,prevpeer:r.prevPeer,gid:r.gid,block:i}).then(function(t){var i=Mt(t,5),n=i[0],s=i[1],o=i[2],c=i[3],u=i[4];if(s.forEach(function(e){return(0,Gt.oCacheAdd)(r,e)}),r.tabs||(r.tabs={}),r.dialog_tab_cts=u,r.tabs[e]||(r.tabs[e]=(0,qt.normalizeTab)(r,n)),h(c,r),a){if(r.tabs[e]){var l=r.tabs[e].lastmsg,d=r.tabs[e].lastmsg_meta;extend(r.tabs[e],n),r.tabs[e].lastmsg=l,r.tabs[e].lastmsg_meta=d}}else extend(r.tabs[e],n);return r.admins=extend(r.admins,o),r.imQueue(e,!1),_(e,r)})["catch"](function(e){return(0,Vt.imWeirdCatch)("loadPeer",e)})}function _(e,t){var a=t.imQueue(e,!1),i=t.tabs[e],r=a.filter(function(a){return!(0,Ut.isRidExist)(t,e,a.rid)});return i.msgs=r.reduce(function(e,t){return e["rid"+t.rid]=t.mess,e},i.msgs),t.imQueueSet(e,r),t.tabs[e].history=(0,qt.restoreQueue)(r,t,u(t.tabs[e].history)),Promise.resolve(t)}function m(e,t,a){var i=a.imQueue(e,!1).filter(function(e){return e.failed&&e.mess.messageId!==t});return a.imQueueSet(e,i),a.tabs[e].history=(0,qt.removeMessages)([t],u(a.tabs[e].history)),Promise.resolve(a)}function g(e,t){return(t.block_states[e]||{}).free===!1?Promise.resolve(t):(0,Rt.post)(Rt.CONTROLLER,{act:"a_block",peer:e,prevPeer:t.prevPeer,gid:t.gid}).then(function(e){var a=Mt(e,1),i=a[0];return h(i,t)})}function v(e,t){var a=t.peer;return Promise.resolve(t).then(function(t){return t.tabHistoryNotChanged=!1,(0,qt.isFullyLoadedTab)(t,a)&&!t.tabs[a].msgid?(t.gid&&g(a,t),Promise.resolve(t).then(N)):((0,qt.isFullyLoadedTab)(t,a)&&(t.tabs[a].msgid=!1),p(a,e,!1,!0,t))}).then(N).then(b.bind(null,a))}function b(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1;return(0,qt.isTabLoaded)(t,e)&&(t.tabs[e].last_touched=Date.now()),(0,qt.isTabLoaded)(t,e)&&a&&(t.tabs[e].last_visited=Date.now()),t}function C(e,t,a){var i=a.msgid,r=a.peer;return!e&&(0,qt.isFullyLoadedTab)(a,r)&&a.tabs[r].msgs[i]?(t===a.peer?a.tabHistoryNotChanged=!0:a.tabHistoryNotChanged=!1,a.gid&&g(r,a),Promise.resolve(a).then(N).then(b.bind(null,r))):p(r,!0,i,!0,a).then(N).then(function(){var e=(0,Ut.getTab)(a,r);return e.msgid=i,a}).then(b.bind(null,r))}function y(e,t,a){if(Qe(a))throw(0,qt.showWaitUntilUploadedBox)(),new Error("Cant change peer while loading somethind");var i=a.gid?"gim"+a.gid:"im";if(a.prevPeer=a.peer,a.peer=e,a.msgid=t||"",cur.peer=e,Jt({sel:e?(0,qt.convertPeerToUrl)(e):null,msgid:a.msgid,email:"",0:i}),0!=a.prevPeer&&b(a.prevPeer,a,!0),0!==e){var r=[];(0,qt.isTabLoaded)(a,e)&&b(e,a,!0),r=a.tabbedPeers.map(function(e){return e.peer}).indexOf(e)<0?[{peer:e,type:"perm"}].concat(a.tabbedPeers):a.tabbedPeers.map(function(t){return t.peer==e&&"perm"!==t.type&&(t.type="perm"),t}),dt(r,!1,a)}else dt(a.tabbedPeers,!1,a);return Zt(),pe(a.prevPeer,a)}function w(e){if(cur.wallMentions=[],(0,qt.isChatPeer)(e.peer)&&(0,qt.isTabLoaded)(e,e.peer)){var t=e.tabs[e.peer],a=[];Object.keys(t.msgs||{}).reverse().forEach(function(e){var i=(0,Ut.parserMessage)(t.msgs[e]),r=i&&i.userId;r&&r!=vk.id&&-1===a.indexOf(r)&&(0,qt.isUserAliveInChat)(t,r)&&a.push(r)}),t.memberIds.forEach(function(e){-1===a.indexOf(e)&&(0,qt.isUserAliveInChat)(t,e)&&a.push(e)}),a.forEach(function(t){if((0,Gt.oCacheExists)(e,t)){var a=(0,Gt.oCacheGet)(e,t),i=a.link.substring(1);cur.wallMentions.push([a.id,a.name,"@"+i,a.photo,void 0,void 0,void 0,i,a.first_name])}})}}function N(e){var t=e.peer;if(0===t)return Promise.resolve(e);var a=e.tabs[t],i=[];a.offset&&i.push("photos"),a.offset&&i.push("search"),(-2e9>t||a.offset)&&i.push("clear"),(0,qt.isCommunityInterface)(e)&&i.push("block"),(0,qt.isCommunityPeer)(t)&&(a.blocked_community?i.push("allow_community"):i.push("block_community")),!(0,qt.isChatPeer)(t)&&!(0,qt.isUserPeer)(t)||(0,qt.isCommunityInterface)(e)||(0,qt.isChatPeer)(t)&&(a.data.kicked||a.data.closed)||(inArray(t,e.mutedPeers)?i.push("unmute"):i.push("mute")),(0,qt.isUserPeer)(t)&&!e.gid&&!a.blacklisted&&a.is_friend&&i.push("invite"),(0,qt.isChatPeer)(t)&&!a.data.closed&&!a.data.kicked&&a.data.link&&i.push("invite_link"),!(0,qt.isChatPeer)(t)||a.data.closed||a.data.kicked||i.push("topic","avatar","invite","leave"),(0,qt.isChatPeer)(t)&&a.data.closed&&!a.data.kicked&&i.push("return"),(0,qt.isChatPeer)(t)&&a.pinned&&(geByClass1("im-page--chat-header_hide-pin-actions")||(i.push((0,Kt.isPinnedMessageVisibleInTab)(e,t)?"pin_hide":"pin_unhide"),i.push("unpin")));var r=(0,qt.chatActions)(e);return e.curActions=i.sort(function(e,t){return ta[e]-ta[t]}).reduce(function(e,t){return e[t]=r[t],e},{}),Promise.resolve(e)}function T(e,t,a){var i=a.tabs[a.peer];return(0,Rt.post)(Rt.CONTROLLER,{peer:a.peer,whole:e,act:"a_history",offset:i.offset+(i.skipped||0),toend:t,gid:a.gid}).then(function(e){var t=Mt(e,4),r=t[0],n=t[1],s=t[2],o=t[3];return i.allShown=s,a.admins=extend(a.admins,o),i.history=r+f(i.history),i.historyToAppend=r,i.offset+=Object.keys(n).length,i.msgs=extend(i.msgs,n),a})}function F(e){var t=e.tabs[e.peer];return(0,Rt.post)(Rt.CONTROLLER,{peer:e.peer,act:"a_history",rev:1,offset:t.skipped,gid:e.gid}).then(function(a){var i=Mt(a,5),r=i[0],n=i[1],s=i[2];i[3],i[4],t.allShown=t.allShown||s,t.history=f(t.history)+r,t.historyToAppend=r;var o=Object.keys(n).length;return t.skipped-=o,t.offset+=o,t.msgs=extend(t.msgs,n),e})}function k(e,t,a,i){var r=e.tabs[t];return i===Bt.FLAG_OUTBOUND?r.out_up_to=a:r.in_up_to=a,e}function E(e,t,a){var i=e.tabs[t];return i.unread=(0,Ut.countUnread)(t,e)+(i.unread>0?a:0),e}function S(e,t){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_email_start",email:e,hash:t.writeHash}).then(function(e){var a=Mt(e,2),i=a[0],r=a[1];return W(i,t),r})}function x(e){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_get_key",uid:e.id,gid:e.gid}).then(function(t){var a=Mt(t,3),i=a[0],r=a[1],n=a[2];return extend({},e,{imKey:i,imUrl:r,imPart:n})})}function L(e){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_get_ts",gid:e.gid}).then(function(t){var a=Mt(t,1),i=a[0];return extend({},e,{imTs:i})})}function I(e,t,a){var i=a.tabs[e];return i.msgs[t.messageId]&&(i.msgs[t.messageId].errored=1,i.history=(0,qt.setMessageError)(e,t,u(i.history))),Promise.resolve(a)}function O(e,t,a,i){var r=i.tabs[e];return r.msgs[t]&&(r.msgs[t].errored=0,r.lastmsg_meta=a,r.lastmsg=t,r.history=(0,qt.startResendMessage)(e,t,u(r.history))),Promise.resolve(i)}function M(e,t,a,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:!1;t.deletedDialog||(e.dialog_tabs=Object.keys(e.dialog_tabs).reduce(function(e,n){return!a&&!et(n)(t)||r&&!r(n,e[n],t)||(e[n]=(0,Ht.arrayUnique)(i(e[n],n))),e},e.dialog_tabs))}function R(e,t){return 0===e.length?Promise.resolve(t):(0,Rt.post)(Rt.CONTROLLER,{act:"a_get_admin",admins:e.join(","),gid:t.gid}).then(function(e){var a=Mt(e,1),i=a[0];return t.admins=extend(t.admins,i),t})}function P(e,t){if(!inArray(e,t.tabbedPeers.map(function(e){return e.peer}))&&(0!==t.peer||t.searchText)&&!inArray(e,t.mutedPeers)){var a={peer:e,type:"temp"};dt(t.tabbedPeers.concat([a]),!1,t)}}function A(e,t,a){return(0,qt.isReversedDialogs)(a)?t.concat([e]):[e].concat(t)}function B(e,t){var a=(0,Ut.getTab)(t,e.peerId),i=(0,Ut.getMessage)(t,e.peerId,e.messageId);if(i&&(e.chatLocalId=i.chatLocalId),(0,qt.isFullyLoadedTab)(t,e.peerId)){var r=u(a.history);a.msgs[e.messageId]=extend(!0,{},e),a.history=(0,qt.sebastianovAndReplaceMessage)(t,e,r)}a&&a.lastmsg==e.messageId&&(a.lastmsg_meta=e);var n=a&&a.pinned&&(0,Ut.parserMessage)(a.pinned);return n&&n.messageId==e.messageId&&(a.pinned=e),Promise.resolve(t)}function D(e,t){var a=e.flags&Bt.FLAG_OUTBOUND,i=e.peerId;if((0,qt.isTabLoaded)(t,i)){var n=t.tabs[i];if(n.deletedDialog=!1,!t.msg_local_ids_sort&&e.local?t.msg_local_ids_sort=r({},e.messageId,0):e.local&&(t.msg_local_ids_sort[e.messageId]=Object.keys(t.msg_local_ids_sort).length),a?n.unread=0:(n.lastmsg==e.messageId&&n.unread?H(t,1,e.peerId):(!n.unread&&H(t,1,e.peerId),n.unread++),P(e.peerId,t)),(0,qt.isFullyLoadedTab)(t,i)){var s=u(n.history);n.skipped>0&&n.skipped++,n.offset++,n.msgs[e.messageId]=extend(!0,{},e),n.history=(0,qt.appendToHistory)(t,e,s,!0,!0,!0),(0,Wt.isOut)(e)&&(n.blocked_community=0,N(t))}return n.typing&&n.typing[e.userId]&&delete n.typing[e.userId],n.lastmsg=e.messageId,n.lastmsg_meta=e,b(e.peerId,t),M(t,n,!1,A.bind(null,i),rt.bind(null,t)),Promise.resolve(t)}return p(i,0,0,0,t).then(function(t){var r=t.tabs[i];return M(t,r,!1,A.bind(null,i),rt.bind(null,t)),b(e.peerId,t),a||P(e.peerId,t),t})}function H(e,t,a){e.cur_unread_cnt||(e.cur_unread_cnt={}),-1===t&&delete e.cur_unread_cnt[a],e.unread_cnt+=t}function j(e,t){if((0,qt.isFullyLoadedTab)(t,e.peerId)){var a=t.tabs[e.peerId],i=a.unread;if(t=k(t,e.peerId,e.upToId,0),t=E(t,e.peerId,intval(a.skipped)),i>0&&!a.unread&&H(t,-1,e.peerId),!a.skipped){var r=u(a.history);a.history=(0,qt.removewNewUnreadBarAndMerge)(t,r,e.peerId)}}else(0,qt.isTabLoaded)(t,e.peerId)&&(t.tabs[e.peerId].unread>0&&H(t,-1,e.peerId),t.tabs[e.peerId].unread=0,t.tabs[e.peerId].in_up_to=e.upToId);return(0,qt.isTabLoaded)(t,e.peerId)&&(t.dialog_tabs[zt.FOLDER_UNREAD]=t.dialog_tabs[zt.FOLDER_UNREAD].filter(function(t){return intval(t)!==e.peerId})),0!==t.unread_cnt||t.active_tab!==zt.FOLDER_UNREAD||t.gid?Promise.resolve(t):tt(zt.FOLDER_ALL,t)}function q(e,t){var a=t.tabs[e.peerId];if((0,qt.isTabLoaded)(t,e.peerId)&&k(t,e.peerId,e.upToId,Bt.FLAG_OUTBOUND),(0,qt.isFullyLoadedTab)(t,e.peerId)){var i=u(a.history);a.history=(0,qt.markMessagesAsRead)(t,e.peerId,i)}return Promise.resolve(t)}function z(e,t,a,i,r){return r.text={},r.imQueue=e,r.imQueueResend=t,r.imQueueSet=a,r.imQueueComplete=i,Promise.resolve(r)}function U(e,t,a){function i(e,t){return{id:e.messageId,text:e.text,date:e.date,kludges:e.kludges,authorName:t}}if(1===e.length){var n=e[0],s=(0,Ut.getMessage)(a,t,n),o=(0,Ut.getAuthorFullName)(a,t,n);return o===!1?a.set(Se.bind(null,r({},t,[s.userId]))).then(function(a){var r=(0,Ut.getAuthorFullName)(a,t,n);return{msgIds:e,object:i(s,r)}}):Promise.resolve({msgIds:e,object:i(s,o)})}return Promise.resolve({msgIds:e})}function W(e,t){(0,qt.normalizeTabsGotFromServer)(t,e);var a=t.tabs[t.peer];return t.tabs=Object.keys(e).reduce(function(a,i){var r=t.tabs[i]?t.tabs[i].msgs:{},n=extend({},r||{},e[i].msgs||{});return a[i]=extend(t.tabs[i]||{},e[i]),n&&(a[i].msgs=n),e[i].lastmsg||(a[i].lastmsg=!1),a},t.tabs),a&&(t.tabs[t.peer]=a),Promise.resolve(t)}function G(e,t,a,i){var r=(0,Ut.getTab)(i,e);if(r){var n=t!==!1?t==Xt?2:mobPlatforms[t]?1:0:r.last_seen[2];r.online=t,r.last_seen=[t,a||r.last_seen[1],n]}return Promise.resolve(i)}function V(e,t,a){var i=(0,Ut.getTab)(a,e);return i&&(i.typing||(i.typing={}),i.typing[t]=Date.now()),Promise.resolve(a)}function K(e,t,a){return(0,Dt.pause)(Qt+2).then(function(){if((0,qt.isTabLoaded)(a,e)){var i=a.tabs[e];if(i.typing){var r=Date.now()-(i.typing[t]||0);r>=1e3*Qt&&delete i.typing[t]}}return a})}function Q(e){return e.map(function(e){return e[0]+":"+e[1]}).join(",")}function Y(e,t){if(t.selectedMessages||(t.selectedMessages=[]),1===e.length&&inArray(e[0],t.selectedMessages))t.selectedMessages=t.selectedMessages.filter(function(t){return t!==e[0]});else{var a=t.selectedMessages.concat(e);t.selectedMessages=(0,Ht.arrayUnique)(a).sort(function(e,t){return e-t})}return Promise.resolve(t)}function X(e){return e.selectedMessages=[],Promise.resolve(e)}function $(e){return e.selectedMessages=[],Promise.resolve(e)}function J(e,t){if((0,qt.isFullyLoadedTab)(t,e.peerId)){var a=t.tabs[e.peerId],i=t.imQueue(e.peerId).filter(function(t){return t.failed&&t.rid!==e.randomId});t.imQueueSet(e.peerId,i),t.imQueueComplete(e.peerId,e.randomId),a.lastmsg_meta=e,a.lastmsg=e.messageId;var r=a.msgs["rid"+e.randomId];r&&(a.msgs[e.messageId]=e,delete a.msgs["rid"+e.randomId]),a.history=(0,qt.replaceMessageAttrs)(t,u(a.history),e)}return Promise.resolve(t)}function Z(e,t){return Promise.resolve()}function ee(e,t){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_get_media",id:e.messageId,gid:t.gid}).then(function(a){var i=Mt(a,3),r=i[0],n=i[1],s=i[2],o=t.tabs[e.peerId];return o.mediacontent||(o.mediacontent={}),o.mediacontent[e.messageId]=[r,n,s],te(e,t)})}function te(e,t){var a=t.tabs[e.peerId];return a.history=(0,qt.replaceAttaches)(u(a.history),e,t),Promise.resolve(t)}function ae(e,t,a){var i=(0,qt.dayFromVal)(t),r=a.tabs[e];return r.searchDay=i,r.searchOffset=0,r.searchAllLoaded=!1,Promise.resolve(a)}function ie(e,t,a){if(t){var i=a.tabs[t];i.searchText=e,i.searchOffset=0,i.searchAllLoaded=!1}else a.searchText=e,a.searchOffset=0,a.searchAllLoaded=!1;return Promise.resolve(a)}function re(e,t,a,i){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_hints",str:e,gid:i.gid,query:a,peerIds:t.join(",")}).then(function(e){var t=Mt(e,3),a=t[0],r=t[1],n=t[2];return h(n,i),r.forEach(function(e){return(0,Gt.oCacheAdd)(i,e)}),W(a,i),Object.keys(a).sort(function(e,t){return a[e].order-a[t].order}).map(function(e){return a[e]})})}function ne(e,t,a,i){return re(e,t,a,i).then(function(e){return e.map(function(e){return{peerId:e.peerId,name:e.tab,photo:e.photo,online:e.online,is_friend:"friends"===a?!0:!1}})})}function oe(e){return{peerId:e[0],name:e[1],tab:e[1],photo:e[2],href:e[3],online:e[4],is_friend:e[5],local_index:!0}}function ce(e){return function(t,a){return e(a).then(function(e){var i=t?e.search(t):e.list,r=i.map(oe);return a.mapped_index||(a.mapped_index={}),r.forEach(function(e){a.mapped_index[e.peerId]=e}),r})}}function ue(e,t){var a=void 0,i=void 0;t.topConvTree=new Promise(function(e){a=e}),t.hintsTree=new Promise(function(e){i=e});var r=e.select(jt.RECENT_SEARCH_OP);return(0,Dt.retryFn)(Rt.post,1,function(){return 4})(Rt.CONTROLLER,{act:"a_dialogs_preload",rs:r.join(","),gid:t.gid})["catch"](function(e){return[[],[],[]]}).then(function(e){var r=Mt(e,3),n=r[0],s=r[1],o=r[2];return t.popular_sugg=o,new vkIndexer(n,function(e){return e[1]},a),new vkIndexer(s,function(e){return e[1]},i),t})}function le(e){var t=e.active_tab;return(0,Rt.post)(Rt.CONTROLLER,{act:"a_get_dialogs",offset:e.offset,tab:t,gid:e.gid}).then(function(a){var i=Mt(a,4),r=i[0],n=i[1],s=i[2],o=i[3];return s.forEach(function(t){return(0,Gt.oCacheAdd)(e,t)}),h(o,e),W(n,e),e.dialog_tabs[t]=e.dialog_tabs[t].concat(Object.keys(n).map(intval)),e.offset=r.offset,e.dialog_tabs_all[t]=!r.has_more,Promise.resolve(e)})}function de(e,t){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_search",q:e,from:"all",gid:t.gid,hash:t.writeHash,offset:t.searchOffset||0}).then(function(a){var i=Mt(a,5),r=i[0],n=i[1],s=i[2],o=i[3],c=i[4];return n.forEach(function(e){return(0,Gt.oCacheAdd)(t,e)}),(0,qt.normalizeTabsGotFromServer)(t,r),e===t.searchText&&(t.searchOffset=o,t.searchAllLoaded=c),Object.keys(r).filter(function(e){return!t.tabs[e]}).forEach(function(e){t.tabs[e]=r[e]}),[r,s]})}function fe(e,t){var a=t.tabs[e];return a.searchAllLoaded}function he(e,t){if(t.peer===e&&(0,qt.isFullyLoadedTab)(t,e)){var a=t.tabs[e];return a.inplaceSearch}return!1}function pe(e,t){if((0,qt.isFullyLoadedTab)(t,e)){var a=t.tabs[e];delete a.inplaceSearch,delete a.searchOffset,delete a.searchAllLoaded,delete a.searchText,delete a.searchDay}return Promise.resolve(t)}function _e(e,t){if((0,qt.isFullyLoadedTab)(t,e)){var a=t.tabs[e];delete a.searchDay,a.searchOffset=0,a.searchAllLoaded=!1}return Promise.resolve(t)}function me(e,t){var a=t.tabs[e];return a.inplaceSearch=!0,Promise.resolve(t)}function ge(e,t){var a=t.tabs[e],i="";if(me(e,t),a.searchDay&&(i="day:"+a.searchDay),!i&&!a.searchText)return Promise.reject();var r="in:"+e+" "+i+" "+(a.searchText||"");return(0,Rt.post)(Rt.CONTROLLER,{act:"a_search",q:r,from:"in",gid:t.gid,hash:t.writeHash,offset:a.searchOffset||0}).then(function(e){var t=Mt(e,3),i=t[0],r=t[1],n=t[2];return a.searchOffset=r,a.searchAllLoaded=n,i})}function ve(e){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_important",offset:e,part:e>0})}function be(e,t,a){if((0,qt.isFullyLoadedTab)(a,t)){var i=a.tabs[t];i.deleted=i.deleted?i.deleted.concat(e):e,i.history=(0,qt.removeMessages)(e,u(i.history)),i.offset-=e.filter(function(e){return i.msgs[e]}).length,e.forEach(function(e){return delete i.msgs[e]})}return Promise.resolve(a)}function Ce(e,t,a,i,r){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_mark",peer:t,hash:a,gid:r,msgs_ids:e.join(","),mark:i})}function ye(e,t,a,i){if((0,qt.isFullyLoadedTab)(i,t)){var r=i.tabs[t];r.deleted=r.deleted?r.deleted.concat(e):e,r.history=(0,qt.removeMessagesWithRestore)(e,t,a,u(r.history)),r.offset-=e.filter(function(e){return r.msgs[e]}).length}return Promise.resolve(i)}function we(e,t,a){if((0,qt.isFullyLoadedTab)(a,t)){var i=a.tabs[t];i.deleted&&(i.deleted=i.deleted.filter(function(t){return t!==e})),i.history=(0,qt.restoreMessage)(e,t,u(i.history)),i.offset++}return Promise.resolve(a)}function Ne(e,t,a,i){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_restore",id:e,peer:t,hash:a,gid:i})}function Te(e,t,a){return t&&(a.pendingForward=null,e||(e={msgIds:[]}),t.addAttach("mail",e.msgIds.join(";"),e.object||null)),Promise.resolve(a)}function Fe(e,t){return t.pendingForward=e,Promise.resolve(t)}function ke(e,t,a){if((0,qt.isTabLoaded)(a,e)){a.blockedFlagUpdates||(a.blockedFlagUpdates={}),a.blockedFlagUpdates[e]=!0,M(a,a.tabs[e],!0,function(t){return t.filter(function(t){return t!==e})}),a.tabs[e].unread>0&&H(a,-1,e);var i=a.tabs[e];i.deletedDialog=!0;var r=a.tabbedPeers.filter(function(t){return t.peer!==e});return dt(r,!0,a),t.then(function(t){var r=Mt(t,2);return r[0],r[1],delete a.blockedFlagUpdates[e],i.msgs=null,i.history=null,i.unread=0,i.lastmsg=!1,i.lastmsg_meta=null,a})}}function Ee(e,t,a){return a.tabs[e].tab=t,Promise.resolve(a)}function Se(e,t){if(isEmpty(e))return Promise.resolve(t);var a=Object.keys(e).map(function(t){return t+":"+e[t].join(",")}).join(";");return(0,Rt.post)(Rt.CONTROLLER,{act:"a_load_member",need:a}).then(function(e){var a=Mt(e,1),i=a[0];return i.forEach(function(e){return(0,Gt.oCacheAdd)(t,e)}),t})}function xe(e,t,a,i){if(0===t.length)return Promise.resolve(i);var r=t.filter(function(e){return!(0,qt.isTabLoaded)(i,e.peerId)}).map(function(e){return p(e.peerId,0,0,0,i)}),n=e.filter(function(e){return e.kludges.source_act===qt.CHAT_INVITE_USER||e.kludges.source_act===qt.CHAT_INVITE_BY_LINK}).filter(function(e){return i.tabs[e.peerId]&&!(0,Gt.oCacheExists)(i,e.kludges.source_mid)}).reduce(function(e,t){var a=t.kludges.source_mid;return e[t.peerId]||(e[t.peerId]=[]),
a?inArray(a,e[t.peerId])||e[t.peerId].push(a):e[t.peerId].push(t.userId),e},{}),s=t.filter(function(e){return e.flags&Bt.FLAG_OUTBOUND&&!e.local}).map(function(e){return e.kludges.from_admin}).filter(function(e){return e&&!i.admins[e]});return 0===Object.keys(n).length&&0===s.length&&0===r.length?Promise.resolve(i):(a.pause(),Promise.all([Se(n,i),R(s,i),Promise.all(r)])["catch"](function(){return i}).then(function(){return a.resume()}).then(function(){return i}))}function Le(e,t,a,i){var r=i.tabs[a];return t!==vk.id?Promise.resolve(i):((0,qt.isTabLoaded)(i,a)&&(e===qt.CHAT_KICK_USER?r.data.closed=!0:e===qt.CHAT_INVITE_USER&&(r.data.closed=!1),i.peer===a&&(i=N(i))),Promise.resolve(i))}function Ie(e,t,a){var i=a.mutedPeers.filter(function(t){return t!==e});return t&&i.push(e),a.mutedPeers=i,cur.mutedPeers=a.mutedPeers,N(a)}function Oe(e,t){return t.stack=e,Promise.resolve(t)}function Me(e,t,a,i){if((0,qt.isFullyLoadedTab)(i,t)){var r=i.tabs[t];e.filter(function(e){return r.msgs[e]}).forEach(function(e){var n=(0,Ut.getMessage)(i,t,e),s=a?n.flags|Bt.FLAG_IMPORTANT:n.flags&~Bt.FLAG_IMPORTANT;n.flags=s,r.msgs[e]=n,r.history=(0,qt.updateStar)(e,a,u(r.history))})}return Promise.resolve(i)}function Re(e,t,a){a.importants||(a.importants={});var i=a.importants[t]||0;return i!==e&&(a.important_cnt+=e,a.importants[t]=e),Promise.resolve(a)}function Pe(e,t){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_spam",offset:e,gid:t,part:e>0})}function Ae(e,t){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_flush_spam",gid:t,hash:e})}function Be(e,t,a){return a.creationType=e,a.creationFilter=t,Promise.resolve(a)}function De(e,t){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_owner_photo",photo:JSON.parse(e).data[0],peer:t})}function He(e,t){return t.next_chat_avatar=e,Promise.resolve(t)}function je(e,t,a){return(0,Rt.post)("al_page.php",{act:"owner_photo_save",peer:e,_query:t}).then(function(e){return a})}function qe(e,t,a,i){return i.creating=!0,i.longpoll.pause(),(0,Rt.post)(Rt.CONTROLLER,{act:"a_multi_start",hash:i.writeHash,peers:t.join(","),title:a}).then(function(e){var t=Mt(e,1),a=t[0];return i.next_peer=a.peerId,i.tabs[a.peerId]=a,M(i,a,!1,function(e){return[a.peerId].concat(e)}),i.longpoll.resume(),i}).then(function(t){return e?je(t.next_peer,e,t):t}).then(function(e){return e.creating=!1,e})["catch"](function(e){throw i.creating=!1,i.longpoll.resume(),e})}function ze(e){var t=void 0;e.resync_in_process=new Promise(function(e){t=e});var a=Object.keys(e.tabs).length,i=e.active_tab;return(0,Rt.post)(Rt.CONTROLLER,{act:"a_resync",sel:e.peer,gid:e.gid,loaded:a,tab:i,add_peers:e.tabbedPeers.map(function(e){return e.peer}).join(",")}).then(function(a){var n=Mt(a,5),s=n[0],o=n[1],c=n[2],l=n[3],d=n[4];o.forEach(function(t){return(0,Gt.oCacheAdd)(e,t)}),(0,qt.normalizeTabsGotFromServer)(e,s),c.user_unread&&handlePageCount("msg",c.user_unread),(0,Ht.lplog)("Resync success","success");var f=e.peer,h=void 0;if((0,qt.isReservedPeer)(f))h=Promise.resolve(!1);else{var p={tabs:r({},f,e.tabs[f]),oCache:{}};h=W(r({},f,s[f]),p)}return h.then(function(a){e.tabs=s,e.admins=extend(e.admins,l),a&&(e.tabs[f]=a.tabs[f],e.tabs[f].history=(0,qt.restoreQueue)(f,e,u(e.tabs[f].history))),e.loadingDialogs=!1,e.offset=Object.keys(s).length,e.mutedPeers=c.mutedPeers,e.lastDialogsOptions={has_more:c.has_more},e.dialog_tab_cts=c.folder_cts,e.dialog_tabs[i]=d.map(intval);var r=e.dialog_tabs[i].map(function(t){return e.tabs[t]});return Object.keys(e.dialog_tabs).filter(function(e){return e!=i}).forEach(function(t){i==zt.FOLDER_ALL?e.dialog_tabs[t]=r.filter(et(t)).map(function(e){return e.peerId}):e.dialog_tabs[t]=[]}),delete e.resync_in_process,setTimeout(t.bind(null,!0),0),Ye(intval(c.unread),e)})})["catch"](function(t){return(0,Ht.lplog)("Resync error: "+t.message+" "+t.stack,"error"),(0,Dt.pause)(2).then(ze.bind(null,e))})}function Ue(e,t,a,i){if((0,qt.isTabLoaded)(i,e)){var r=i.tabs[e];d(r.inactiveIds,a),l(r.memberIds,a),a===vk.id&&(r.data.kicked=0)}return Promise.resolve(i)}function We(e,t,a,i){if((0,qt.isTabLoaded)(i,e)){var r=i.tabs[e];l(r.inactiveIds,a),a===vk.id&&t!=a&&(r.data.kicked=1)}return Promise.resolve(i)}function Ge(e,t){return t.lockedSending=e,Promise.resolve(t)}function Ve(e,t,a){return e&&!a.delayed_message?(a.delayed_message=e,a.delayed_ts=t):e||(a.delayed_message=e,a.delayed_ts=t),Promise.resolve(a)}function Ke(){return window.Upload&&Upload.options?Object.keys(Upload.options).map(function(e){return Upload.options[e]}).filter(function(e){return e.xhr&&4!==e.xhr.readyState&&0!==e.xhr.readyState}).length>0:!1}function Qe(e){var t=e.textMediaSelector;return!!t.urlAttachmentLoading||Ke()}function Ye(e,t){return t.unread_cnt=e,t.dialog_tab_cts[zt.FOLDER_UNREAD]=e,Promise.resolve(t)}function Xe(e,t){return t.ctrl_submit=!!e,(0,Rt.post)(Rt.CONTROLLER,{act:"a_save_ctrl_submit",to:t.peer,hash:t.tabs[t.peer].hash,value:e?1:0}).then(function(e){return t})}function $e(e,t,a){return function(){a.update_old_title=e;var i=Object.keys(a.cur_unread_cnt).length;if(0===i)return document.title=e?e:document.title,setFavIcon("/images/icons/favicons/fav_im"+t+".ico"),clearInterval(a.update_title_to),void(a.update_title_to=!1);if(e)document.title=e,setFavIcon("/images/icons/favicons/fav_im"+t+".ico"),e=!1;else{e=document.title;var r=i>9?10:i;setFavIcon("/images/icons/favicons/fav_im"+r+t+".ico"),document.title=winToUtf(getLang("mail_im_new_messages",i))}}}function Je(e,t,a){a.cur_unread_cnt||(a.cur_unread_cnt={}),t&&!inArray(e,a.mutedPeers)&&(a.cur_unread_cnt[e]=!0);var i=document.title,r=window.devicePixelRatio>=2?"_2x":"";if(t&&!a.update_title_to){var n=$e(i,r,a);a.update_title_to=setInterval(n,1e3),n()}else!t&&a.update_old_title&&(document.title=a.update_old_title,a.cur_unread_cnt={},i=!1,a.update_old_title=!1,setFavIcon("/images/icons/favicons/fav_im"+r+".ico"),clearInterval(a.update_title_to),a.update_title_to=!1);return Promise.resolve(a)}function Ze(e,t,a,i,r){return(0,qt.isFullyLoadedTab)(r,e)&&(r.tabs[e].scrollTop=intval(t),r.tabs[e].scrollBottom=intval(a),r.tabs[e].contHeight=intval(i)),Promise.resolve(r)}function et(e){return e===zt.FOLDER_ALL?function(){return!0}:e===zt.FOLDER_UNREAD?function(e){return e.unread>0}:function(t){return t.folders&zt.FOLDER_MASKS[e]}}function tt(e,t){t.active_tab=e,(0,Pt.updateLocation)({tab:e===zt.FOLDER_ALL?null:e});var a=[];if(e!==zt.FOLDER_ALL&&!(0,qt.isReversedDialogs)(t)){var i=t.dialog_tabs[e];a=t.dialog_tabs[zt.FOLDER_ALL].map(function(e){return t.tabs[e]}).filter(et(e)).map(function(e){return e.peerId}),t.dialog_tabs[e]=i.length>=a.length?i:a}return t.offset=t.dialog_tabs[e].length,Promise.resolve(t)}function at(e,t,a){return e===Bt.SET_DIRECTORIES&&a.folders&t?!1:e!==Bt.RESET_DIRECTORIES||a.folders&t?!0:!1}function it(e,t,a){return t!==Bt.RESET_DIRECTORIES||e.folders&zt.FOLDER_MASKS[a]?t===Bt.REPLACE_DIRECTORIES?e.folders&zt.FOLDER_MASKS[a]?-1:1:t===Bt.SET_DIRECTORIES?1:-1:0}function rt(e,t,a,i){var r=e.dialog_tabs_all;if(r[zt.FOLDER_ALL]||r[t])return!0;if(a.filter(function(e){return e===i.peerId}).length>0)return!0;if("r"===i.lastmsg[0])return!0;var n=a.map(function(t){return e.tabs[t]}).filter(function(t){return(0,qt.isReversedDialogs)(e)?t.lastmsg>i.lastmsg:t.lastmsg<i.lastmsg});return n.length>0?!0:!1}function nt(e,t,a,i,r){if((0,qt.isTabLoaded)(r,e)){var n=r.tabs[e];return a===Bt.REPLACE_DIRECTORIES&&(t^=n.folders),at(a,t,n)&&Object.keys(zt.FOLDER_MASKS).filter(function(e){return zt.FOLDER_MASKS[e]&t}).forEach(function(e){r.dialog_tab_cts[e]+=it(n,a,e)}),a===Bt.SET_DIRECTORIES?r.tabs[e].folders|=t:a===Bt.RESET_DIRECTORIES?r.tabs[e].folders&=~t:r.tabs[e].folders=t^=n.folders,M(r,r.tabs[e],!0,function(t,a){return t.concat([e]).map(function(e){return r.tabs[e]}).filter(et(a)).map(function(e){return e.peerId})},rt.bind(null,r)),Promise.resolve(r)}return p(e,0,0,0,r).then(nt.bind(null,e,t,a,r))}function st(e){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_get_mutex_key",gid:e})}function ot(e,t){return h(r({},e,{free:!0}),t),(0,Rt.post)(Rt.CONTROLLER,{act:"a_block_release",peer:e,gid:t.gid}).then(function(){return t})}function ct(e,t){var a=ls.get("comm_mute_"+t.gid)?1:0;return e&&(a=1^a),ls.set("comm_mute_"+t.gid,a),t.mute=a,Promise.resolve(t)}function ut(e,t,a,i){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_restore_dialog",hash:t,gid:i.gid,spam:a?1:0,peer:e}).then(function(t){return i.tabs[e].deletedDialog=!1,M(i,i.tabs[e],!1,function(t){return[e].concat(t)}),i.tabs[e].unread=t,i})}function lt(e,t,a){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_spam_dialog",peer:e,gid:a.gid,hash:t})}function dt(e,t,a){return a.tabbedPeers=e,(0,qt.isClassicInterface)(a)&&(Jt({peers:a.tabbedPeers.filter(function(e){var t=e.peer,i=e.type;return t!==a.peer&&"perm"===i}).map(function(e){return(0,qt.getBareTab)(e.peer,a)}).filter(function(e){return!e.deletedDialog}).map(function(e){return e.peerId}).map(qt.convertPeerToUrl).join("_")}),t&&Zt()),Promise.resolve(a)}function ft(e){return e.peer?he(e.peer,e)?fe(e.peer,e):(0,qt.isFullyLoadedTab)(e,e.peer)?e.tabs[e.peer].allShown:!1:!0}function ht(e,t){var a=t.tabs[e];return(0,qt.isFullyLoadedTab)(t,e)&&(a.skipped=null,a.msgs=null,a.offset=null,a.allShown=null,a.history=null),Promise.resolve(t)}function pt(e,t){var a=t.tabs[e];return(0,qt.isFullyLoadedTab)(t,e)&&(a.history=f(a.history)),Promise.resolve(t)}function _t(e,t){return t.go_to_end_visible=e,Promise.resolve(t)}function mt(e,t,a){if(!(0,qt.isCommunityPeer)(t))return Promise.resolve(a);var i=(0,Ut.getTab)(a,t);return i.blocked_community=!e,(0,Rt.post)(Rt.CONTROLLER,{act:"a_toggle_community",peer_id:t,hash:i.hash,state:e?1:0}).then(function(){return N(a)})}function gt(e,t){if(0!==t.peer&&(0,qt.isFullyLoadedTab)(t,t.peer)){var a=(0,Ut.getTab)(t,t.peer);a.history=u(a.history),e(a.history)}return Promise.resolve(t)}function vt(e){return e.audio_msg.isRecording?Promise.reject():(e.audio_msg.isRecording=!0,Promise.resolve(e))}function bt(e){return e.audio_msg.isRecording=!1,Promise.resolve(e)}function Ct(e,t){return t.voice_message_available=e,Promise.resolve(t)}function yt(e){Jt({act:e?"create":null}),Zt()}function wt(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;Jt({q:e}),Zt()}function Nt(e){return"undefined"==typeof e.chatResizeInitialized&&(e.chatResizeInitialized=!0,(0,qt.getClassicChatHeight)()>window.clientHeight()&&(0,qt.setClassicChatHeight)(0)),Promise.resolve(e)}function Tt(e,t,a){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_join_chat",chat_id:e,hash:t,write_hash:a.writeHash}).then(function(e){var t=Mt(e,4),i=t[0],r=t[1],n=t[2],s=t[3];return n.forEach(function(e){return(0,Gt.oCacheAdd)(a,e)}),a.tabs[i]=r,M(a,r,!1,A.bind(null,i),rt.bind(null,a)),a.admins=extend(a.admins,s),[i]})}function Ft(e,t){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_reset_link",chat_id:e,write_hash:t.writeHash})}function kt(e){return ea({invite_chat_id:null,invite_hash:null}),e.invitation=void 0,Promise.resolve(e)}function Et(e,t){var a=(0,Ht.arrayUnique)([e].concat(t.select(jt.RECENT_SEARCH_OP))).slice(0,500);t.update(jt.RECENT_SEARCH_OP,a)}function St(e){e.update(jt.RECENT_SEARCH_OP,[])}function xt(e,t){var a=t.select(jt.RECENT_SEARCH_OP).filter(function(t){return t!==e});return t.update(jt.RECENT_SEARCH_OP,a),a}function Lt(e,t,a){var i=a.tabs[t],r=(0,Ut.getMessage)(a,t,e);return i.data.kicked||i.data.closed||r.kludges.source_act||(i.pinned=r),Promise.resolve(a)}function It(e,t){var a=t.tabs[e];return a.pinned=null,Promise.resolve(t)}function Ot(e,t,a,i){var n=(i.tabs[a],(0,Ut.getMessage)(e,a,t)),s=n.userId;return(0,Gt.oCacheGet)(i,s)?Promise.resolve(i):Se(r({},a,[s]),i)}Object.defineProperty(t,"__esModule",{value:!0}),t.getMessageLocalId=t.getPinnedMessage=t.unpinMessage=t.pinMessage=t.deleteDialog=t.markDialogAnswered=t.toggleDialogImportant=t.favMessage=t.toggleMutePeer=t.returnToChat=t.leaveChat=t.updateChatPhoto=t.addNewMember=t.updateChatTopic=t.flushHistory=t.sendTyping=t.searchLocalHints=t.searchTopConv=t.deliverSebastianovedMessage=t.deliverMessage=t.readLastMessages=t.ACTION_PRIORITIES=t.TYPING_PERIOD=void 0;var Mt=function(){function e(e,t){var a=[],i=!0,r=!1,n=void 0;try{for(var s,o=e[Symbol.iterator]();!(i=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);i=!0);}catch(c){r=!0,n=c}finally{try{!i&&o["return"]&&o["return"]()}finally{if(r)throw n}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.strHistory=f,t.updateBlockStates=h,t.loadPeer=p,t.restoreHistoryQueue=_,t.removeFailed=m,t.selectPeer=v,t.selectPeerOnMessage=C,t.changePeer=y,t.updateMentions=w,t.setActions=N,t.loadMoreHistory=T,t.loadLessHistory=F,t.createEmailChat=S,t.loadLongPollKey=x,t.loadLongPollTs=L,t.setMessageErrored=I,t.resendMessage=O,t.loadAdmins=R,t.sebastianovMessage=B,t.addMessage=D,t.markInboundMessagesAsRead=j,t.markOutboundMessagesAsRead=q,t.initTextStore=z,t.processFwd=U,t.mergeTabs=W,t.updateOnline=G,t.setTyping=V,t.waitTyping=K,t.addSelection=Y,t.cleanSelected=X,t.dropSelection=$,t.replaceMessage=J,t.saveMedia=Z,t.loadMedia=ee,t.replaceMediaAttachesStore=te,t.setCurrentSearchDate=ae,t.setCurrentSearch=ie,t.searchHints=re,t.searchHintsIndex=ne,t.localIndexToDialog=oe,t.preloadSearchIndex=ue,t.loadDialogs=le,t.searchMessages=de,t.isSearchAllLoaded=fe,t.isSearchingInplace=he,t.cancelSearch=pe,t.clearDate=_e,t.searchInplaceStart=me,t.searchMessagesInplace=ge,t.loadImportant=ve,t.removeMessages=be,t.removeMessageSend=Ce,t.removeMessagesWithRestore=ye,t.restoreMessage=we,t.restoreMessageSend=Ne,t.forwardMessages=Te,t.prepareForward=Fe,t.deletedDialog=ke,t.setChatTitle=Ee,t.loadChatMember=Se,t.checkNewPeople=xe,t.updateActions=Le,t.setMutedPeer=Ie,t.setExecStack=Oe,t.updateFavMessage=Me,t.updateImportant=Re,t.loadSpam=Pe,t.flushSpam=Ae,t.setCreationType=Be,t.getOwnerPhoto=De,t.presetAvatar=He,t.setChatPhoto=je,t.createChat=qe,t.resync=ze,t.chatUserHasJoined=Ue,t.chatUserHasLeft=We,t.toggleSendingAbility=Ge,t.setDelayedMessage=Ve,t.isAnythingLoading=Qe,t.updateUnreadCount=Ye,t.changeSubmitSettings=Xe,t.updateFavAndTitle=Je,t.saveHistoryScroll=Ze,t.filterFromTab=et,t.changeDialogsTab=tt,t.updateFolderState=nt,t.getMutexQueue=st,t.releaseBlock=ot,t.toggleCommunityMute=ct,t.restoreDialog=ut,t.spamDialog=lt,t.updateTabbedPeers=dt,t.isEverythingLoaded=ft,t.cleanTab=ht,t.stringifyTab=pt,t.updateGoToEndVisibility=_t,t.toggleCommunityMessages=mt,t.updateHistory=gt,t.startRecording=vt,t.cancelRecording=bt,t.setVoiceMessageAvail=Ct,t.toggleConversation=yt,t.updateSearchQuery=wt,t.initializeChatResize=Nt,t.joinChat=Tt,t.resetInviteLink=Ft,t.leaveInvitation=kt,t.saveRecentSearchPeer=Et,t.resetRecentSearch=St,t.removeFromRecentSearch=xt,t.pinMessageOptimistic=Lt,t.unpinMessageOptimistic=It,t.checkChatMember=Ot;var Rt=a(127),Pt=a(39),At=a(74),Bt=i(At),Dt=a(10),Ht=a(92),jt=a(42),qt=a(56),zt=a(94),Ut=a(14),Wt=a(102),Gt=a(97),Vt=a(7),Kt=a(49),Qt=t.TYPING_PERIOD=5,Yt=2e4,Xt=8,$t=(0,Pt.updateLazyLocation)(),Jt=$t.scheduleNav,Zt=$t.commitNav,ea=$t.scheduleNavWithTimeOut,ta=t.ACTION_PRIORITIES={block:1,fav:1,chat:2,invite:2,invite_link:3,topic:3,avatar:4,photos:5,search:6,pin_hide:7,pin_unhide:7,unpin:8,mute:10,unmute:10,clear:11,leave:12,"return":12,block_community:12,allow_community:12};t.readLastMessages=c(function(e,t){var a=t.tabs[e],i=Object.keys(a.msgs).map(function(a){return(0,Ut.getMessage)(t,e,a)}).filter(function(e){return!(0,Wt.isOut)(e)}).map(function(e){return e.messageId}).sort(function(e,t){return t-e});return a.skipped>0&&(i=i.filter(function(e){return intval(e)<=a.lastmsg-a.skipped})),i=intval(i.shift()),i<=a.in_up_to?Promise.resolve(t):(t.longpoll.push([Bt.readInboundEvent([6,e,i])]),(0,Rt.post)(Rt.CONTROLLER,{peer:e,ids:[i],hash:a.hash,act:"a_mark_read",gid:t.gid}).then(function(){return k(t,e,i,Bt.FLAG_OUTBOUND)}))}),t.deliverMessage=c(function(e,t,a){var i=Date.now()+rand(0,100).toFixed(0),r=a.tabs[e];return(0,Dt.retryFn)(Rt.post,1)(Rt.CONTROLLER,{act:"a_send",to:e,hash:r.hash,msg:t.message,media:Q(t.attaches),guid:i,share_url:t.share_url,random_id:t.rid,gid:a.gid,sticker_referrer:t.sticker_referrer},Yt).then(function(e){var t=Mt(e,1),i=t[0];return a.version!==i.version&&nav.reload({force:!0}),a})}),t.deliverSebastianovedMessage=c(function(e,t,a){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_edit_message",hash:e.hash,id:t.messageId,peerId:e.peerId,gid:a.gid,msg:t.origText,media:Q(t.attaches),share_url:t.share_url},Yt).then(function(e){var t=Mt(e,1);return t[0],a})}),t.searchTopConv=ce(function(e){return e.topConvTree}),t.searchLocalHints=ce(function(e){return e.hintsTree}),t.sendTyping=c(function(e,t){return t.tabs[e].lastTyping=Date.now(),(0,Rt.post)(Rt.CONTROLLER,{act:"a_typing",peer:e,gid:t.gid,hash:t.tabs[e].hash}).then(function(e){return t},function(e){return t})}),t.flushHistory=c(function(e,t){return ke(e,(0,Rt.post)("al_im.php",{act:"a_flush_history",id:e,from:"im",gid:t.gid,hash:t.tabs[e].hash}),t)}),t.updateChatTopic=c(function(e,t,a){var i=a.tabs[e];return(0,Rt.post)(Rt.CONTROLLER,{act:"a_get_chat",cur_peers:i.memberIds.join(","),cur_title:i.name,chat:e-2e9,new_title:t,hash:i.hash}).then(function(t){var r=Mt(t,2),n=(r[0],r[1]);return a.tabs[e]=extend(i,n),a})}),t.addNewMember=c(function(e,t,a){var i=a.tabs[e];return(0,Rt.post)(Rt.CONTROLLER,{act:"a_get_chat",cur_peers:i.memberIds.join(","),cur_title:i.name,chat:e-2e9,new_peer:t.join(","),hash:i.hash}).then(function(t){var r=Mt(t,2),n=r[0],s=r[1];return n.forEach(function(e){if(e.error)throw new Error(e.message)}),a.tabs[e]=extend(i,s),a})}),t.updateChatPhoto=c(function(e,t){return e.kludges.source_act===qt.CHAT_PHOTO_REMOVE?(delete t.tabs[e.peerId].photo,Promise.resolve(t)):(0,Rt.post)(Rt.CONTROLLER,{act:"a_get_chat_photo",msg_id:e.messageId}).then(function(a){var i=Mt(a,2),r=i[0],n=i[1];t.chat_photo_msg=n;var s=t.tabs[e.peerId];if(t.tabs[e.peerId].photo=r,(0,qt.isFullyLoadedTab)(t,e.peerId)){var o=e.kludges.source_act;s.history=(0,qt.addChatPhotoToUpdate)(e,o,t,u(s.history))}return t})}),t.leaveChat=c(function(e,t){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_leave_chat",chat:e-2e9,hash:t.tabs[e].hash}).then(Le.bind(null,qt.CHAT_KICK_USER,vk.id,e,t))}),t.returnToChat=c(function(e,t){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_return_to_chat",chat:e-2e9,hash:t.tabs[e].hash}).then(Le.bind(null,qt.CHAT_INVITE_USER,vk.id,e,t))}),t.toggleMutePeer=c(function(e,t,a){return(0,Rt.post)(Rt.CONTROLLER,{act:"a_mute",peer:e,hash:a.tabs[e].hash,gid:a.gid,value:t}).then(function(){var i=t?"mute":"unmute";return window.Notifier&&Notifier.lcSend("im",{act:i,peer:e}),a}).then(Ie.bind(null,e,t))}),t.favMessage=c(function(e,t,a,i){return Me(e,a,t,i),(0,Rt.post)(Rt.CONTROLLER,{act:"a_mark_important",ids:e,val:t?1:0,from:"im",gid:i.gid,peer:a,hash:i.tabs[a].hash}).then(function(e){return i})}),t.toggleDialogImportant=c(function(e,t){var a=zt.FOLDER_MASKS[zt.FOLDER_IMPORTANT],i=t.tabs[e].folders&a,r=i?Bt.resetDirectoriesEvent:Bt.setDirectoriesEvent;return t.longpoll.push([r([0,e,a,!0])]),(0,Rt.post)(Rt.CONTROLLER,{act:"a_dialog_star",val:i?0:1,peer:e,hash:t.tabs[e].hash,gid:t.gid}).then(function(){return t})}),t.markDialogAnswered=c(function(e,t,a){var i=zt.FOLDER_MASKS[zt.FOLDER_UNRESPOND];return a.longpoll.push([Bt.resetDirectoriesEvent([0,e,i,!0]),Bt.readInboundEvent([6,e,t])]),(0,Rt.post)(Rt.CONTROLLER,{act:"a_mark_answered",peer:e,lastmsg:t,hash:a.tabs[e].hash,gid:a.gid}).then(function(){return a})}),t.deleteDialog=c(function(e,t){return M(t,t.tabs[e],!0,function(t){return t.filter(function(t){return t!==e})}),t.tabs[e].deletedDialog=!0,(0,Rt.post)(Rt.CONTROLLER,{act:"a_delete_dialog",peer:e,gid:t.gid,hash:t.tabs[e].hash}).then(function(a){return a[0]?(dt(t.tabbedPeers.filter(function(t){return t.peer!==e}),!0,t),t.tabs[e].unread=0,t.tabs[e].lastmsg=!1,t.tabs[e].lastmsg_meta=null):(t.tabs[e].deletedDialog=!1,M(t,t.tabs[e],!1,A.bind(null,e),rt.bind(null,t))),a})}),t.pinMessage=c(function(e,t,a){var i=a.tabs[t];return i.data.kicked||i.data.closed?Promise.resolve(a):(0,Rt.post)(Rt.CONTROLLER,{act:"a_pin_message",msgid:e,chat:t,hash:a.tabs[t].hash}).then(function(e){var r=Mt(e,1),n=r[0];return a.tabs[t]=Object.assign({},i,n),(0,Kt.syncChatLocalIdWithPinned)(a.tabs[t]),a})}),t.unpinMessage=c(function(e,t){var a=t.tabs[e];return a.data.kicked||a.data.closed?Promise.resolve(t):(0,Rt.post)(Rt.CONTROLLER,{act:"a_unpin_message",chat:e,hash:t.tabs[e].hash}).then(function(i){var r=Mt(i,1),n=r[0];return t.tabs[e]=Object.assign({},a,n),t})}),t.getPinnedMessage=c(function(e,t){var a=t.tabs[e];return(0,Rt.post)(Rt.CONTROLLER,{act:"a_get_pinned_message",chat:e,hash:t.tabs[e].hash}).then(function(e){var i=Mt(e,1),r=i[0];return a.pinned=r||null,(0,Kt.syncChatLocalIdWithPinned)(a),t})}),t.getMessageLocalId=c(function(e,t,a){return a.tabs[e],(0,Rt.post)(Rt.CONTROLLER,{act:"a_get_message_local_id",chat:e,chat_local_id:t,hash:a.tabs[e].hash})})},function(e,t){"use strict";window.DesktopNotifications={supported:function(){return!(!window.webkitNotifications&&!window.Notification)},checkPermission:function(){return window.webkitNotifications?webkitNotifications.checkPermission():"granted"==Notification.permission?0:1},requestPermission:function(e){(window.webkitNotifications||window.Notification).requestPermission(e)},createNotification:function(e,t,a){var i=void 0;return window.webkitNotifications?i=webkitNotifications.createNotification(e,t,a):(i=new Notification(t,{icon:e,body:a}),i.cancel=function(){this.close()},i.show=function(){}),vk.id%100<10&&statlogsValueEvent("browser_notification",0),i}}},function(e,t){var a={}.toString;e.exports=function(e){return a.call(e).slice(8,-1)}},function(e,t,a){var i=a(25)("meta"),r=a(38),n=a(59),s=a(69).f,o=0,c=Object.isExtensible||function(){return!0},u=!a(80)(function(){return c(Object.preventExtensions({}))}),l=function(e){s(e,i,{value:{i:"O"+ ++o,w:{}}})},d=function(e,t){if(!r(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!n(e,i)){if(!c(e))return"F";if(!t)return"E";l(e)}return e[i].i},f=function(e,t){if(!n(e,i)){if(!c(e))return!0;if(!t)return!1;l(e)}return e[i].w},h=function(e){return u&&p.NEED&&c(e)&&!n(e,i)&&l(e),e},p=e.exports={KEY:i,NEED:!1,fastKey:d,getWeak:f,onFreeze:h}},function(e,t,a){"use strict";function i(e,t){if((0,v.unpackStore)(e).searchShown)return!1;var a=(0,v.getTab)(e,t),i=a&&a.pinned;return i?a.pinHideId!=(0,v.parserMessage)(i).chatLocalId:!1}function r(e){var t=(0,v.parserMessage)(e.pinned),a=t&&e.msgs[t.messageId];a&&(a.chatLocalId=t.chatLocalId,e.msgs[t.messageId]=a)}function n(e,t,a){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!0,r=(0,v.getTab)(e,t),n=r&&(0,v.parserMessage)(r.pinned);r&&n&&(r.pinHideId=n.chatLocalId,cur.imDb.update(C.PIN_HIDDEN_ID_OP,[r.peerId,r.pinHideId]),u(a,t,e),re(geByClass1("_im_pinned_tt")),i&&window.Notifier&&Notifier.lcSend("pin_hide",{hide:1,peer:t}))}function s(e,t,a){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!0,r=(0,v.getTab)(e,t);r&&(delete r.pinHideId,cur.imDb.update(C.PIN_HIDDEN_ID_OP,[r.peerId,void 0]),u(a,t,e),i&&window.Notifier&&Notifier.lcSend("pin_hide",{hide:0,peer:t}))}function o(e,t,a){var i=u.bind(null,a,t),r=(0,g.showUnpinDialog)(function(){r.hideProgress(),r.hide(),e.set(p.unpinMessageOptimistic.bind(null,t)).then(i).then(function(e){return e.set(p.unpinMessage.bind(null,t))}).then(i)})}function c(e,t,a){var i=e.get(),r=i.peer,s=(0,v.parserMessage)((0,v.getTab)(e,r).pinned);if(a.target.classList.contains(y))s&&n(e,r,t);else if("A"!==a.target.tagName){var o=s&&s.messageId;if(o&&!(0,g.isAlreadyDeleted)(e,r,o)){var c=e.get(),u=(0,v.getMessage)(e,r,o);u?(e.setState({msgid:o}),(0,b.updateLocation)({msgid:o}),t().focusOnMessage()):c.longpoll.push([(0,_.changePeer)(r,o)])}else(0,g.showPinnedBox)(e,t,r,m.mount,a)}}function u(e,t,a){return e().updateChatTopic(t,a),(0,p.setActions)(a.get()),e().updateActions(a),a}function l(e){showTooltip(e.target,{text:getLang("mail_hide_unpin_hover"),black:1,needLeft:1,shift:[8,4],forcetoup:!0,className:"_im_pinned_tt",appendEl:bodyNode})}function d(e){return{unmount:function(){(0,h.destroyModule)(e)}}}function f(e,t,a){var i=(0,h.createMutations)(d),r=(i.callMutations,i.bindMutations),n=c.bind(null,t,a),s=l.bind(null),o=(0,h.createModule)({handlers:function(t,a){a(e,"click",w,n),a(e,"mouseover",y,s)}});return r(o)}Object.defineProperty(t,"__esModule",{value:!0}),t.isPinnedMessageVisibleInTab=i,t.syncChatLocalIdWithPinned=r,t.pinnedMessageHide=n,t.pinnedMessageUnHide=s,t.pinnedMessageUnpin=o,t.mount=f;var h=a(44),p=a(45),_=a(74),m=a(40),g=a(56),v=a(14),b=a(39),C=a(42),y="_im_pin_hide",w="_im_pinned_message"},function(e,t,a){e.exports=!a(80)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(e,t,a){"use strict";var i=a(69).f,r=a(106),n=(a(96),a(130)),s=a(67),o=a(23),c=a(95),u=a(43),l=a(139),d=a(1),f=a(8),h=a(50),p=a(48).fastKey,_=h?"_s":"size",m=function(e,t){var a,i=p(t);if("F"!==i)return e._i[i];for(a=e._f;a;a=a.n)if(a.k==t)return a};e.exports={getConstructor:function(e,t,a,l){var d=e(function(e,i){o(e,d,t,"_i"),e._i=r(null),e._f=void 0,e._l=void 0,e[_]=0,void 0!=i&&u(i,a,e[l],e)});return n(d.prototype,{clear:function(){for(var e=this,t=e._i,a=e._f;a;a=a.n)a.r=!0,a.p&&(a.p=a.p.n=void 0),delete t[a.i];e._f=e._l=void 0,e[_]=0},"delete":function(e){var t=this,a=m(t,e);if(a){var i=a.n,r=a.p;delete t._i[a.i],a.r=!0,r&&(r.n=i),i&&(i.p=r),t._f==a&&(t._f=i),t._l==a&&(t._l=r),t[_]--}return!!a},forEach:function(e){o(this,d,"forEach");for(var t,a=s(e,arguments.length>1?arguments[1]:void 0,3);t=t?t.n:this._f;)for(a(t.v,t.k,this);t&&t.r;)t=t.p},has:function(e){return!!m(this,e)}}),h&&i(d.prototype,"size",{get:function(){return c(this[_])}}),d},def:function(e,t,a){var i,r,n=m(e,t);return n?n.v=a:(e._l=n={i:r=p(t,!0),k:t,v:a,p:i=e._l,n:void 0,r:!1},e._f||(e._f=n),i&&(i.n=n),e[_]++,"F"!==r&&(e._i[r]=n)),e},getEntry:m,setStrong:function(e,t,a){l(e,t,function(e,t){this._t=e,this._k=t,this._l=void 0},function(){for(var e=this,t=e._k,a=e._l;a&&a.r;)a=a.p;return e._t&&(e._l=a=a?a.n:e._t._f)?"keys"==t?d(0,a.k):"values"==t?d(0,a.v):d(0,[a.k,a.v]):(e._t=void 0,d(1))},a?"entries":"values",!a,!0),f(t)}}},function(e,t){"use strict";function a(e,t){var a=!1,i=this,r=void 0,n=void 0;if(!e)throw new Error("Undefined filename");t=t||{};try{n=ce("audio"),a=!!n.canPlayType,"no"!=n.canPlayType("audio/mpeg")&&""!=n.canPlayType("audio/mpeg")?r=".mp3?1":"no"==n.canPlayType('audio/ogg; codecs="vorbis"')||""==n.canPlayType('audio/ogg; codecs="vorbis"')||t.forceMp3?a=!1:r=".ogg?1"}catch(s){}var o=t.forcePath||"/"+e+r;if(a){n.src=o;var c=!1;n.addEventListener("ended",function(){c=!0},!0),n.load(),this.playSound=function(){c&&n.load(),n.play(),c=!1},this.pauseSound=function(){n.pause()}}else{cur.__sound_guid=cur.__sound_guid||0;var u=ge("flash_sounds_wrap")||utilsNode.appendChild(ce("span",{id:"flash_sounds_wrap"})),l="flash_sound_"+cur.__sound_guid++,d={url:"/swf/audio_lite.swf?4",id:l},f={swliveconnect:"true",allowscriptaccess:"always",wmode:"opaque"};if(renderFlash(u,d,f,{})){var h=browser.msie?window[l]:document[l],p=!1,_=setInterval(function(){if(h&&h.paused)try{h.setVolume(1),h.loadAudio(o),h.pauseAudio()}catch(e){debugLog(e)}p=!0,clearInterval(_)},300);i.playSound=function(){p&&h.playAudio(0)},i.pauseSound=function(){p&&h.pauseAudio()}}}}a.prototype={play:function(){try{this.playSound()}catch(e){}},pause:function(){try{this.pauseSound()}catch(e){}}},window.Sound=a},,function(e,t,a){var i=a(69).f,r=a(59),n=a(129)("toStringTag");e.exports=function(e,t,a){e&&!r(e=a?e:e.prototype,n)&&i(e,n,{configurable:!0,value:t})}},function(e,t,a){"use strict";var i=a(77),r={};r[a(129)("toStringTag")]="z",r+""!="[object z]"&&a(30)(Object.prototype,"toString",function(){return"[object "+i(this)+"]"},!0)},function(e,t,a){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t["default"]=e,t}function r(){var e=ls.get(qt);return e||0}function n(e){e>=window.clientHeight()-30&&(e=0),ls.set(qt,e)}function s(e,t){var a=geByClass1(e,t),i=a.firstElementChild.offsetHeight!==a.parentNode.offsetHeight;i&&setStyle(a.firstElementChild,{height:a.parentNode.offsetHeight})}function o(e,t){e&&e.innerHTML!==t&&(e.innerHTML=t)}function c(e,t){var a=window.devicePixelRatio>=2?"256":"128";return t?'<div class="im_sticker_row">\n      <a onmouseover="return Emoji.stickerOver('+intval(e)+', this);"\n        onclick="return Emoji.clickSticker('+intval(t)+', this, event);">\n          <img height="128"\n            class="im_gift"\n            src="/images/stickers/'+intval(e)+"/"+a+'.png"/>\n      </a>\n    </div>':'<div class="im_sticker_row">\n      <img height="128"\n        class="im_gift"\n        src="/images/stickers/'+intval(e)+"/"+a+'.png"/>\n    </div>'}function u(e,t,a){var i=e.get?e.get():e;if(x(i,t)){var r=i.tabs[t].deleted||[];return inArray(a,r)}return!1}function l(e,t,a){var i=a.randomId,r=geByClass1("_im_mess_rid"+i,t);return r&&(t=J([r],t),t=v(e,a,t,!0,!1)),t}function d(e){var t=(0,ut.checkVoiceMessageAvailable)(e);return"undefined"!=typeof t?Promise.resolve(t):f().then(function(e){return e.length>0})["catch"](function(e){return!1})}function f(){return window.AudioContext&&navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(function(e){for(var t=[],a=0;a<e.length;a++)"audioinput"==e[a].kind&&t.push(e[a]);return t}):Promise.reject(new Error("NotSupported"))}function h(e){return getTemplate("im_preloader",{preloader:rs(vk.pr_tpl,{id:""}),cls:"im-preloader_attach im-preloader_visible im-preloader_"+e})}function p(e){var t=e.split(".");return(t[0]<10?"0":"")+t[0]+(t[1]<10?"0":"")+t[1]+t[2]}function _(e){var t=geByClass1("_im_invisible_bar",e);t&&(removeClass(t,"_im_invisible_bar"),removeClass(t,"im-page--history-new-bar_hide"))}function m(e,t,a){var i=g(e,t),r=geByClass1("_im_mess_"+t.messageId,a);return r&&r.parentNode.replaceChild(se(i),r),a}function g(e,t){var a=["_im_mess"],i=(0,pt.isUnread)(e.tabs[t.peerId],t);(0,pt.isOut)(t)&&i&&a.push("im-mess_unread _im_mess_unread"),(0,pt.isOut)(t)&&a.push("im-mess_out"),(0,pt.wasSebastianoved)(t)&&a.push("im-mess_was_sebastianoved"),(0,wt.canMessageBeSebastianoved)(e,t)&&a.push("im-mess_sebastianovable"),(0,pt.isImportant)(t)&&a.push("im-mess_fav"),-1!=(e.selectedMessages||[]).indexOf(t.messageId)&&a.push("im-mess_selected");var r=Date.now()-1e3*t.date>1e3;t.local&&r&&a.push("im-mess_sending"),t.local&&a.push(""+Nt),t.local&&(0,pt.wasSebastianoved)(t)&&!i&&a.push("im-mess_unread im-mess_nobg"),t.failed&&a.push("im-mess_failed "+Tt),(0,pt.isGift)(t)&&a.push("im-mess_gift");var n=t.attaches.map(function(e){return"sticker"===e.type?c(e.id,e.productId):h(e.type)}),s=R(t.text,t.kludges);""!=s&&(0,pt.wasSebastianoved)(t)&&(s+=getTemplate("sImLblWasSebastianoved",{moreCls:"is_inline"})),t.subject&&"..."!==t.subject.trim()&&!k(t.peerId)&&(s=getTemplate("im_topic",{topic:t.subject})+s);var o=getTemplate("im_message_media",{messageId:t.messageId,attaches:n.join(""),text:(0,pt.isGift)(t)?'<div class="im-mess--gift-lbl">'+s+"</div>":""});return(0,pt.isGift)(t)||(o=s+o),""==s&&(0,pt.wasSebastianoved)(t)&&(o+=getTemplate("sImLblWasSebastianoved",{moreCls:""})),getTemplate("im_msg_row",{msg_id:t.messageId,from_id:t.peerId,text:o,aria_hidden:t.local&&!t.failed?"true":"false",ts:t.date,marker_params:t.failed?'aria-label="'+getLang("mail_send_message_error")+'" role="link"':"",unread_params:i?'aria-label="'+getLang("mail_unread_message")+'" role="link" tabindex="0"':"",cls:a.join(" ")})}function v(e,t,a){var i=(arguments.length>3&&void 0!==arguments[3]?arguments[3]:!0,arguments.length>4&&void 0!==arguments[4]?arguments[4]:!0),r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:!0,n=Date.now()-1e3*t.date>1e3,s=e.tabs[t.peerId];if(geByClass1("_im_mess",a)||geByClass1("_im_bar_date",a)||(a.innerHTML=""),s.skipped>0)return a;var o=[];t.local||(o=e.imQueue(t.peerId,i)),o.length>0&&J(o.map(function(e){return geByClass1("_im_mess_rid"+e.rid,a)},a).filter(function(e){return e}));var c=g(e,t),u=domLC(a);hasClass(u,"_im_mess_stack")||(u=domClosestSibling(u,"._im_mess_stack",-1));
var l=(0,ut.getLastMessage)(e,t.peerId,t.messageId),d=geByClass1("_im_unread_bar_row",a),f=(0,pt.getUserId)(t),h=l?I(l.date,e):0;if(!l||O(s,l,t,e,r)){var p="",_=!1;if(d&&(0,pt.isOut)(t)&&je(e,a,t.peerId),1===s.unread&&!(0,pt.isOut)(t)&&r&&(p+=getTemplate("im_mess_bar",{}),_=!0,je(e,a,t.peerId)),!isToday(new Date(h))){var m=new Date,v=_?"im-page--history-new-bar_hide _im_invisible_bar":"";p+=getTemplate("im_day_bar",{day:getShortDate(t.date,e.timeshift,!0,getLang("months_of","raw"),!0),date:t.date,day_class:m.getDate()+m.getMonth()+m.getFullYear()+" "+v})}if(oe(t))p+=getTemplate("im_service_row",{text:ue(e,t,s),type:"",date:t.date,from_id:"",message_id:t.messageId});else{var C=e.gid&&(0,pt.isOut)(t)?intval(t.kludges.from_admin)||0:0,y=(0,bt.oCacheGet)(e,C?-e.gid:f)||s,w=k(t.peerId)?y.name:y.first_name,N=y.link||s.href,T=getTemplate("im_mess_stack_name",{name:w,link:N,"class":(0,pt.isMoney)(t)?" im-mess-stack--lnk-money-transfer":""});if((0,pt.isGift)(t)){var F=getLang("mail_gift_message_sent","raw");T+=' <span class="im-mess-stack--gift">'+langSex(y.sex||0,F)+"</span>"}if((0,pt.isMoney)(t)){var E=(0,pt.isMoneyRequest)(t)?getLang("mail_money_request_message_sent","raw"):getLang("mail_money_tranfer_message_sent","raw");T+=' <span class="im-mess-stack--money-transfer">'+langSex(y.sex||0,E)+"</span>"}t.attaches[0]&&"chronicle_invite"===t.attaches[0].type&&(T+=" "+getLang("mail_chronicle_invite_inf"));var S=e.gid?"/gim"+e.gid:"/im",x=void 0;if(x=t.local?M(t.date,e.timeshift):getTemplate("im_stack_date",{date:M(t.date,e.timeshift),link:S+"?sel="+t.peerId+"&msgid="+t.messageId}),C&&e.admins[C]){var L=e.admins[C],R=C===vk.id?getLang("mail_by_you"):L[0];x=x+" "+getTemplate("im_admin_link",{name:R,href:L[1]})}p+=getTemplate("im_mess_stack",{photo:y.photo,href:N,cls:"",date_attr:"",link:"/im?sel="+t.peerId+"&msgid="+t.messageId,name:stripHTML(T),stack_name:T,peerId:f,date:x,messages:c,admin:t.kludges.from_admin||0})}(0,vt.toArray)(sech(p)).forEach(function(e){return a.appendChild(e)})}else d&&e.peer===t.peerId&&!s.inplaceSearch&&(0,pt.isOut)(t)&&je(e,a,t.peerId),geByClass1("_im_stack_messages",u).appendChild(se(c));return(0,pt.isOut)(t)&&!n&&setTimeout(function(){var e=geByClass1("_im_mess_"+t.messageId,a);hasClass(e,Nt)&&addClass(e,"im-mess_sending")},500),o=o.filter(function(e){return e.rid!==t.randomId}),b(o,e,a)}function b(e,t,a){var i;return i="object"===("undefined"==typeof e?"undefined":ct(e))?e:t.imQueue(e,!1),i.length>0&&i.map(function(e){return e.mess.failed=!!e.failed,e.mess}).filter(function(e){return(0,ut.getMessage)(t,e.peerId,e.messageId)}).forEach(function(e){return v(t,e,a,!1)}),a}function C(e){var t=geByClass1("_im_mess_blind_unread_marker",e);t&&(t.removeAttribute("aria-label"),t.removeAttribute("role"),t.removeAttribute("tabindex"))}function y(e,t,a){var i=e.tabs[t];return(0,vt.toArray)(geByClass("_im_mess_unread",a)).forEach(function(e){var t=intval(domData(e,"msgid"));t>0&&i.out_up_to>=t&&(removeClass(e,"_im_mess_unread"),removeClass(e,"im-mess_unread"),C(e))}),a}function w(e,t,a){var i=geByClass1("_im_msg_media"+t.messageId,e);return i&&(i.innerHTML=a.tabs[t.peerId].mediacontent[t.messageId][0]),e}function N(e,t){if(!(0,ut.isFullyLoadedTab)(t,e.peerId))return 0;var a=t.tabs[e.peerId];return a.msgs[e.messageId]?1:a.msgs["rid"+e.randomId]?2:0}function T(e){return 0==e?!0:!1}function F(e){return e>0&&2e9>e}function k(e){return e>2e9}function E(e){return-2e9>e}function S(e,t){return e===t.peer}function x(e,t){return e.tabs[t]?!0:!1}function L(e,t){return x(e,t)?null!==e.tabs[t].lastmsg:!1}function I(e,t){return 1e3*e+1e3*t.timeshift}function O(e,t,a,i,r){if((0,pt.getUserId)(t)!==(0,pt.getUserId)(a))return!0;var n=I(t.date,i),s=I(a.date,i);return isSameDate(n,s)?(0,ut.isCommunityInterface)(i)&&intval(t.kludges.from_admin)!==intval(a.kludges.from_admin)?!0:a.date-t.date>300?!0:oe(t)||oe(a)?!0:(0,pt.isGift)(t)||(0,pt.isGift)(a)?!0:(0,pt.isGraffiti)(t)||(0,pt.isGraffiti)(a)?!0:(0,pt.isUnread)(e,t)!==(0,pt.isUnread)(e,a)&&r&&!(0,pt.isOut)(a)?!0:!1:!0}function M(e,t){return langDate(1e3*e,"{hour}:{minute} {am_pm}",1e3*t,[],!0)}function R(e,t,a){return e=(0,_t.replaceHyperLinks)(e||"",_t.linksReplacer.bind(null,a)),e=(0,_t.replaceMentions)(e),e=(0,_t.replaceEmailLinks)(e),t.emoji&&(e=Emoji.emojiToHTML(e,!0)),e}function P(e){return k(e)?"c"+(e-2e9):E(e)?"e"+Math.abs(e+2e9):e}function A(e){var t=e.substr(0,1);switch(t){case"e":return-2e9-intval(e.substr(1));case"c":return 2e9+intval(e.substr(1));default:return intval(e)}}function B(e){return e>9999999?Math.floor(e/1e6)+"M":e>9999?Math.floor(e/1e3)+"K":e>0?e.toString():""}function D(e){return{search:{name:getLang("mail_im_peer_search"),icon:"search"},block_community:{icon:"block",name:getLang("mail_block_comm_messages")},allow_community:{icon:"unblock",name:getLang("mail_allow_comm_messages")},clear:{name:e.peer<-2e9?getLang("mail_im_delete_email_contact"):getLang("mail_im_delete_all_history"),icon:"clear"},chat:{name:getLang("mail_im_create_chat_with"),icon:"invite"},mute:{name:getLang("mail_im_mute"),icon:"mute"},unmute:{name:getLang("mail_im_unmute"),icon:"unmute"},photos:{name:e.gid?getLang("mail_im_show_media_history_group"):getLang("mail_im_show_media_history"),icon:"media"},avatar:{icon:"avatar",name:getLang("mail_update_photo_red")},block:{icon:"block",name:getLang("mail_block_user")},invite:{icon:"invite",name:getLang("mail_im_create_chat_with")},invite_link:{icon:"invite-link",name:getLang("mail_chat_invite_link")},leave:{icon:"leave",name:getLang("mail_leave_chat")},topic:{icon:"topic",name:getLang("mail_change_topic")},"return":{icon:"return",name:getLang("mail_return_to_chat")},pin_hide:{icon:"pin_hide",name:getLang("mail_menu_pin_hide")},pin_unhide:{icon:"pin_unhide",name:getLang("mail_menu_pin_show")},unpin:{icon:"unpin",name:getLang("mail_menu_unpin")}}}function H(e,t){var a='<img src="'+e+'" alt="" class="dialogs_inline_chatter dialogs_inline_chatter_half"/>';return t&&(a=getTemplate("im_dialogs_link",{href:t,photo:a})),'<div class="im_grid">\n    <div class="dialogs_inline_chatter dialogs_inline_chatter_half">\n      '+a+"\n    </div>\n  </div>"}function j(e,t){var a='<img src="'+e+'" alt="" class="dialogs_inline_chatter"/>';return t&&(a=getTemplate("im_dialogs_link",{href:t,photo:a})),'<div class="im_grid">\n    <div class="dialogs_inline_chatter">\n      '+a+"\n    </div>\n  </div>"}function q(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if("string"==typeof e)return'<div class="im_grid"><img src="'+e+'" alt=""/></div>';switch(e.length){case 1:return'<div class="im_grid"><img src="'+e[0]+'" alt=""/></div>';case 2:return e.map(function(e,a){return H(e,t[a])}).join("");case 3:return H(e[0],t[0])+e.slice(1).map(function(e,a){return j(e,t[a+1])}).join("");case 4:return e.map(function(e,a){return j(e,t[a])}).join("")}}function z(e,t,a){if("string"==typeof t.photo&&t.photo)return'<div class="im_grid">\n      <img src="'+t.photo+'" alt="" />\n    </div>';if(t.memberIds&&t.memberIds.length<2)return'<div class="im_grid">\n      <img src="'+e.get().default_chat_photo+'" alt="" />\n    </div>';if(Array.isArray(t.photo))return q(t.photo);var i=(t.data.active||t.memberIds.filter(function(e){return e!=vk.id}).slice(0,4)).map(bt.oCacheGet.bind(null,e)),r=i.map(function(e){return e.photo}),n=a?[]:i.map(function(e){return e.link});return q(r,n)}function U(e){var t=e.get().gid?getLang("mail_search_only_messages_comm"):getLang("mail_search_only_messages");return'<li class="im-page--mess-search-w">\n    <div class="im-page--mess-search '+Bt+'">\n      <button type="button" class="im-i--messages-search"></button>'+t+"\n    </div>\n  </li>"}function W(){return'<li class="im-search-results-head">'+getLang("mail_search_messages")+"</li>"}function G(){return'<li class="im-search-results-head">'+getLang("mail_search_conversations_sep")+"</li>"}function V(){return'<li class="im-search-results-head">'+getLang("mail_search_dialogs_sep")+"</li>"}function K(){return'<li class="im-search-results-head _im_recent_bar">\n    '+getLang("mail_recent_searches")+'\n    <button type="button" class="'+At+' im-page--clear-recent">'+getLang("mail_clear_recent")+"</button>\n  </li>"}function Q(e){var t=e.get().popular_sugg,a=(0,ut.isClassicInterface)(e)?8:5;return t.length>a&&(t=t.slice(0,a)),'<li class="im-popular clear_fix">'+t.map(function(t){var a=t.peerId,i=(0,bt.oCacheGet)(e,a)||t,r=e.get().tabs[a]||t,n=(e.get().mutedPeers||[]).indexOf(a)>=0;return'<div class="im-popular--item fl_l _im_dialog _dont_add_recent _im_sugg_'+a+" "+(r.unread>0?"sugg-is_unread":"")+" "+(n?"sugg-is_muted":"")+'" data-peer="'+a+'">\n    <a class="im-popular--avatar-w '+onlinePlatformClass(r.online)+'" href="'+i.link+'"><img class="im-popular--avatar" src="'+i.photo+'"/></a>\n    <div class="im-popular--name-w"><a class="im-popular--name" href="'+i.link+'">'+(i.first_name||i.name)+'</a></div>\n    <span class="im-popular--unread _sugg_unread_ct">'+B(r.unread)+"</span>\n</div>"}).join("")+"</li>"}function Y(e,t,a){var i=geByClass1("_im_mess_"+t.messageId,a);if(i){attr(i,"aria-hidden","false"),addClass(i,"im-mess_failed "+Tt);var r=geByClass1("_im_mess_marker",i);attr(r,"aria-label",getLang("mail_send_message_error")),attr(r,"role","link")}return a}function X(e,t,a){var i=geByClass1("_im_mess_"+t,a);if(i){removeClass(i,"im-mess_failed"),attr(i,"aria-hidden","true"),removeClass(i,Tt);var r=geByClass1("_im_mess_marker",i);attr(r,"aria-label",""),attr(r,"role","")}return a}function $(e,t){var a=e.map(function(e){return geByClass1("_im_mess_"+e,t)}).filter(function(e){return e});return J(a,t)}function J(e,t){var a=e.filter(function(e){return!hasClass(e,"im-mess_srv")}).map(function(e){return e.parentNode});return e.forEach(function(e){return e.parentNode.removeChild(e)}),a.filter(function(e){return 0===domChildren(e).length}).map(function(e){return gpeByClass("_im_mess_stack",e)}).forEach(function(e){var t=domPS(e);hasClass(t,"_im_bar_date")&&re(t),re(e)}),t}function Z(e,t,a,i){return e.map(function(e){return geByClass1("_im_mess_"+e,i)}).filter(function(e){return e}).forEach(function(e){val(e,ie(t,e,a)),addClass(e,"im-mess_light")}),i}function ee(e,t,a){var i=geByClass1("_im_mess_"+e,a);if(i){var r=geByClass1(Ft,i);val(i,r.innerHTML),removeClass(i,"im-mess_light")}return a}function te(e,t,a,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:2,n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:!1;if(n)return ae(e,t,a,i,!0,r);var s=((0,ut.isClassicInterface)(i),60),o=ae(e,t,a,i,!1,r);return o.length>s?ae(e,t,a,i,!0,r):o}function ae(e,t,a,i,r){var n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:2;if(i.tabs[t],!e)return"";var s=Object.keys(e).sort(function(t,a){return e[a]-e[t]});if(0===s.length)return"";if(s.length>10&&(0,Ct.imWeirdLog)("too_much_typers",{nTypers:s.length,typers:e,peer:t,tabName:i.tabs[t].tab,typersJson:JSON.stringify(e)}),F(t)||(0,ut.isCommunityPeer)(t)){var o=a?"":(0,bt.oCacheGet)(i,t).first_name;return o+" "+getLang("mail_typing")}var c=getLang("mail_typing_several",s.length),u=s.slice(0,s.length>n?n:n-1).filter(function(e){return(0,bt.oCacheExists)(i,e)}),l=r?"short_name":"name",d=u.map(function(e){return(0,bt.oCacheGet)(i,e)[l]}).join(", ");if(s.length>n){var f=s.length-n;d+=" "+getLang("mail_and_peer").replace("{count}",f).replace("{typing}",c)}else{var h=!!d,p=void 0;h&&s[n-1]&&(d+=" "+getLang("mail_and_peer_one")+" "),p=h&&s.length!==n||!s[n-1]?"":(0,bt.oCacheGet)(i,s[n-1])[l],d+=p+" "+c}return d}function ie(e,t,a){var i=t.innerHTML,r="delete"===a?"mail_deleted_stop":"mail_marked_as_spam";return'<div class="im-mess--text">\n    '+getLang(r)+' <button type="button" data-peer="'+e+'" class="'+kt+' im-mess--btn">'+getLang("mail_restore")+'</button>\n    <div class="'+Ft+' im-mess--original">'+i+"</div>\n  </div>"}function ne(){return'<div class="im-page--chat-search-empty">\n    '+getLang("mail_im_search_empty")+"\n  </div>"}function oe(e){return e.kludges&&"undefined"!=typeof e.kludges.source_act}function ce(e,t,a){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";return a?'<a class="im_srv_lnk '+i+'" target="_blank" href="'+e+'">'+t+"</a>":'<span class="'+i+'">'+t+"</span>"}function ue(e,t,a){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!0,r=t.kludges,n=r.source_act,s=intval(r.source_mid),o=t.userId,c=(0,bt.oCacheGet)(e,o),u="",l=o===s;switch(n){case Et:u="mail_im_chat_created";break;case St:u="mail_im_title_updated_dot";break;case xt:u=l?"mail_im_returned_to_chat":"mail_im_invited";break;case Lt:u=l?"mail_im_left":"mail_im_kicked_from_chat";break;case It:u="mail_im_photo_set";break;case Ot:u="mail_im_photo_removed";break;case Mt:u=r.source_message?"mail_im_pin_message":"mail_im_pin_message_empty2";break;case Rt:u=r.source_message?"mail_im_unpin_message":"mail_im_unpin_message_empty2";break;case Pt:u="mail_im_invite_by_link";break;default:return"mail_no_support"}if(u=langSex(c.sex,getLang(u,"raw")),u=u.replace("{from}",ce(c.link,c.name,i)),s&&s!==o){var d=r.source_email;if(d)u=u.replace("{user}",ce("/im?email="+encodeURIComponent(d),"email",i));else{var f=(0,bt.oCacheGet)(e,s),h=n===Lt?f.inv_name:f.kick_name;u=u.replace("{user}",ce(f.link,h,i))}}if(r.source_text){var p=r.source_old_text?'«<b class="im_srv_lnk">'+r.source_old_text+"</b>» &rarr; ":"";u=u.replace("{title}",p+('«<b class="im_srv_lnk">'+r.source_text+"</b>»"))}if(r.source_act===Mt||r.source_act===Rt)if(r.source_message){var _=de(Emoji.emojiToHTML(stripHTML(r.source_message.replace(/<br\s?\/?>/gi," ")),!0)),m=ce("",_,!1,"im_srv_mess_link");u=u.replace("{msg}",m)}else u=u.replace(/{link}(.+){\/link}/i,function(e,t){return ce("",t,!1,"im_srv_mess_link")});return u}function le(e,t,a,i){if(t===It){var r=geByClass1("_im_mess_"+e.messageId,i);if(r){var n=a.tabs[e.peerId];r.parentNode.innerHTML=getTemplate("im_msg_row",{msg_id:e.messageId,from_id:e.peerId,text:ue(a,e,n)+a.chat_photo_msg,ts:e.date,cls:"im-mess_srv"})}}return i}function de(e){return e.replace(/&lt;&lt;/g,"&laquo;").replace(/&gt;&gt;/g,"&raquo;").replace(/ \-\-/g," &mdash;").replace(/\-\- /g,"&mdash; ").replace(ht.MENTION_RAW,"$1$4")}function fe(e,t){return t?!1:e===vk.id}function he(e,t){return showTooltip(e,{url:(0,ut.isCommunityPeer)(t)?"al_groups.php":"al_profile.php",params:{act:"verified_tt",mid:t,gid:t},slide:15,ajxdt:200,showdt:200,hidedt:200,dir:"auto",shift:[94,7,7],className:"verified_tt"})}function pe(e){return function(t){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"bottom",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=se(getTemplate("im_preloader",{preloader:rs(vk.pr_tpl,{id:""}),cls:["bottom"===a?"im-preloader_bottom":"im-preloader_top",i].join(" ")})),n=!1;setTimeout(function(){n||("bottom"===a?e.appendChild(r):e.insertBefore(r,domFC(e)),addClass(r,"im-preloader_visible"))},0),t.then(function(){n=!0,removeClass(r,"im-preloader_visible"),r.parentNode&&r.parentNode.removeChild(r)})}}function _e(e,t){return{0:{msgs:e.reduce(function(e,t){return e[t]=[t,dt.FLAG_IMPORTANT,0,0,"","",{},0],e},{}),hash:t,history:1}}}function me(e,t){var a=e;if(!t&&!a)return!1;var i=a.target||a.srcElement,r=jt,n=!1,s=/_im_mess|im_log_act|im_log_ract|_im_log_body|im_log_rspacer|_im_graffiti_w|_wall_post_cont/;do if(!i||i.onclick||i.onmousedown||"A"==i.tagName||hasClass(i,"_im_no_select")||hasClass(i,"im_msg_media_link")||"IMG"==i.tagName&&!hasClass(i,"_im_graffiti")&&!hasClass(i,"emoji")&&!hasClass(i,"emoji_css")&&!hasClass(i,"im_gift")||"TEXTAREA"==i.tagName||hasClass(i,"play_new")||hasClass(i,"videoplayer")||(n=s.test(i.className)))break;while(r--&&(i=i.parentNode));if(!n)return!0;var o=trim((window.getSelection&&window.getSelection()||document.getSelection&&document.getSelection()||document.selection&&document.selection.createRange().text||"").toString());return o?!0:!1}function ge(e,t){return'<div class="im-mess--text">\n      <span>'+getLang("mail_restored")+'</span>\n      <a class="_im_go_to" href="/im?sel='+P(e)+"&msgid="+t+'">'+getLang("mail_im_goto_conversation")+"</a>\n    </div>"}function ve(e,t){var a=k(e)?getLang("mail_chat_sure_to_delete_all"):(0,ut.isCommunityPeer)(e)?getLang("mail_group_sure_to_delete_all"):getLang("mail_sure_to_delete_all");return showFastBox({title:getLang("mail_deleteall1"),dark:1,bodyStyle:"padding: 20px; line-height: 160%;"},a,getLang("mail_delete"),t,getLang("global_cancel"))}function be(e){return showFastBox({title:getLang("mail_unpin_title"),dark:1,bodyStyle:"padding: 20px; line-height: 160%;"},getLang("mail_unpin_text"),getLang("mail_unpin"),e,getLang("global_cancel"))}function Ce(e,t,a,i,r){t.showProgress(),e.set(i.bind(null,r)).then(function(){t.hideProgress(),t.hide(),a().removePeer(e,r),a().updateDialogFilters(e)})}function ye(e,t,a,i,r){var n=e.get().peer;cancelEvent(i),showBox("al_im.php",{act:"a_show_members_box",chat:n-2e9},{stat:["boxes.css"],params:{dark:1},onDone:function(i,r){var n=(0,gt.createModule)({handlers:function(r,s){s(i.bodyNode.parentNode,"click","_im_invite_box",function(){i.hide(),we(e,e.get().peer,t,a),(0,gt.destroyModule)(n)}),s(i.bodyNode.parentNode,"mouseover","im_status_mob_onl",function(e,t){var a=geByClass1("_im_chat_members_w",i.bodyNode.parentNode),r=160,n=gpeByClass("_im_member_item",t),s=n.offsetTop-a.scrollTop+r,o=s>370;mobileOnlineTip(t,{was:intval(domData(t,"was")),mid:intval(domData(t,"peer")),vk_mobile:intval(domData(t,"vk_mobile")),forcetoup:o})})}})}},i)}function we(e,t,a,i){var r=e.get().tabs[t],n=r.memberIds.filter(function(e){return-1===r.inactiveIds.indexOf(e)});e.set(i.bind(null,"add_member",n)).then(a().showCreation)}function Ne(e,t,a){if(e.get().active_tab===ht.FOLDER_ALL&&0===e.get().unread_cnt)return!1;var i=e.get().active_tab===ht.FOLDER_ALL?ht.FOLDER_UNREAD:ht.FOLDER_ALL;return e.set(a.bind(null,i)).then(function(e){t().restoreDialogs(e,!0)})}function Te(e,t,a,i){if(t.get().active_tab===e)return Promise.resolve(t);var r=(0,ut.isReversedDialogs)(t);return t.set(i.bind(null,e)).then(function(e){return a().restoreDialogs(e,!0,r!==(0,ut.isReversedDialogs)(e)),e})}function Fe(e,t){"undefined"==typeof t&&(t=e.get().peer);var a=e.get().tabs[t];return ht.FOLDER_MASKS[ht.FOLDER_IMPORTANT]&a.folders}function ke(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1;if("undefined"==typeof t&&(t=e.get().peer),!(0,ut.isFoldersAvailable)(e))return!1;var i=a||e.get().tabs[t];return ht.FOLDER_MASKS[ht.FOLDER_UNRESPOND]&i.folders}function Ee(e,t){return(t.get().block_states[e]||{}).free===!1}function Se(e){return null!=e.get().pendingForward}function xe(e,t){return(t.get().block_states[e]||{}).who===vk.id}function Le(e,t){var a=e.get().block_states;Object.keys(a).forEach(function(i){a[i].time?a[i].free===!1&&Date.now()-a[i].time>=5e4&&t.push([dt.mutexEvent([,1,"gim"+e.get().gid,i,0,""])]):a[i].time=Date.now()})}function Ie(e,t,a){var i;return!showTabbedBox("al_im.php",{act:"a_spam",offset:"0",gid:e.get().gid},{onDone:function(a,r){r&&(i=t(a,e,r))},params:{width:638,onHide:function(){AudioMessagePlayer.loaded&&AudioMessagePlayer.detachPlayer(!0),i.unmount()}}},a)}function Oe(e,t){var a=(0,ut.getTab)(e,t).last_seen;if(a[0])return 2===a[2]?'<span class="is_vk_mobile is_online">'+getLang("mail_header_online_status")+Me(t,!1,!0)+"</span>":"online"+(mobPlatforms[a[0]]?Me(t):"");if(!a[1])return"";var i=getDateText(a[1],e.get().timeshift),r=langSex((0,bt.oCacheGet)(e,t).sex,getLang("mail_last_activity_tip","raw")).replace("{user}","").replace("{time}",i);return 2===a[2]?r+=Me(t,!1,!0):a[2]&&(r+=Me(t,!1)),r}function Me(e,t,a){var i=a?"":'onclick="mobilePromo();"',r=a?", vk_mobile: 1":"",n=a?" vk_mobile":"";return getTemplate("im_wrap_mobile",{"class":"im_status_mob_onl"+n,params:"mid: "+e+", was: 1,"+(t?"forcetoup: true":"forcetodown: true")+r,attrs:i})}function Re(e,t){var a=t.get().tabs[e];return showBox("al_settings.php",{act:"blacklist_box",q:a.href},{stat:["settings.js","settings.css"],dark:1})}function Pe(e,t){return showBox("groupsedit.php",{act:"bl_edit",name:"/id"+e,gid:t.get().gid},{stat:["page.css","ui_controls.js","ui_controls.css"],dark:1})}function Ae(e){return e.get().gid?"/gim"+e.get().gid:"/im"}function Be(e,t,a,i){var r;return!showTabbedBox("al_im.php",{act:"a_important",offset:"0"},{onDone:function(i,n){n&&(r=a(i,e,t,n))},params:{width:638,onHide:function(){AudioMessagePlayer.loaded&&AudioMessagePlayer.detachPlayer(!0)},onDestroy:function(){r&&r.unmount()}}},i)}function De(){return"INPUT"===document.activeElement.tagName||"TEXTAREA"===document.activeElement.tagName||document.activeElement.getAttribute("contenteditable")}function He(e,t,a){var i=geByClass1("_im_mess_"+e,a);return i&&toggleClass(i,"im-mess_fav",t),a}function je(e,t,a){var i=geByClass1("_im_unread_bar_row",t);if(!i)return t;var r=domClosestSibling(i,"._im_mess_stack",-1),n=domClosestSibling(i,"._im_mess_stack"),s=r?geByClass("_im_mess",r).pop():null,o=n?geByClass1("_im_mess",n):null;if(re(i),_(t),!o||!s)return t;var c=domData(s,"msgid"),u=domData(o,"msgid"),l=(0,ut.getMessage)(e,a,c),d=(0,ut.getMessage)(e,a,u);if(O(e.tabs[a],l,d,e))return t;var f=geByClass1("_im_stack_messages",r),h=geByClass1("_im_stack_messages",n).children;return(0,vt.toArray)(h).forEach(function(e){re(e),f.appendChild(e)}),re(n),t}function qe(e,t,a){var i=(0,ut.getFirstUnread)(e,e.get().peer);if(!i)return[!1,0];var r=geByClass1("_im_mess_"+i,t);if(!r){var n=(0,ut.getLastMessage)(e,e.get().peer,i);if(!n)return[!0,0];r=geByClass1("_im_mess_"+n.messageId,t)}var s=hasClass(r,"_im_mess_srv")?r:gpeByClass("_im_mess_stack",r);if(!s)return[!0,0];var o=r?r.offsetTop:0,c=s.offsetTop+o,u=a.contHeight();return c<=a.scrollTop()+a.getScrollHeight()?[!0,0]:[!1,Math.max(0,u-c)]}function ze(e,t,a){cancelEvent(t);var i=gpeByClass("_im_top_notice",a);fadeOut(i,200,re.pbind(i));var r=gpeByClass("_im_page_dialogs",i);r&&hasClass(r,"im-page--dialogs-notice")&&removeClass(r,"im-page--dialogs-notice"),ajax.post("al_im.php",{act:"a_hide_top_notice",type:i.getAttribute("data-type"),hash:i.getAttribute("data-hash")})}function Ue(e,t,a){cancelEvent(t);var i=gpeByClass("_im_aside_notice",a);slideUp(i,200,re.pbind(i)),ajax.post("al_im.php",{act:"a_hide_top_notice",type:i.getAttribute("data-type"),hash:i.getAttribute("data-hash")})}function We(e,t,a,i,r){return a=a.replace(/\<br\s*\/?\>(\n)?/gi," ").replace(/[\n\r]/gi," "),a=(0,_t.replaceMentions)(a,function(e,t,a,i,r){return r}),i&&(a=Emoji.emojiToHTML(a,!0)),t&&"..."!==t.trim()&&!k(e)&&(a=getTemplate("im_topic",{topic:t,cls:"im-topic_dialog"})+a),!a&&r.length>0&&(a=getTemplate("im_dialog_media",{name:Qe(r[0],r)})),a}function Ge(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=e.split("_"),i=ot(a,2),r=i[0],n=i[1];return[r,n,t]}function Ve(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(i>50)return[[],e.length];for(var r=[],n=!1;a<e.length;){var s=e[a];if("id"===s)n=t[a];else if(","===s&&n)r.push(Ge(n)),n=!1;else if("("===s){var o=Ve(e,t,a+1,i+1),c=ot(o,2),u=c[0],l=c[1];a=l,r.push(Ge(n,u)),n=!1}else if(")"===s)return n!==!1&&r.push(Ge(n)),[r,a];a++}return n&&r.push(Ge(n)),[r,a]}function Ke(e){if(zt[e])return zt[e];for(var t=e?e.length:0,a=[],i=[],r="",n=0;t>n;n++){var s=e[n],o=s.charCodeAt(0);o>=48&&57>=o||"_"===s||"-"===s?r+=s:("("===s||")"===s||":"===s||","===s)&&(""!==r&&(i.push(r),a.push("id"),r=""),i.push(s),a.push(s))}r.length>0&&(i.push(r),a.push("id"));var c=Ve(a,i),u=ot(c,1),l=u[0];return Object.keys(zt).length>300&&(zt={}),zt[e]=l,l}function Qe(e,t){var a={photo:getLang("mail_added_photos","raw"),video:getLang("mail_added_videos","raw"),audio:getLang("mail_added_audios","raw")};switch(e.type){case"mail":return langNumeric(e.object.fwd_count,getLang("mail_fwd_msgs","raw"),!0);case"photo":case"video":case"audio":var i=t.filter(function(t){return t.type===e.type}).length;return langNumeric(i,a[e.type],!0);case"audio_playlist":return getLang("mail_added_audio_playlist");case"doc":switch(e.kind){case"graffiti":return getLang("mail_added_graffiti");case"audiomsg":return getLang("mail_added_audiomsg");default:return getLang("mail_added_docs")}case"geo":case"map":return getLang("mail_added_geo");case"wall":return getLang("mail_added_wall");case"wall_reply":return getLang("mail_added_wall_reply");case"gift":return getLang("mail_added_gift");case"link":case"share":return getLang("mail_added_link");case"sticker":return getLang("mail_added_sticker");case"chronicle":return getLang("mail_added_chronicle");case"chronicle_invite":return getLang("mail_invite_chronice");case"market":return getLang("mail_added_market_item");case"money_transfer":return getLang("mail_added_money_transfer");case"money_request":return getLang("mail_added_money_request");case"story":return getLang("mail_added_story");case"mask":return getLang("mail_added_mask")}return""}function Ye(e){addClass(e,"im-send-btn_loading")}function Xe(e){removeClass(e,"im-send-btn_loading")}function $e(e){var t=e.get(),a=(0,ut.getPinnedMessage)(e);if(!a||!(0,yt.isPinnedMessageVisibleInTab)(e,(0,ut.getPeer)(e)))return"";var i=(0,bt.oCacheGet)(e,a.userId);if(!i)return"";var r=a.text;r=!r&&a.attaches.length?getTemplate("im_pinned_message_media",{text:Qe(a.attaches[0],a.attaches)}):R(r,a&&a.kludges||{})||"",r=r.replace(/<br\s?\/?>/gi," ");var n=getTemplate("im_pinned_message",{date:getSmDate(a.date,t.timeshift),content:r,link:i.link,name:i.name});return n}function Je(e,t,a,i,r){var n=e.get(),s=void 0;return!showTabbedBox("al_im.php",{act:"a_get_pinned_message_box",chat:a,hash:n.tabs[a].hash},{onDone:function(a,r){r&&(s=i(a,e,t,r))},params:{width:638,onHide:function(){AudioMessagePlayer.loaded&&AudioMessagePlayer.detachPlayer(!0)},onDestroy:function(){s&&s.unmount()}}},r)}function Ze(e,t){return k(e.peerId)?e.memberIds.indexOf(t)>=0&&e.inactiveIds.indexOf(t)<0:!1}function et(e){return!k(e.peerId)||e.data.kicked?0:e.memberIds.length-e.inactiveIds.length}function tt(e,t){var a=(0,bt.oCacheGet)(e,t.peerId);return a&&(t.photo=t.photo||a.photo,t.name=t.name||a.name,t.href=t.link||a.link,t.sex=t.sex||a.sex),t.last_touched=t.last_touched||0,t.verified=!!t.verified,t.lastmsg=t.lastmsg||t.lastmsg_meta&&t.lastmsg_meta[0]||!1,t.folders=t.folders||null,t.unread=t.unread||0,t.last_seen=t.last_seen||[0,0,0],t.online=t.last_seen&&t.last_seen[0]||0,t.out_up_to=null!=t.out_up_to?t.out_up_to:t.in_up_to||0,t}function at(e,t){for(var a in t)tt(e,t[a])}function it(e,t){var a=[],i=t.find(function(e){return"mail"===e[0]}),r=i?i[1].split(";"):[];for(r.length>Ht&&(i[1]=r.slice(0,Ht).join(";"));e.length>Dt;){var n=e.substr(0,Dt).lastIndexOf(" ");-1==n&&(n=Dt),a.push({msgText:trim(e.substr(0,n))}),e=trim(e.substr(n))}for(e.length&&a.push({msgText:e,attaches:t}),a.length||a.push({attaches:t}),r=r.slice(Ht);r.length;r=r.slice(Ht))a.push({attaches:[["mail",r.slice(0,Ht).join(";")]]});return a}function rt(e){return e.length>Dt}function nt(e,t,a){var i=!1;showBox("al_im.php",{act:"a_chat_preview",chat_id:t.invite_chat_id,hash:t.invite_hash},{stat:["boxes.css"],params:{dark:1,hideButtons:!0,onHide:function(){e.set(a),i&&i.unmount()}},onDone:function(t,a){i=(0,mt.mount)(t.bodyNode,e)}},{})}function st(){showFastBox(getLang("global_error"),getLang("mail_message_wait_until_uploaded"))}Object.defineProperty(t,"__esModule",{value:!0}),t.MESSAGE_SEARCH_CLASS=t.CLEAR_RECENT_CLASS=t.HIDE_ASIDE_NOTICE_CLASS=t.HIDE_TOP_NOTICE_CLASS=t.SHOW_CHAT_MEMBERS_CLASS=t.DESELECT_ALL_CLASS=t.CHAT_INVITE_BY_LINK=t.CHAT_UNPIN_MESSAGE=t.CHAT_PIN_MESSAGE=t.CHAT_PHOTO_REMOVE=t.CHAT_PHOTO_UPDATE=t.CHAT_KICK_USER=t.CHAT_INVITE_USER=t.CHAT_TITLE_ACTION=t.CREATE_CHAT_ACTION=t.TYPING_CLASS=t.RESTORE_CLASS=t.ORIGINAL_CLASS=t.FAILED_CLASS=t.SENDING_CLASS=void 0;var ot=function(){function e(e,t){var a=[],i=!0,r=!1,n=void 0;try{for(var s,o=e[Symbol.iterator]();!(i=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);i=!0);}catch(c){r=!0,n=c}finally{try{!i&&o["return"]&&o["return"]()}finally{if(r)throw n}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),ct="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ut=a(14);Object.keys(ut).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return ut[e]}})}),t.getClassicChatHeight=r,t.setClassicChatHeight=n,t.fixTableCellChildHeight=s,t.applyInnerHtml=o,t.renderSticker=c,t.isAlreadyDeleted=u,t.replaceMessageAttrs=l,t.isVoiceMessageAvailable=d,t.getAvailableMicrophones=f,t.renderAttach=h,t.dayFromVal=p,t.showInvisibleBar=_,t.sebastianovAndReplaceMessage=m,t.renderMessage=g,t.appendToHistory=v,t.restoreQueue=b,t.markMessagesAsRead=y,t.replaceAttaches=w,t.isDuplicate=N,t.isReservedPeer=T,t.isUserPeer=F,t.isChatPeer=k,t.isPeerActive=S,t.isTabLoaded=x,t.isTabLoadedWithMessage=L,t.parseMessage=R,t.convertPeerToUrl=P,t.unUrlPeer=A,t.simplifyCounter=B,t.chatActions=D,t.renderPhotos=q,t.renderPhotosFromTab=z,t.renderBtnSearchOnlyMessages=U,t.renderMessagesSep=W,t.renderConversationsSep=G,t.renderPopularSuggSep=V,t.renderClearRecent=K,t.renderPopularSuggestions=Q,t.setMessageError=Y,t.startResendMessage=X,t.removeMessages=$,t.removeMessagesWithRestore=Z,t.restoreMessage=ee,t.formatTyper=te,t.formatTyperHelper=ae,t.renderEmptySearch=ne,t.isServiceMsg=oe,t.serviceLink=ce,t.renderServiceMsg=ue,t.addChatPhotoToUpdate=le,t.replaceSpecialSymbols=de,t.isSelfMessage=fe,t.showVerifiedTooltip=he,t.wrapLoading=pe,t.tabFromIds=_e,t.checkSelectClick=me,t.renderGoTo=ge,t.showFlushDialog=ve,t.showUnpinDialog=be,t.cleanHistory=Ce,t.showChatMembers=ye,t.inviteUser=we,t.showUnreadOnly=Ne,t.changeTab=Te,t.isImportant=Fe,t.isUnrespond=ke,t.isPeerBlocked=Ee,t.isPendingForward=Se,t.isPeerBlockedByMe=xe,t.blockLatencyCompensation=Le,t.showSpamLayer=Ie,t.getLastSeenTextInHeader=Oe,t.getMobileIcon=Me,t.showBlacklistBoxUser=Re,t.showBlacklistBox=Pe,t.getBaseLink=Ae,t.showFavvedBox=Be,t.isEditableFocused=De,t.updateStar=He,t.removewNewUnreadBarAndMerge=je,t.isMessagesVisible=qe,t.hideTopNotice=ze,t.hideAsideNotice=Ue,t.renderShortText=We,t.parseFwd=Ke,t.attachToText=Qe,t.lockButton=Ye,t.unlockButton=Xe,t.renderPinnedMessage=$e,t.showPinnedBox=Je,t.isUserAliveInChat=Ze,t.getAliveMembersCount=et,t.normalizeTab=tt,t.normalizeTabsGotFromServer=at,t.splitMessageToParts=it,t.isMessageTooLong=rt,t.showInvitationBox=nt,t.showWaitUntilUploadedBox=st;var lt=a(74),dt=i(lt),ft=a(94),ht=i(ft),pt=a(102),_t=a(81),mt=a(88),gt=a(44),vt=a(92),bt=a(97),Ct=a(7),yt=a(49),wt=a(83),Nt=t.SENDING_CLASS="_im_mess_sending",Tt=t.FAILED_CLASS="_im_mess_failed",Ft=t.ORIGINAL_CLASS="_im_mess_original",kt=t.RESTORE_CLASS="_im_mess_restore",Et=(t.TYPING_CLASS="_im_typing",t.CREATE_CHAT_ACTION="chat_create"),St=t.CHAT_TITLE_ACTION="chat_title_update",xt=t.CHAT_INVITE_USER="chat_invite_user",Lt=t.CHAT_KICK_USER="chat_kick_user",It=t.CHAT_PHOTO_UPDATE="chat_photo_update",Ot=t.CHAT_PHOTO_REMOVE="chat_photo_remove",Mt=t.CHAT_PIN_MESSAGE="chat_pin_message",Rt=t.CHAT_UNPIN_MESSAGE="chat_unpin_message",Pt=t.CHAT_INVITE_BY_LINK="chat_invite_user_by_link",At=(t.DESELECT_ALL_CLASS="_im_deselect_all",t.SHOW_CHAT_MEMBERS_CLASS="_im_show_chat_mems",t.HIDE_TOP_NOTICE_CLASS="_im_top_notice_hide",t.HIDE_ASIDE_NOTICE_CLASS="_im_aside_notice_hide",t.CLEAR_RECENT_CLASS="_im_clear_recent"),Bt=t.MESSAGE_SEARCH_CLASS="_im_mess_search",Dt=4096,Ht=100,jt=8,qt="chatPosition",zt={}},,,function(e,t){var a={}.hasOwnProperty;e.exports=function(e,t){return a.call(e,t)}},,function(e,t,a){var i=a(38),r=a(137).set;e.exports=function(e,t,a){var n,s=t.constructor;return s!==a&&"function"==typeof s&&(n=s.prototype)!==a.prototype&&i(n)&&r&&r(e,n),e}},function(e,t,a){"use strict";function i(){var e=lastWindowWidth,t=lastWindowHeight,a=sbWidth();return(lastWndScroll[0]!==!1?lastWndScroll[0]:htmlNode.scrollHeight>htmlNode.clientHeight)&&(e-=a+(a?1:0)),
[t,e]}function r(){var e=window,t=!1;t=e.boxLayerWrap&&isVisible(boxLayerWrap)?boxLayerWrap.scrollHeight>boxLayerWrap.clientHeight?1:0:e.layerWrap&&isVisible(layerWrap)?layerWrap.scrollHeight>layerWrap.clientHeight?1:0:e.mvLayerWrap&&isVisible(mvLayerWrap)?mvLayerWrap.scrollHeight>mvLayerWrap.clientHeight?1:0:!1,each(curRBox.tabs,function(e){this.options.marginFixedToLayer&&setStyle(this.wrap,{marginRight:hasClass(document.body,"layers_shown")?sbWidth():0})}),t!==lastWndScroll[0]&&(lastWndScroll[0]=t,each(curRBox.tabs,function(e){this.toRight&&!this.options.marginFixedToLayer&&setStyle(this.wrap,{marginRight:t?sbWidth():0})}))}function n(e,t){var a='<div class="'+(e.subClass||"")+'"><div class="fc_tab_head"><a class="fc_tab_close_wrap fl_r"><div class="chats_sp fc_tab_close"></div></a><div class="fc_tab_title noselect">%title%</div></div><div id="fc_ctabs_cont"><div class="fc_ctab fc_ctab_active">%content%</div></div></div></div>',i=void 0;i=e.content?'<div class="fc_content_wrap"><div class="fc_content">'+e.content+"</div></div>":e.innerHTML;var r=se(rs(a,{title:e.title,content:i}));i=geByClass1("fc_content",r,"div");var n={movable:geByClass1("fc_tab_head",r),hider:geByClass1("fc_tab_close_wrap",r,"a"),startLeft:e.x,startTop:e.y,startHeight:e.height,startWidth:e.width,resizeableH:i,resize:!1,minH:e.minH,onBeforeHide:e.onBeforeHide||function(){},onHide:e.onHide||function(){},onDragEnd:function(e,t){},onResize:function(e,t){}},s=new RBox(r,extend(n,e)),o=void 0;return e.content&&(o=new Scrollbar(i,{prefix:"fc_",more:debugLog,nomargin:!0,global:!0,nokeys:!0,right:vk.rtl?"auto":0,left:vk.rtl?0:"auto",onHold:e.onHold})),t({id:s.id,cont:i,update:function(){o&&o.update()}}),s}a(136),a(52),a(117),a(20),a(12),a(46),a(116),window.getWndInner=i,window.lastWndScroll=[!1,!1],window.updateWndVScroll=r,window.defBox=n;try{stManager.done("notifier.js")}catch(s){}},function(e,t){e.exports=!1},,function(e,t,a){var i=a(2),r=a(129)("iterator"),n=Array.prototype;e.exports=function(e){return void 0!==e&&(i.Array===e||n[r]===e)}},,function(e,t,a){var i=a(35);e.exports=function(e,t,a){if(i(e),void 0===t)return e;switch(a){case 1:return function(a){return e.call(t,a)};case 2:return function(a,i){return e.call(t,a,i)};case 3:return function(a,i,r){return e.call(t,a,i,r)}}return function(){return e.apply(t,arguments)}}},function(e,t){var a=Math.ceil,i=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?i:a)(e)}},function(e,t,a){var i=a(99),r=a(78),n=a(21),s=Object.defineProperty;t.f=a(50)?Object.defineProperty:function(e,t,a){if(i(e),t=n(t,!0),i(a),r)try{return s(e,t,a)}catch(o){}if("get"in a||"set"in a)throw TypeError("Accessors not supported!");return"value"in a&&(e[t]=a.value),e}},,,,,function(e,t,a){"use strict";function i(e){var t=M(e,2),a=t[1];return{type:A,localId:a}}function r(e){var t=M(e,4),a=t[1],i=t[2],r=t[3];return{type:D,messageId:a,mask:i,peerId:r}}function n(e){var t=M(e,4),a=t[1],i=t[2],r=t[3];return{type:B,messageId:a,flags:i,peerId:r}}function s(e){var t=M(e,4),a=t[1],i=t[2],r=t[3];return{type:H,messageId:a,flags:i,peerId:r}}function o(e){var t=M(e,10),a=t[1],i=t[2],r=t[3],n=t[4],s=t[5],o=t[6],c=void 0===o?{}:o,u=t[7],l=t[8],d=t[9];return{type:j,messageId:intval(a),flags:intval(i),peerId:intval(r),date:intval(n),attaches:(0,P.convertKludgesToAttaches)(c,a),subject:c.title,text:s,kludges:c,randomId:intval(u),userId:(0,R.isChatPeer)(r)?intval(c.from):intval(r),chatLocalId:l,update_time:d}}function c(e){var t=o(e);return t.type=ue,t.update_time=Math.floor(Date.now()/1e3),t}function u(e){return extend({},e,{type:ue})}function l(e){var t=M(e,3),a=t[1],i=t[2];return{type:q,peerId:a,upToId:i}}function d(e){var t=M(e,3),a=t[1],i=t[2];return{type:z,peerId:a,upToId:i}}function f(e){var t=M(e,4),a=t[1],i=t[2],r=t[3];return{type:U,userId:-a,platform:i,lastSeenTs:r}}function h(e){var t=M(e,4),a=t[1],i=t[2],r=t[3];return{type:W,userId:-a,reason:i,lastSeenTs:r}}function p(e){var t=M(e,4),a=t[1],i=t[2],r=t[3],n=void 0===r?!1:r;return{type:$,peerId:a,mask:i,local:n}}function _(e){var t=M(e,3),a=t[1],i=t[2];return{type:J,peerId:a,mask:i}}function m(e){var t=M(e,4),a=t[1],i=t[2],r=t[3],n=void 0===r?!1:r;return{type:Z,peerId:a,mask:i,local:n}}function g(e){var t=M(e,3),a=t[1],i=t[2];return{type:ce,peerId:a,localId:i}}function v(e){var t=M(e,3),a=t[1],i=t[2];return{type:G,chatId:a,self:i}}function b(e){var t=M(e,2),a=t[1];return{type:V,userId:a,peerId:a}}function C(e){var t=M(e,3),a=t[1],i=t[2];return{type:V,userId:a,peerId:i+2e9}}function y(e){var t=M(e,3),a=t[1],i=t[2];return{type:K,userId:a,callId:i}}function w(e){var t=M(e,2),a=t[1];return{type:Q,count:a}}function N(e){var t=M(e,2),a=t[1],i=void 0===a?{}:a;return{type:Y,peerId:i.peer_id,sound:i.sound,disabledUntil:i.disabled_until}}function T(e){return{type:X,params:e}}function F(e){return{type:te,state:e}}function k(){return{type:ee}}function E(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!1;return{type:ae,cancelSearch:e,removeActivePeer:t}}function S(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!1,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!1;return{type:re,peerId:e,msgid:t,forward:a,cancelSearch:i}}function x(e){return{type:ne,tab:e}}function L(e,t,a){return{type:se,message:t,peer:e,error:a}}function I(e){var t=M(e,6),a=(t[0],t[1]),i=t[2],r=t[3],n=t[4],s=t[5];return{type:ie,free:!!intval(a)||intval(n)===vk.id,resource:i,peerId:intval(r),who:intval(n),name:s}}function O(e,t){return{type:oe,message:t,peerId:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.FOLDER_UNRESPOND=t.FOLDER_IMPORTANT=t.FLAG_DELETED_FOR_ALL=t.FLAG_STEALTH=t.FLAG_MEDIA=t.FLAG_DELETED=t.FLAG_SPAM=t.FLAG_FRIENDS=t.FLAG_CHAT=t.FLAG_IMPORTANT=t.FLAG_OUTBOUND=t.FLAG_UNREAD=t.EDIT_MESSAGE=t.DELETE_DIALOG=t.RESEND=t.FAILED_MESSAGE=t.CHANGE_TAB=t.CHANGE_PEER=t.MUTEX=t.RESET_PEER=t.TRANSITION=t.RESYNC=t.SET_DIRECTORIES=t.REPLACE_DIRECTORIES=t.RESET_DIRECTORIES=t.EMPTY=t.NOTIFY_SETTINGS_CHANGED=t.UNREAD_COUNT=t.VIDEO_CALL=t.TYPING=t.CHAT_CHANGED=t.GOT_OFFLINE=t.GOT_ONLINE=t.READ_OUTBOUND=t.READ_INBOUND=t.ADD_MESSAGE=t.RESET_FLAGS=t.REPLACE_FLAGS=t.SET_FLAGS=t.DELETE=void 0;var M=function(){function e(e,t){var a=[],i=!0,r=!1,n=void 0;try{for(var s,o=e[Symbol.iterator]();!(i=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);i=!0);}catch(c){r=!0,n=c}finally{try{!i&&o["return"]&&o["return"]()}finally{if(r)throw n}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.deleteEvent=i,t.replaceFlagsEvent=r,t.setFlagsEvent=n,t.resetFlagsEvent=s,t.addMessageEvent=o,t.editMessageEvent=c,t.sebastianovMessageLocallyEvent=u,t.readInboundEvent=l,t.readOutboundEvent=d,t.gotOnlineEvent=f,t.gotOfflineEvent=h,t.resetDirectoriesEvent=p,t.replaceDirectoriesEvent=_,t.setDirectoriesEvent=m,t.deleteDialogEvent=g,t.chatChangedEvent=v,t.typingUserEvent=b,t.typingChatEvent=C,t.videoCallEvent=y,t.unreadCountEvent=w,t.notifySettingsChangedEvent=N,t.emptyEvent=T,t.transitionEvent=F,t.resyncEvent=k,t.resetPeer=E,t.changePeer=S,t.changeTab=x,t.failedMessage=L,t.mutexEvent=I,t.resendEvent=O;var R=a(56),P=a(87),A=t.DELETE="event_delete",B=t.SET_FLAGS="event_set_flags",D=t.REPLACE_FLAGS="event_replace_flags",H=t.RESET_FLAGS="event_reset_flags",j=t.ADD_MESSAGE="event_add_message",q=t.READ_INBOUND="event_read_inbound",z=t.READ_OUTBOUND="event_read_outbound",U=t.GOT_ONLINE="event_got_online",W=t.GOT_OFFLINE="event_got_offline",G=t.CHAT_CHANGED="event_chat_changed",V=t.TYPING="event_typing",K=t.VIDEO_CALL="event_video_call",Q=t.UNREAD_COUNT="event_unread_count",Y=t.NOTIFY_SETTINGS_CHANGED="event_notify_settings_changed",X=t.EMPTY="event_empty",$=t.RESET_DIRECTORIES="event_reset_directories",J=t.REPLACE_DIRECTORIES="event_replace_directories",Z=t.SET_DIRECTORIES="event_set_directories",ee=t.RESYNC="event_resync",te=t.TRANSITION="transition_event",ae=t.RESET_PEER="reset_peer",ie=t.MUTEX="mutex",re=t.CHANGE_PEER="change_peer",ne=t.CHANGE_TAB="event_change_tab",se=t.FAILED_MESSAGE="event_failed_message",oe=t.RESEND="event_resend",ce=t.DELETE_DIALOG="event_delete_dialog",ue=t.EDIT_MESSAGE="event_edit_message";t.FLAG_UNREAD=1,t.FLAG_OUTBOUND=2,t.FLAG_IMPORTANT=8,t.FLAG_CHAT=16,t.FLAG_FRIENDS=32,t.FLAG_SPAM=64,t.FLAG_DELETED=128,t.FLAG_MEDIA=512,t.FLAG_STEALTH=65536,t.FLAG_DELETED_FOR_ALL=1<<17,t.FOLDER_IMPORTANT=1,t.FOLDER_UNRESPOND=2},function(e,t,a){var i=a(93),r=a(124),n=a(96),s=a(30),o=a(67),c="prototype",u=function(e,t,a){var l,d,f,h,p=e&u.F,_=e&u.G,m=e&u.S,g=e&u.P,v=e&u.B,b=_?i:m?i[t]||(i[t]={}):(i[t]||{})[c],C=_?r:r[t]||(r[t]={}),y=C[c]||(C[c]={});_&&(a=t);for(l in a)d=!p&&b&&void 0!==b[l],f=(d?b:a)[l],h=v&&d?o(f,i):g&&"function"==typeof f?o(Function.call,f):f,b&&s(b,l,f,e&u.U),C[l]!=f&&n(C,l,h),g&&y[l]!=f&&(y[l]=f)};i.core=r,u.F=1,u.G=2,u.S=4,u.P=8,u.B=16,u.W=32,u.U=64,u.R=128,e.exports=u},,function(e,t,a){var i=a(47),r=a(129)("toStringTag"),n="Arguments"==i(function(){return arguments}()),s=function(e,t){try{return e[t]}catch(a){}};e.exports=function(e){var t,a,o;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(a=s(t=Object(e),r))?a:n?i(t):"Object"==(o=i(t))&&"function"==typeof t.callee?"Arguments":o}},function(e,t,a){e.exports=!a(50)&&!a(80)(function(){return 7!=Object.defineProperty(a(112)("div"),"a",{get:function(){return 7}}).a})},,function(e,t){e.exports=function(e){try{return!!e()}catch(t){return!0}}},function(e,t,a){"use strict";function i(e,t){for(var a=void 0,i=0,r=e;null!==(a=l.MESSAGE_REGEXP.exec(e));){var n=a[0].length,o=a.index+n,c=e[a.index-1],u=e[o-1],d=void 0!==c&&/([\w\$А-Яа-яёЁєЄҐґЇїІіЈј\—\-\_@;.])/i.test(c),f=void 0!==u&&/([:;$])/i.test(u);if(!d&&!f){var h=s(a),p=h.domain;if(p.length<=l.MAX_DOMAIN_LENGTH&&-1!==l.TOP_DOMAINS.indexOf(p)){var _=t(h);r=r.slice(0,a.index+i)+_+r.slice(o+i),i+=_.length-n}}}return r}function r(e,t){return e.replace(l.EMAIL,t||function(e){return'<a href="/write?email='+e+'" target="_blank">'+e+"</a>"})}function n(e,t){return e.replace(l.MENTION,t||function(e,t,a,i,r){return'<a href="/'+(t+a)+'" class="mem_link" mention="'+clean(i||"")+'" mention_id="'+clean(t+a)+'" onclick="return mentionClick(this, event)" onmouseover="mentionOver(this)">'+r+"</a>"})}function s(e){return{full:e[0],protocol:e[1]||"http://",url:e[2],domain:e[4],query:e[6]||""}}function o(e){statlogsValueEvent("ttl_message_confirm_delivery",e)}function c(e,t){var a=t.protocol,i=t.url,r=t.query,n=t.domain,s=t.full;try{s=decodeURIComponent(s)}catch(o){}if(s.length>55&&(s=s.substr(0,53)+".."),s=clean(s).replace(/&amp;/g,"&"),!e&&n.match(l.OUR_DOMAINS)){i=replaceEntities(i).replace(l.ENTITIES,encodeURIComponent);var c,d=i,f=i.indexOf("#/"),h="";return f>=0?d=i.substr(f+1):(f=i.indexOf("#!"),f>=0&&(d="/"+i.substr(f+2).replace(/^\//,""))),c=d.match(l.VK_DOMAIN),c&&c[1].length<32&&(h=' mention_id="'+c[1]+'" onclick="return mentionClick(this, event)" onmouseover="mentionOver(this)"'),'<a href="'+u(a+i+r)+'" target="_blank"'+h+">"+s+"</a>"}return'<a href="away.php?utf=1&to='+encodeURIComponent(a+replaceEntities(i+r))+'" target="_blank" onclick="return goAway(\''+clean((a+i+r).replace(/'/g,"\\'"))+"', {}, event);\">"+s+"</a>"}function u(e){return e.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}Object.defineProperty(t,"__esModule",{value:!0}),t.replaceHyperLinks=i,t.replaceEmailLinks=r,t.replaceMentions=n,t.confirmDelivery=o,t.linksReplacer=c;var l=a(94)},function(e,t,a){var i=a(95);e.exports=function(e){return Object(i(e))}},function(e,t,a){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t["default"]=e,t}function r(e,t){t=(0,d.parserMessage)(t);var a=vk.id==t.peerId&&!(0,d.unpackStore)(e).gid;return a||(0,f.isOut)(t)?(0,h.isServiceMsg)(t)?!1:Date.now()/1e3-t.date>86400?!1:(0,f.isGift)(t)||(0,f.isSticker)(t)||(0,f.isAudioMsg)(t)||(0,f.isGraffiti)(t)||(0,f.isMoney)(t)||(0,f.isWallAttach)(t)?!1:(0,d.isCommunityInterface)(e)&&(t.kludges||{}).from_admin!=vk.id?!1:(0,h.isAlreadyDeleted)(e,t.peerId,t.messageId)?!1:!0:!1}function n(e){var t=document.createElement("div");return e=e.replace(/\[((id|club)\d+)\|(.+?)]/g,"@$1 ($3)"),t.innerHTML=e,Emoji.val(t)}function s(e,t){var a=t&&t.msgs?Object.keys(t.msgs):[],i=a.filter(function(e){return e>0}).sort(function(e,t){return t-e}).find(function(a){return r(e,t.msgs[a])});return+i||null}function o(e,t,a){var i=(0,p.convertKludgesToAttaches)(t.kludges,t.messageId),r=a.dData.attaches;if(n(t.text)!==a.dData.txt||i.length!==r.length)return!0;for(var s=i.length;s--;)if(i[s].id!=r[s].id||i[s].type!=r[s].type)return!0;return!1}function c(e,t,a,i,r){t.origText=a,t.text=(0,h.replaceSpecialSymbols)(clean(a)).replace(/\n/gi,"<br>"),t.attaches=i,t.kludges.emoji=1,t.local=1,t.share_url=r,t.update_time=Math.floor(Date.now()/1e3),e.get().tabs[t.peerId].msgs[t.messageId]=t}function u(e){return(0,d.unpackStore)(e).sebastianovAllowed>0}Object.defineProperty(t,"__esModule",{value:!0}),t.canMessageBeSebastianoved=r,t.convertEmojiHtmlToRegularText=n,t.findLastMessageToSebastianov=s,t.wasMessageReallyModified=o,t.replaceMsgAfterSebastianov=c,t.isSebastianovAllowed=u;var l=a(74),d=(i(l),a(14)),f=a(102),h=a(56),p=a(87)},,function(e,t,a){var i=a(110),r=a(95);e.exports=function(e){return i(r(e))}},,function(e,t,a){"use strict";function i(){return{txt:"",attaches:[],urlBinds:[]}}function r(e,t){this._db=e,this._key=t,this.dData=i(),this.load()}function n(e){switch(e.type){case"mail":return e.id<0&&1==e.object.fwd_count;default:return!e.object}}function s(e){return{txt:e.txt,attaches:e.attaches.length?e.attaches:void 0,urlBinds:e.urlBinds.length?e.urlBinds:void 0}}function o(e){return{txt:e.txt,attaches:e.attaches||[],urlBinds:e.urlBinds||[]}}function c(e,t){var a=[];e.fwd_count?a.push({type:"mail",id:-t,object:{fwd_count:e.fwd_count}}):e.fwd&&a.push({type:"mail",id:-t,object:{fwd_count:(0,f.parseFwd)(e.fwd).length}});for(var i=1;e["attach"+i+"_type"];++i)a.push({type:e["attach"+i+"_type"],id:e["attach"+i],kind:e["attach"+i+"_kind"],productId:e["attach"+i+"_product_id"]});return e.geo&&a.push({type:"geo",id:e.geo}),a}function u(e,t){return new r(e,"draft_"+t)}Object.defineProperty(t,"__esModule",{value:!0});var l=function(){function e(e,t){var a=[],i=!0,r=!1,n=void 0;try{for(var s,o=e[Symbol.iterator]();!(i=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);i=!0);}catch(c){r=!0,n=c}finally{try{!i&&o["return"]&&o["return"]()}finally{if(r)throw n}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.ImDraft=r,t.convertKludgesToAttaches=c,t.loadDraftForPeer=u;var d=a(127),f=a(56);r.prototype.dump=function(){this._key&&this._db.updateByKey(this._key,s(this.dData))},r.prototype.load=function(){if(this._key){var e=this._db.selectByKey(this._key);e&&(this.dData=o(e))}},r.prototype.clear=function(){this.dData=i(),this.dump()},r.prototype.setText=function(e){this.dData.txt=trim(e),this.dump()},r.prototype.addAttach=function(e,t,a){("share"===e||"mail"===e)&&this.removeAttachByType(e);var i=this.dData.attaches.find(function(a){return a.type===e&&a.id===t});!i&&e&&t&&(this.dData.attaches.push({type:e,id:t,object:a}),this.dump())},r.prototype.syncWithSelector=function(e){var t=this,a=this.getFwdRaw();this.dData.attaches=(a?[a]:[]).concat(e.getMedias().map(function(e){var a=l(e,2),i=a[0],r=a[1],n=t.dData.attaches.find(function(e){return e.type==i&&e.id==r});return n||{type:i,id:r}})),this.dump()},r.prototype.removeAttachByType=function(e){for(var t=this.dData.attaches.length;t--;)this.dData.attaches[t].type===e&&this.dData.attaches.splice(t,1);this.dump()},r.prototype.removeAllAttaches=function(){this.dData.attaches=[],this.dump()},r.prototype.addBindUrl=function(e,t,a){this.getBoundAttach(e)||(this.dData.urlBinds.push({url:e,type:t,id:a}),this.dump())},r.prototype.getBoundAttach=function(e){var t=this.dData.urlBinds.find(function(t){return t.url===e});return t?this.dData.attaches.find(function(e){return e.type===t.type&&e.id===t.id})||null:null},r.prototype.getShareUrl=function(){var e=this.dData.attaches.find(function(e){return"share"===e.type});return e&&e.object?e.object.url:void 0},r.prototype.hasAttaches=function(){return this.dData.attaches.length>0},r.prototype.destroy=function(){this.dData={},this._key=this._db=null},r.prototype.prepareObjects=function(e,t){var a=this,i=this.dData.attaches.find(n);return i?(0,d.post)(d.CONTROLLER,{act:"draft_medias",gid:e,messageId:t||0,media:t?void 0:this.dData.attaches.map(function(e){return[e.type,e.id]}).join("*")}).then(function(e){var t=l(e,1),i=t[0];a.dData.attaches=i.map(function(e){return{type:e[0],id:e[1],object:e[2]}})}):Promise.resolve()},r.prototype.getFwdRaw=function(){return this.dData.attaches.find(function(e){return"mail"===e.type})},r.prototype.getFwdCount=function(){var e=this.getFwdRaw();return e?e.id<0?e.object.fwd_count:e.id.split(";").length:0}},function(e,t,a){"use strict";function i(e,t){var a=domData(t,"chat-id"),i=domData(t,"hash");return lockButton(t),(0,s.joinChat)(a,i,e.get()).then(function(a){var i=n(a,1),r=i[0];unlockButton(t),e.get().longpoll.push([(0,c.changePeer)(r)])})["catch"](function(e){showFastBox(getLang("mail_join_invite_error_title"),e),unlockButton(t)})}function r(e,t){var a=(0,o.createModule)({handlers:function(a,r){r(e,"click",u,function(e){return i(t,e.target)})}});return{unmount:function(){(0,o.destroyModule)(a)}}}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){var a=[],i=!0,r=!1,n=void 0;try{for(var s,o=e[Symbol.iterator]();!(i=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);i=!0);}catch(c){r=!0,n=c}finally{try{!i&&o["return"]&&o["return"]()}finally{if(r)throw n}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.mount=r;var s=a(45),o=a(44),c=a(74),u="_im_join_chat"},function(e,t,a){var i=a(85),r=a(31),n=a(91);e.exports=function(e){return function(t,a,s){var o,c=i(t),u=r(c.length),l=n(s,u);if(e&&a!=a){for(;u>l;)if(o=c[l++],o!=o)return!0}else for(;u>l;l++)if((e||l in c)&&c[l]===a)return e||l;return!e&&-1}}},,function(e,t,a){var i=a(68),r=Math.max,n=Math.min;e.exports=function(e,t){return e=i(e),0>e?r(e+t,0):n(e,t)}},function(e,t){"use strict";function a(e,t){var a=[],i=0;return function(r){a.push(r),i||(i=setTimeout(function(){i=!1,e(a),a=[]},t))}}function i(e){return e.length>0&&e.pop().func(),e}function r(e,t){var a,i;if(window.__debugMode){switch(t){case"error":a="color: red",i="background: red; color: white";break;case"success":a="color: green",i="background: green; color: white";break;default:a="color: blue;",i="background: #000; color: #fff;"}try{var r=new Date;console.debug("%cLP:["+r.getHours()+":"+r.getMinutes()+":"+r.getSeconds()+":"+r.getMilliseconds()+"]%c "+e,i,a)}catch(n){}}}function n(e){var t=[];if("undefined"==typeof e.length)return Object.keys(e).map(function(t){return e[t]});for(var a=0;a<e.length;a++)t.push(e[a]);return t}function s(e){for(var t={},a=[],i=0;i<e.length;i++)t[e[i]]||(a.push(e[i]),t[a[i]]=1);return a}Object.defineProperty(t,"__esModule",{value:!0}),t.throttleAccumulate=a,t.executionStackPop=i,t.lplog=r,t.toArray=n,t.arrayUnique=s},function(e,t){var a=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=a)},function(e,t){"use strict";function a(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}Object.defineProperty(t,"__esModule",{value:!0});var i,r="\\w\\$А-Яа-яёЁєЄҐґЇїІіЈј",n="(https?:\\/\\/)?",s="((?:["+r+"\\—\\-\\_]+\\.){1,5})",o="([A-Za-z\\$а-яА-Я\\-\\d]{2,22})",c="(?:\\:(\\d{2,5}))",u="("+s+o+c+"?)",l="([\\/?#])",d="\\wА-Яа-я\\xa8\\xb8\\xc0-\\xffєЄҐґЇїІіЈј",f="ªµºÀ-ÖØ-öø-ˁˆ-ˑˠ-ˤˬˮͰ-ʹͶͷͺ-ͽͿΆΈ-ΊΌΎ-ΡΣ-ϵϷ-ҁҊ-ԯԱ-Ֆՙա-ևא-תװ-ײؠ-يٮٯٱ-ۓەۥۦۮۯۺ-ۼۿܐܒ-ܯݍ-ޥޱߊ-ߪߴߵߺࠀ-ࠕࠚࠤࠨࡀ-ࡘࢠ-ࢴࢶ-ࢽऄ-हऽॐक़-ॡॱ-ঀঅ-ঌএঐও-নপ-রলশ-হঽৎড়ঢ়য়-ৡৰৱਅ-ਊਏਐਓ-ਨਪ-ਰਲਲ਼ਵਸ਼ਸਹਖ਼-ੜਫ਼ੲ-ੴઅ-ઍએ-ઑઓ-નપ-રલળવ-હઽૐૠૡૹଅ-ଌଏଐଓ-ନପ-ରଲଳଵ-ହଽଡ଼ଢ଼ୟ-ୡୱஃஅ-ஊஎ-ஐஒ-கஙசஜஞடணதந-பம-ஹௐఅ-ఌఎ-ఐఒ-నప-హఽౘ-ౚౠౡಀಅ-ಌಎ-ಐಒ-ನಪ-ಳವ-ಹಽೞೠೡೱೲഅ-ഌഎ-ഐഒ-ഺഽൎൔ-ൖൟ-ൡൺ-ൿඅ-ඖක-නඳ-රලව-ෆก-ะาำเ-ๆກຂຄງຈຊຍດ-ທນ-ຟມ-ຣລວສຫອ-ະາຳຽເ-ໄໆໜ-ໟༀཀ-ཇཉ-ཬྈ-ྌက-ဪဿၐ-ၕၚ-ၝၡၥၦၮ-ၰၵ-ႁႎႠ-ჅჇჍა-ჺჼ-ቈቊ-ቍቐ-ቖቘቚ-ቝበ-ኈኊ-ኍነ-ኰኲ-ኵኸ-ኾዀዂ-ዅወ-ዖዘ-ጐጒ-ጕጘ-ፚᎀ-ᎏᎠ-Ᏽᏸ-ᏽᐁ-ᙬᙯ-ᙿᚁ-ᚚᚠ-ᛪᛱ-ᛸᜀ-ᜌᜎ-ᜑᜠ-ᜱᝀ-ᝑᝠ-ᝬᝮ-ᝰក-ឳៗៜᠠ-ᡷᢀ-ᢄᢇ-ᢨᢪᢰ-ᣵᤀ-ᤞᥐ-ᥭᥰ-ᥴᦀ-ᦫᦰ-ᧉᨀ-ᨖᨠ-ᩔᪧᬅ-ᬳᭅ-ᭋᮃ-ᮠᮮᮯᮺ-ᯥᰀ-ᰣᱍ-ᱏᱚ-ᱽᲀ-ᲈᳩ-ᳬᳮ-ᳱᳵᳶᴀ-ᶿḀ-ἕἘ-Ἕἠ-ὅὈ-Ὅὐ-ὗὙὛὝὟ-ώᾀ-ᾴᾶ-ᾼιῂ-ῄῆ-ῌῐ-ΐῖ-Ίῠ-Ῥῲ-ῴῶ-ῼⁱⁿₐ-ₜℂℇℊ-ℓℕℙ-ℝℤΩℨK-ℭℯ-ℹℼ-ℿⅅ-ⅉⅎↃↄⰀ-Ⱞⰰ-ⱞⱠ-ⳤⳫ-ⳮⳲⳳⴀ-ⴥⴧⴭⴰ-ⵧⵯⶀ-ⶖⶠ-ⶦⶨ-ⶮⶰ-ⶶⶸ-ⶾⷀ-ⷆⷈ-ⷎⷐ-ⷖⷘ-ⷞⸯ々〆〱-〵〻〼ぁ-ゖゝ-ゟァ-ヺー-ヿㄅ-ㄭㄱ-ㆎㆠ-ㆺㇰ-ㇿ㐀-䶵一-鿕ꀀ-ꒌꓐ-ꓽꔀ-ꘌꘐ-ꘟꘪꘫꙀ-ꙮꙿ-ꚝꚠ-ꛥꜗ-ꜟꜢ-ꞈꞋ-ꞮꞰ-ꞷꟷ-ꠁꠃ-ꠅꠇ-ꠊꠌ-ꠢꡀ-ꡳꢂ-ꢳꣲ-ꣷꣻꣽꤊ-ꤥꤰ-ꥆꥠ-ꥼꦄ-ꦲꧏꧠ-ꧤꧦ-ꧯꧺ-ꧾꨀ-ꨨꩀ-ꩂꩄ-ꩋꩠ-ꩶꩺꩾ-ꪯꪱꪵꪶꪹ-ꪽꫀꫂꫛ-ꫝꫠ-ꫪꫲ-ꫴꬁ-ꬆꬉ-ꬎꬑ-ꬖꬠ-ꬦꬨ-ꬮꬰ-ꭚꭜ-ꭥꭰ-ꯢ가-힣ힰ-ퟆퟋ-ퟻ豈-舘並-龎ﬀ-ﬆﬓ-ﬗיִײַ-ﬨשׁ-זּטּ-לּמּנּסּףּפּצּ-ﮱﯓ-ﴽﵐ-ﶏﶒ-ﷇﷰ-ﷻﹰ-ﹴﹶ-ﻼＡ-Ｚａ-ｚｦ-ﾾￂ-ￇￊ-ￏￒ-ￗￚ-ￜ",h="　-〿＀-￯",p="\\—\\-\\_@#%?+\\/\\$.~=;:'",_="["+d+p+f+h+"]",m="(?:\\(|\\[)["+r+"\\d&#%;,]+(?:\\)|\\])",g="("+l+"(?:\\&amp;|\\&#\\d{2,6};|,[_%]|!|,*"+_+"+|"+m+"){0,200})?",v=n+u+g,b="ac,ad,ae,af,ag,ai,al,am,an,ao,aq,ar,as,at,au,aw,ax,az,ba,bb,bd,be,bf,bg,bh,bi,bj,bm,bn,bo,br,bs,bt,bv,bw,by,bz,ca,cc,cd,cf,cg,ch,ci,ck,cl,cm,cn,co,cr,cu,cv,cx,cy,cz,de,dj,dk,dm,do,dz,ec,ee,eg,eh,er,es,et,eu,fi,fj,fk,fm,fo,fr,ga,gd,ge,gf,gg,gh,gi,gl,gm,gn,gp,gq,gr,gs,gt,gu,gw,gy,hk,hm,hn,hr,ht,hu,id,ie,il,im,in,io,iq,ir,is,it,je,jm,jo,jp,ke,kg,kh,ki,km,kn,kp,kr,kw,ky,kz,la,lb,lc,li,lk,lr,ls,lt,lu,lv,ly,ma,mc,md,me,mg,mh,mk,ml,mm,mn,mo,mp,mq,mr,ms,mt,mu,mv,mw,mx,my,mz,na,nc,ne,nf,ng,ni,nl,no,np,nr,nu,nz,om,pa,pe,pf,pg,ph,pk,pl,pm,pn,pr,ps,pt,pw,py,qa,re,ro,ru,rs,rw,sa,sb,sc,sd,se,sg,sh,si,sj,sk,sl,sm,sn,so,sr,ss,st,su,sv,sx,sy,sz,tc,td,tf,tg,th,tj,tk,tl,tm,tn,to,tp,tr,tt,tv,tw,tz,ua,ug,uk,um,us,uy,uz,va,vc,ve,vg,vi,vn,vu,wf,ws,ye,yt,yu,za,zm,zw,arpa,aero,asia,biz,cat,com,coop,info,int,jobs,media,mobi,museum,name,net,org,place,post,pro,tattoo,tel,travel,xxx,club,academy,camera,edu,gov,mil,local,international,bar,design",C="бг,бел,дети,ею,католик,ком,мкд,мон,москва,онлайн,орг,рус,рф,сайт,срб,укр",y="qxam,90ae,90ais,d1acj3b,e1a4c,80aqecdr1a,j1aef,d1alf,l1acc,80adxhks,80asehdb,c1avg,p1acf,p1ai,80aswg,90a3ac,j1amh,80ao21a,y9a3aq,9dbq2a,mgbca7dzdo,mgba3a3ejt,mgbayh7gpa,lgbbat1ad8j,mgberp4a5d4ar,mgba7c0bbn0a,mgbc0a9azcg,mgb2ddes,mgbaam7a8h,mgba3a4f16a,mgbbh1a,mgbab2bd,ngbe9e0a,mgbbh1a71e,pgbs0dh,mgbpl2fh,ogbpf8fl,ngbc5azd,mgbtx2b,mgb9awbf,ygbi2ammx,wgbl6a,mgbi4ecexp,fhbei,wgbh1c,mgbx4cd0ab,mgbb9fbpob,4gbrim,mgbt3dhd,mgbai9azgqp6j,mgbgu82a,11b4c3d,c2br7g,h2brj9c,h2breg3eve,h2brj9c8c,i1b6b1a6a2e,54b7fta0cc,45brj9c,45br5cyl,s9brj9c,gecrj9c,3hcrj9c,xkc2dl3a5ee0h,xkc2al3hye2a,clchc0ea0b2g2a9gcd,fpcrj9c3d,2scrj9c,rvc1e0am3e,fzc2c9e2c,42c2d9a,o3cw4h,node,q9jyb4c,gckr3f0f,qcka1pmc,tckwe,cck2b3b,1ck2e1b,bck1b9a5dre4c,eckvdtc9d,rhqv96g,fiq64b,fiqs8s,fiqz9s,fiq228c5hs,vhquv,1qqw23a,vuq861b,nyqy26a,45q11c,55qx5d,55qw42g,kprw13d,kpry57d,czru2d,czrs0t,czr694b,w4rs40l,w4r85el8fhu5dnra,3ds443g,3oq18vl8pn36a,pssy2u,tiq49xqyj,fjq720a,fct429k,estv75g,xhq521b,9krt00a,30rr7y,6qq986b3xl,kput3i,kpu716f,zfr164b,mxtq1m,yfro4i67o,efvy88h,9et52u,rovu88b,nqv7f,b4w605ferd,unup4y,mix891f,mix082f,3pxu8k,pbt977c,6frz82g,nqv7fs00ema,ses554g,hxt814e,5tzm5g,io0a7i,8y0a063a,jlq61u9w7b,flw351e,g2xx48c,gk3at1e,3bst00m,fzys8d69uvgm,kcrx77d1x4a,jvr189m,imr513n,5su34j936bgsg,j6w193g,t60b56a,mk1bu44c,cg4bki,3e0b707e",w=(t.OUR_DOMAINS=/^([a-zA-Z0-9\.\_\-]+\.)?(vkontakte\.ru|vk\.com|vkadre\.ru|vshtate\.ru|userapi\.com|vk\.me)$/,t.ENTITIES=/([^a-zA-Z0-9#%;_\-.\/?&=\[\]])/g,t.VK_DOMAIN=/^(?:https?:\/\/)?(?:vk\.com|vkontakte\.ru)?\/([a-zA-Z0-9\._]+)\??$/,t.MENTION=/\[(id|club)(\d+)(?:\:([a-z0-9_\-]+))?\|([^\$]+?)\]/g,t.MENTION_RAW=/(^|[\s.,:\'\";>\)\(])(\*|@)([A-Za-z0-9_\.]{2,32})\s*\((.+?)\)/g,t.ARROW_UP=38),N=t.ARROW_DOWN=40,T=t.PAGE_UP=33,F=t.PAGE_DOWN=34,k=t.END_KEY=35,E=t.HOME=36,S=t.ENTER=13,x=t.ESC=27,L=(t.UNPRINTABLE_KEYS=[w,N,T,F,S,x,k,E],t.UP_DOWN_CONTROLS=[T,F,N,w,E,k],t.PRINTABLE="printable",t.FOLDER_UNREAD="unread"),I=t.FOLDER_ALL="all",O=t.FOLDER_UNRESPOND="unrespond",M=t.FOLDER_IMPORTANT="important",R=(t.FOLDERS=[I,L,O,M],t.FOLDER_MASKS=(i={},a(i,O,2),a(i,M,1),i),t.TOP_DOMAINS=[].concat(b.split(","),C.split(","),y.split(",").map(function(e){return"xn--"+e})));t.MAX_DOMAIN_LENGTH=R.reduce(function(e,t){return Math.max(e,t.length)},0),t.EMAIL=new RegExp("([a-zA-Zа-яА-Я\\-_\\.0-9\\+]+@("+s+o+"))","ig"),t.MESSAGE_REGEXP=new RegExp(v,"ig")},function(e,t){e.exports=function(e){if(void 0==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t,a){var i=a(69),r=a(17);e.exports=a(50)?function(e,t,a){return i.f(e,t,r(1,a))}:function(e,t,a){return e[t]=a,e}},function(e,t,a){"use strict";function i(e){if(!e.first_name){var t=e.name.split(" ",2);e.first_name=t[0],e.short_name=t[1]?t[0]+" "+t[1].substr(0,1)+".":t[0]}e.inv_name||(e.inv_name=e.name),e.kick_name||(e.kick_name=e.inv_name)}function r(e,t){var a=(0,o.unpackStore)(e);return t in a.oCache}function n(e,t){var a=(0,o.unpackStore)(e).oCache[t];return a&&!a._n&&(i(a),a._n=1),a}function s(e,t){var a=(0,o.unpackStore)(e);a.oCache||(a.oCache={}),t.id&&(a.oCache[t.id]=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.oCacheExists=r,t.oCacheGet=n,t.oCacheAdd=s;var o=a(14)},,function(e,t,a){var i=a(38);e.exports=function(e){if(!i(e))throw TypeError(e+" is not an object!");return e}},function(e,t,a){var i=a(107),r=a(134);e.exports=Object.keys||function(e){return i(e,r)}},function(e,t,a){var i=a(99);e.exports=function(e,t,a,r){try{return r?t(i(a)[0],a[1]):t(a)}catch(n){var s=e["return"];throw void 0!==s&&i(s.call(e)),n}}},function(e,t,a){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t["default"]=e,t}function r(e,t){return"number"!=typeof t.messageId?!0:n(t)?t.messageId>e.out_up_to:t.messageId>e.in_up_to}function n(e){return e.flags&C.FLAG_OUTBOUND}function s(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=e.attaches[0];return i&&(i.type===t||i.type===a)}function o(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=e.attaches[1];return i&&(i.type===t||i.type===a)}function c(e){return s(e,"doc")&&"graffiti"===e.attaches[0].kind}function u(e){return s(e,"doc")&&"audiomsg"===e.attaches[0].kind}function l(e){return s(e,"sticker")}function d(e){return s(e,"gift")}function f(e){return s(e,"money_transfer","money_request")}function h(e){return s(e,"money_request")}function p(e){return s(e,"wall","wall_reply")||o(e,"wall","wall_reply")}function _(e){return e.flags&C.FLAG_IMPORTANT}function m(e){return n(e)?vk.id:e.userId}function g(e){return e.update_time>0}function v(e,t){return(e.get().selectedMessages||[]).indexOf(t)>=0}Object.defineProperty(t,"__esModule",{value:!0}),t.isUnread=r,t.isOut=n,t.isGraffiti=c,t.isAudioMsg=u,t.isSticker=l,t.isGift=d,t.isMoney=f,t.isMoneyRequest=h,t.isWallAttach=p,t.isImportant=_,t.getUserId=m,t.wasSebastianoved=g,t.isMessageSelected=v;var b=a(74),C=i(b)},,,function(e,t,a){for(var i=a(32),r=a(30),n=a(93),s=a(96),o=a(2),c=a(129),u=c("iterator"),l=c("toStringTag"),d=o.Array,f=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],h=0;5>h;h++){var p,_=f[h],m=n[_],g=m&&m.prototype;if(g){g[u]||s(g,u,d),g[l]||s(g,l,_),o[_]=d;for(p in i)g[p]||r(g,p,i[p],!0)}}},function(e,t,a){var i=a(99),r=a(133),n=a(134),s=a(121)("IE_PROTO"),o=function(){},c="prototype",u=function(){var e,t=a(112)("iframe"),i=n.length,r=">";for(t.style.display="none",a(115).appendChild(t),t.src="javascript:",e=t.contentWindow.document,e.open(),e.write("<script>document.F=Object</script"+r),e.close(),u=e.F;i--;)delete u[c][n[i]];return u()};e.exports=Object.create||function(e,t){var a;return null!==e?(o[c]=i(e),a=new o,o[c]=null,a[s]=e):a=u(),void 0===t?a:r(a,t)}},function(e,t,a){var i=a(59),r=a(85),n=a(89)(!1),s=a(121)("IE_PROTO");e.exports=function(e,t){var a,o=r(e),c=0,u=[];for(a in o)a!=s&&i(o,a)&&u.push(a);for(;t.length>c;)i(o,a=t[c++])&&(~n(u,a)||u.push(a));return u}},,function(e,t,a){"use strict";var i=a(106),r=a(17),n=a(54),s={};a(96)(s,a(129)("iterator"),function(){return this}),e.exports=function(e,t,a){e.prototype=i(s,{next:r(1,a)}),n(e,t+" Iterator")}},function(e,t,a){var i=a(47);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==i(e)?e.split(""):Object(e)}},,function(e,t,a){var i=a(38),r=a(93).document,n=i(r)&&i(r.createElement);e.exports=function(e){return n?r.createElement(e):{}}},,,function(e,t,a){e.exports=a(93).document&&document.documentElement},function(module,exports){"use strict";window.TopNotifierCur||(window.TopNotifierCur={link:"top_notify_btn",count:"top_notify_count",_qParams:{section:"notifications",_tb:1},loaded:!1,offset:0}),window.TopNotifier={onLoad:function onLoad(rows,js,offset,header){if(!offset||TopNotifierCur.offset!=offset){if((void 0===rows||"undefined"===rows)&&ajax.plainpost("/errors.php",{msg:ajax.lastResp||"TopNotifier load undefinded response",module:"top_notify",id:vk.id,host:locHost,lang:vk.lang,loc:(window.nav||{}).strLoc,realloc:location.toString()}),eval("(function(){"+js+";})()"),val(TopNotifier.getContentNode(),rows),TopNotifier.initUnreadHeader(),header&&!geByClass1("_top_notify_header")){if(TopNotifierCur.header=se(header),geByClass1("_notify_sticky")||geByClass1("_notify_unread")){var label=ce("div",{className:"top_notify_header_label"}),sup_label=ce("div",{className:"top_notify_header_sup_label",innerHTML:getLang("global_unread_notifications")}),sub_label=ce("div",{className:"top_notify_header_sub_label",innerHTML:getLang("global_viewed_notifications")});label.appendChild(sup_label),label.appendChild(sub_label)}else var label=ce("div",{innerHTML:getLang("global_notifitications")});TopNotifierCur.header.appendChild(label),TopNotifierCur.wrapper.insertBefore(TopNotifierCur.header,TopNotifierCur.wrapper.firstChild)}TopNotifierCur.offset=offset,TopNotifier.cleanCount(),TopNotifier.refresh()}},initUnreadHeader:function(){TopNotifierCur.header_unread=geByClass1("_notify_header"),TopNotifierCur.header_unread&&!TopNotifierCur.header_unread_handler&&(TopNotifierCur.header_unread_height=TopNotifierCur.header_unread.offsetHeight,TopNotifierCur.header_unread_handler=function(e){if(TopNotifierCur.header_unread){var t=TopNotifierCur.header_unread.offsetTop+TopNotifierCur.header_unread_height<e.data.scrollTop;t!=TopNotifierCur.swaped&&(toggleClass(TopNotifierCur.header,"top_notify_header_swap_labels",t),TopNotifierCur.swaped=t)}},TopNotifierCur.scrollbar.emitter.addListener("update",TopNotifierCur.header_unread_handler))},preload:function(){TopNotifier.shown()||vk.isBanned||TopNotifierCur.loaded||ajax.post("/al_feed.php",extend(clone(TopNotifierCur._qParams),{_preload:1}),{cache:1,onDone:function(e,t,a,i){TopNotifier.shown()&&geByClass1("pr","top_notify_cont")&&TopNotifier.onLoad(e,t,a,i)},stat:["feed.css","page.css","post.css"]})},loadMore:function(){var e=ge("ui_top_notify_load_more");e&&!isButtonLocked(e)&&(TopNotifierCur.ajax=ajax.post("/al_feed.php",extend(clone(TopNotifierCur._qParams),{offset:TopNotifierCur.offset,more:1,need_header:intval(!(geByClass1("_notify_header")||!geByClass1("_notify_sticky")&&!geByClass1("_notify_unread")))}),{onDone:function(t,a){if(TopNotifierCur.scrollbar){if(t){for(var i=null,r=TopNotifier.getContentNode(),n=cf(t);i=n.firstChild;)r.insertBefore(i,e);TopNotifier.initUnreadHeader()}return a?void(TopNotifierCur.offset=a):void re(e)}},showProgress:function(){show(e),lockButton(e)},hideProgress:function(){hide(e),unlockButton(e)}}))},show:function(e){if(checkEvent(e)!==!0&&!vk.isBanned){if(TopNotifier.shown()&&e!==!0)return gpeByClass("top_notify_wrap",e.target,ge("top_nav"))||TopNotifier.hide(),cancelEvent(e);vk.counts.ntf=0,TopNotifier.setCount(0,!0);var t=ge(TopNotifierCur.link),a=ge("top_notify_cont");
cur.introNotifyTooltipHide&&(cur.introNotifyTooltipHide(),delete cur.introNotifyTooltipHide),t.tt&&t.tt.hide&&t.tt.hide(),a||(TopNotifierCur.wrapper=ce("div",{innerHTML:'<div id="top_notify_cont" class="top_notify_cont wall_module" ontouchstart="event.cancelBubble = true;" onmousedown="event.cancelBubble = true;"></div><a href="/feed?section=notifications" class="top_notify_show_all" onmousedown="event.cancelBubble = true;" onclick="TopNotifier.hide(); return nav.go(this, event);">'+getLang("global_notify_show_all")+"</a>",id:"top_notify_wrap",className:"scroll_fix_wrap top_notify_wrap"}),t.appendChild(TopNotifierCur.wrapper),a=ge("top_notify_cont"));var i=window.innerHeight||document.documentElement.clientHeight;setStyle(a,{maxHeight:Math.min(Math.max(i-200,300),600)});var r=uiScroll;return TopNotifierCur.scrollbar&&TopNotifierCur.scrollbar.container.__uiScroll__||(TopNotifierCur.scrollbar=new r(a,{global:!0,stopScrollPropagationAlways:!0,onmore:TopNotifier.loadMore})),TopNotifierCur.loaded||(re(geByClass1("_notify_header")),re(geByClass1("_top_notify_header")),TopNotifierCur.offset=0,ajax.post("/al_feed.php",TopNotifierCur._qParams,{cache:1,onDone:TopNotifier.onLoad,showProgress:TopNotifier.showProgress,stat:["feed.css"]}),TopNotifierCur.loaded=!0),addClass(TopNotifierCur.link,"active"),TopNotifier.refresh(),e!==!0&&cancelStackPush("top_notifier",TopNotifier.hide.bind(TopNotifier),!0),e?cancelEvent(e):!1}},hide:function(){TopNotifier.shown()&&(removeClass(TopNotifierCur.link,"active"),cancelStackFilter("top_notifier",!0))},shown:function(){return hasClass(TopNotifierCur.link,"active")},getContentNode:function(){return TopNotifierCur.scrollbar&&TopNotifierCur.scrollbar.content&&TopNotifierCur.scrollbar.container.__uiScroll__?TopNotifierCur.scrollbar.content:ge("top_notify_cont")},showProgress:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(){var e=TopNotifier.getContentNode();geByClass1("pr",e)||(val(e,""),showProgress(e),TopNotifier.refresh())}),showTooltip:function(e){function t(t,a){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){function a(e){if(!e&&cur.topNotifyTTKey&&(e=cur.topNotifyTTKey,delete cur.topNotifyTTKey),e){var t=e.split(":"),a=ls.get("ntfseen")||{};2==t.length&&(a[0]=parseInt((new Date).getTime()/1e3),a[t[0]]=t[1],ls.set("ntfseen",a))}}if(!TopNotifier.shown()&&!isVisible("dev_top_nav")){var i=ge(TopNotifierCur.link),r={};if("shownow"==i.tt&&removeAttr(i,"tt"),e)r.text=function(){return e},t&&(r.onHide=a.pbind(t));else{i.tt&&i.tt.destroy&&i.tt.destroy();var n=ls.get("ntfseen")||{},s=[];each(n,function(e,t){s.push(e+":"+t)}),r=extend(r,{url:"al_feed.php",params:{act:"a_last_notify",seen:s.join(";")},ajaxdt:2e3,noload:1,onHide:a})}var o=function c(e){setTimeout(function(){return window.curNotifier&&curNotifier.idle_manager&&curNotifier.idle_manager.is_idle?void c(e):(e&&e.hide(),void Notifier.lcSend("hide_notify_tt"))},6e3)};showTooltip(i,extend(r,{typeClass:"top_notify_tt",dir:"up",width:250,shift:[0,0],nohideover:1,nohide:1,onShowStart:function(e){TopNotifier.shown()&&(e.opts.onHide=!1,e.hide()),addEvent(e.container,"mousedown",function(e){return e&&inArray(e.target.tagName,["A","IMG"])?void 0:(TopNotifier.show(e),cancelEvent(e))}),o(e),Notifier.setRecvClbk("hide_notify_tt",e.hide)}}))}}),invalidate:function(){TopNotifierCur.loaded=!1,ajax.invalidate("/al_feed.php",TopNotifierCur._qParams),TopNotifierCur.ajax&&TopNotifierCur.ajax.abort()},setCount:function(e,t){isString(e)&&(e=trim(e)),parseInt(e)>=100&&(e="+99"),hasClass(TopNotifierCur.link,"has_notify")&&e?animateCount(TopNotifierCur.count,e,{str:"auto"}):val(TopNotifierCur.count,e),toggleClass(TopNotifierCur.link,"has_notify",!!e),t||TopNotifier.invalidate()},cleanCount:function(){cur.topNotifyHash&&ajax.post("/al_feed.php",{act:"a_clean_notify",hash:cur.topNotifyHash})},refresh:function(){},postTooltip:function(e,t,a){return!1},hideRow:function(e,t,a){var i=gpeByClass("_feed_row",e);if(!i){var r=gpeByClass("top_notify_wrap",e);i=geByClass("_feed_row",r),i=i[i.length-1]}ajax.post("/al_feed.php",{act:"a_hide_notify",item:t,hash:a}),TopNotifier.hideActionsMenu(gpeByClass("_ui_menu_wrap",e)),slideUp(i,200,function(){re(i);var e=TopNotifier.getContentNode();geByClass("feed_row",e).length||val(e,'<div class="top_notify_empty no_rows">'+getLang("news_no_new_notifications")+"</div>"),TopNotifier.refresh()})},deleteRow:function(e,t,a,i,r,n){var s=ge("top_feedback_row"+e),o=geByClass1("post_actions",s);TopNotifier.hideActionsMenu(geByClass1("_ui_menu_wrap",s)),ajax.post("al_feed.php",{act:"a_feedback_delete",item:t,hash:i,types:a,candel:n,from:"top_notifier"},{onDone:function(e){var t=geByClass1("_post_content",s),a=geByClass1("_feedback_deleted",s);a?(a.innerHTML='<span class="dld_inner">'+e+"</span>",show(a)):s.appendChild(ce("div",{className:"feedback_row dld _feedback_deleted _top_feedback_deleted",innerHTML:'<span class="dld_inner">'+e+"</span>"})),hide(t),hasClass(s,"feedback_row_clickable")&&addClass(s,"feedback_row_touched"),TopNotifier.refresh()},showProgress:addClass.pbind(o,"post_actions_progress"),hideProgress:removeClass.pbind(o,"post_actions_progress")})},checkClick:function(e,t){if(t=t||window.event,!e||!t)return!0;var a=t.target||t.srcElement,i=8,r=!1,n=/(feedback_sticky_text|feedback_sticky_icon|feedback_row)/;do if(!a||a==e||a.onclick||a.onmousedown||inArray(a.tagName,["A","IMG","TEXTAREA","EMBED","OBJECT"])||(r=a.className.match(n)))break;while(i--&&(a=a.parentNode));if(!r)return!1;if(a&&a.className){for(var s=a.className.split(" "),o="unknown",c=-1,u=geByClass("feedback_row"),i=0;i<s.length;++i){var l=s[i].match("feedback_(.+)_row");if(s[i]&&l&&l[1]){o=l[1];break}}for(var i=0;i<u.length;++i)if(u[i]==a){c=i;break}statlogsValueEvent("feed_top_notify",0,"click",o,c)}return a||!0},ungroup:function ungroup(item,event){var el=ge("top_feedback_row"+item);if(event=event||window.event,el&&!hasClass(el,"feedback_row_expanded")&&!checkEvent(event)&&TopNotifier.checkClick(el,event)){var hid=domNS(domPN(el)),names=geByClass1("_header",el),text=domData(names,"text");show(hid),removeClass(el,"feedback_row_grouped"),addClass(el,"feedback_row_expanded"),val(names,text),el.onclick=eval("(function(){ if (!TopNotifier.checkClick(this, event)) return; "+unclean(domData(names,"click"))+";})")}},showActionsMenu:function(e){var t=!1,a=domClosest("_feed_row",e),i=domPN(a);i.lastChild!=a||hasClass(i,"feedback_sticky_rows")&&domPN(i).lastChild!=i||(t={appendParentCls:"top_notify_wrap",processHoverCls:hasClass(domPN(e),"post_actions")?"feedback_row":"feedback_sticky_row"}),uiActionsMenu.show(e,!1,t)},hideActionsMenu:function(e){uiActionsMenu.hide(e)},frProcess:function(e,t,a,i){if(!isButtonLocked(a)){var r;r=i?{act:"add",mid:e,hash:t,request:1,from:"top_notifier"}:{act:"remove",mid:e,hash:t,report_spam:1,from:"top_notifier"},statlogsValueEvent("feed_top_notify",0,"friends",r.act),ajax.post("/al_friends.php",r,{onDone:function(t){var r=domPN(a);val(r,t),addClass(r,"feedback_buttons_response"),"friends"==cur.module&&window.Friends&&(val("request_controls_"+e,t),window.Friends.processRequest(e,i))},onFail:function(e){return e?(setTimeout(showFastBox(getLang("global_error"),e).hide,3e3),!0):void 0},showProgress:lockButton.pbind(a),hideProgress:unlockButton.pbind(a)})}},grProcess:function(e,t,a,i){if(!(hasClass(a,"flat_button")&&isButtonLocked(a)||domFC(a)&&"progress_inline"==domFC(a))){var r=-2==i?"spam":i?"enter":"leave",n=-1==i?"_decline":"";ajax.post("/al_groups.php",{act:r,gid:e,hash:t,from:"top_notifier",context:n},{onDone:function(e){var t=domPN(a);val(t,e),addClass(t,"feedback_buttons_response")},onFail:function(e){return e?(setTimeout(showFastBox(getLang("global_error"),e).hide,3e3),!0):void 0},showProgress:function(){if(-2==i){a.oldhtml=a.innerHTML;var e=getSize(a)[0];a.innerHTML='<span class="progress_inline"></span>',setStyle(domFC(a),{width:e})}else lockButton(a)},hideProgress:function(){-2==i?a.innerHTML=a.oldhtml:unlockButton(a)}})}},showGiftBox:function(e,t){return!showBox("al_gifts.php",{act:"get_gift_box",fids:e,fr:1},{stat:["gifts.css","wide_dd.js","wide_dd.css"],cache:1,dark:1},t)}}},function(e,t){"use strict";function a(e,t){var a=this,i={minH:50,minW:50};a.options=t=extend(i,t),a.content=e;var r=a.id="rb_box_"+(t.id||curRBox.guid++);a.wrap=ce("div",{id:r,className:"rb_box_wrap fixed"+(t.fixed?" fc_fixed":"")});var n={};a.toBottom=a.toRight=!1,t.fixed?(n.bottom=0,n.right=72):(void 0!==t.startTop?n.top=t.startTop:void 0!==t.startBottom&&(n.bottom=t.startBottom),void 0!==t.startLeft?n.left=t.startLeft:void 0!==t.startRight&&(n.right=t.startRight)),setStyle(a.wrap,n),t.movable&&addEvent(t.movable,"mousedown",a._head_mdown.bind(a)),a.resizeableH=t.resizeableH||e,t.startHeight&&setStyle(a.resizeableH,"height",t.startHeight),a.resizeableW=t.resizeableW||e,t.startWidth&&setStyle(a.resizeableW,"width",t.startWidth),addEvent(e,"mousedown",a._cont_mdown.bind(a)),t.closer&&(addEvent(t.closer,"mousedown",a._close_mdown.bind(a)),addEvent(t.closer,"click",a._close_click.bind(a))),t.hider&&(addEvent(t.hider,"mousedown",a._close_mdown.bind(a)),addEvent(t.hider,"click",a._hide_click.bind(a))),t.minimizer&&t.minimizer!==!0&&(addEvent(t.minimizer,"mousedown",a._close_mdown.bind(a)),addEvent(t.minimizer,"click",a._min_toggle.bind(a))),a.wrap.appendChild(e),t.resize!==!1&&(a.resizeWrap=ce("div",{className:"rb_resize_wrap",innerHTML:'<div class="chats_sp rb_resize"></div>'}),a.wrap.appendChild(a.resizeWrap),addEvent(a.resizeWrap,"mousedown",a._resize_mdown.bind(a))),t.minimized&&(addClass(a.wrap,"rb_minimized"),a.minimized=!0),bodyNode.insertBefore(a.wrap,ge("page_wrap"));var s=getStyle(a.wrap,"top"),o=getStyle(a.wrap,"bottom"),c=getStyle(a.wrap,"left"),u=getStyle(a.wrap,"right");this.toBottom=("auto"===s||""===s||browser.msie&&0===s)&&"auto"!=o&&""!==o&&!(browser.msie&&0===o),this.toRight=("auto"===c||""===c||browser.msie&&0===c)&&"auto"!=u&&""!==u&&!(browser.msie&&0===u),this.toRight&&setStyle(a.wrap,{marginRight:lastWndScroll[0]?sbWidth():0}),(t.nofocus||t.noshow)&&addClass(a.wrap,"rb_inactive"),this.toBottom&&(setStyle(a.wrap,{marginRight:lastWndScroll[0]?sbWidth():0}),addClass(a.wrap,"fc_tobottom")),this.options.marginFixedToLayer&&setStyle(a.wrap,{marginRight:hasClass(document.body,"layers_shown")?sbWidth():0}),curRBox.tabs[r]=a,a.pos=!1,t.noshow?(setStyle(a.wrap,{visibility:"hidden",display:"block"}),a._update_pos(),setStyle(a.wrap,{visibility:"",display:""})):a.show(!1,t.nofocus)}window.curRBox||(window.curRBox={guid:0,active:!1,focused:[],tabs:{}});var i=1e4;extend(a.prototype,{show:function(e){function t(t,a){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){var a=this;void 0===e&&(e=0),e?(setStyle(a.wrap,{opacity:0,display:"block"}),a.visible=!0,!t&&a.focus(),animate(a.wrap,{opacity:1},e,function(){setStyle(a.wrap,browser.msie?{filter:"none"}:{opacity:""}),a._update_pos()})):(show(a.wrap),a.visible=!0,!t&&a.focus(),a._update_pos()),a.options.onShow&&a.options.onShow()}),hide:function(e){function t(t,a,i){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t,a){var i=this;return!t&&i.options.onBeforeHide&&i.options.onBeforeHide()?!0:(void 0===e&&(e=0),e?(setStyle(i.wrap,{opacity:1,display:"block"}),animate(i.wrap,{opacity:0},e,function(){hide(i.wrap),setStyle(i.wrap,browser.msie?{filter:"none"}:{opacity:""})})):hide(i.wrap),i.visible=!1,void(!t&&i.options.onHide&&i.options.onHide(a||{})))}),_head_mdown:function(e){if(!checkEvent(e)){(e.originalEvent||e).cancelBubble=!0;var t,a,i=this,r=e.target,n=getWndInner(),s=curRBox.active==i.id,o=e.pageY,c=e.pageX,u=i.wrap.offsetHeight,l=i.wrap.offsetWidth,d=0,f=0,h=n[0]-u,p=n[1]-l,_=browser.msie?"selectstart":"mousedown";i.options.fixed&&FastChat.pinTab(i.options.peer||-1,e,!0),s||i.focus(e),i.toBottom?(i.toBottom=!1,t=n[0]-intval(getStyle(i.wrap,"bottom"))-u,setStyle(i.wrap,{top:t,bottom:"auto"}),removeClass(i.wrap,"fc_tobottom")):t=intval(getStyle(i.wrap,"top")),i.toRight?(i.toRight=!1,a=n[1]-intval(getStyle(i.wrap,"right"))-l,setStyle(i.wrap,{left:a,right:"auto"})):a=intval(getStyle(i.wrap,"left")),d=t,f=a,cur._fcdrag=1;var m=function(e){return d=Math.max(0,Math.min(h,t+e.pageY-o)),10>h-d?d=h:10>d&&(d=0),i.wrap.style.top=d+"px",f=Math.max(0,Math.min(p,a+e.pageX-c)),10>p-f?f=p:10>f&&(f=0),i.wrap.style.left=f+"px",cancelEvent(e)},g=function v(e){cur._fcdrag=0,removeEvent(document,"mousemove",m),removeEvent(document,"mouseup",v),removeEvent(document,_,cancelEvent),setStyle(bodyNode,"cursor",""),setStyle(r,"cursor",""),(i.toBottom=d>=h-5)&&(setStyle(i.wrap,{top:"auto",bottom:0}),addClass(i.wrap,"fc_tobottom")),(i.toRight=f>=p-5)&&setStyle(i.wrap,{left:"auto",right:0,marginRight:lastWndScroll[0]?sbWidth():0}),i._update_pos();var t=Math.abs(e.pageY-o)<3&&Math.abs(e.pageX-c)<3;cur._fcpromo>0?cur._fcpromo=t?0:-1:i.options.minimizer&&t?!i.minimized&&s?i.minimize(!0):i.minimized&&i.unminimize(!0):i.options.onDragEnd&&i.options.onDragEnd(i.toBottom?-1:d/n[0],i.toRight?-1:f/n[1])};return addEvent(document,"mousemove",m),addEvent(document,"mouseup",g),addEvent(document,_,cancelEvent),setStyle(bodyNode,"cursor","move"),setStyle(r,"cursor","move"),!1}},_resize_mdown:function(e){if(!checkEvent(e)){this.focus(e);var t,a,i=this,r=e.target,n=getWndInner(),s=e.pageY,o=e.pageX,c=i.wrap.offsetHeight,u=i.wrap.offsetWidth,l=0,d=0,f=i.resizeableH.clientHeight-intval(getStyle(i.resizeableH,"paddingBottom"))-intval(getStyle(i.resizeableH,"paddingTop")),h=i.resizeableW.clientWidth-intval(getStyle(i.resizeableW,"paddingRight"))-intval(getStyle(i.resizeableW,"paddingLeft")),p=browser.msie?"selectstart":"mousedown",_=!browser.msie&&i.options.onResize||!1;i.toBottom?(i.toBottom=!1,t=n[0]-intval(getStyle(i.wrap,"bottom"))-c,setStyle(i.wrap,{top:t,bottom:"auto"}),removeClass(i.wrap,"fc_tobottom")):t=intval(getStyle(i.wrap,"top")),i.toRight?(i.toRight=!1,a=n[1]-intval(getStyle(i.wrap,"right"))-u,setStyle(i.wrap,{left:a,right:"auto"})):a=intval(getStyle(i.wrap,"left")),i.options.onResizeStart&&i.options.onResizeStart(f,h);var m=f+n[0]-t-c,g=h+n[1]-a-u,v=function(e){return l=Math.max(i.options.minH,Math.min(m,f+e.pageY-s)),10>m-l&&(l=m),i.resizeableH.style.height=l+"px",d=Math.max(i.options.minW,Math.min(g,h+e.pageX-o)),10>g-d&&(d=g),i.resizeableW.style.width=d+"px",_&&_(l,d),cancelEvent(e)},b=function C(e){removeEvent(document,"mousemove",v),removeEvent(document,"mouseup",C),removeEvent(document,p,cancelEvent),setStyle(bodyNode,"cursor",""),setStyle(r,"cursor",""),(i.toBottom=l==m)&&(setStyle(i.wrap,{top:"auto",bottom:0}),addClass(i.wrap,"fc_tobottom")),(i.toRight=d==g)&&setStyle(i.wrap,{left:"auto",right:0,marginRight:lastWndScroll[0]?sbWidth():0}),i._update_pos(),i.options.onResizeEnd&&i.options.onResizeEnd(l,d,n[0],n[1],i.toBottom,i.toRight)};return addEvent(document,"mousemove",v),addEvent(document,"mouseup",b),addEvent(document,p,cancelEvent),setStyle(bodyNode,"cursor","move"),setStyle(r,"cursor","move"),!1}},_update_pos:function(){var e=this;e.pos=[e.wrap.offsetTop,e.wrap.offsetLeft,e.wrap.offsetHeight,e.wrap.offsetWidth]},_wnd_resize:function(e,t,a){var i=this;i.toBottom&&(i.pos[0]=i.wrap.offsetTop),i.toRight&&(i.pos[1]=i.wrap.offsetLeft);var r={},n=!1,s=!1,o=i.pos[0]+i.pos[2]-e,c=i.pos[0],u=i.resizeableH.clientHeight-i.options.minH,l=i.pos[1]+i.pos[3]-t,d=i.pos[1],f=i.options.resize!==!1?i.resizeableW.clientWidth-i.options.minW:0;a&&(0>f&&setStyle(i.resizeableW,i.options.minW),0>u&&setStyle(i.resizeableH,i.options.minH)),(0>=o||0>=c&&0>=u)&&(0>=l||0>=d&&0>=f)||(o>0&&c>0&&(c=Math.min(o,c),o-=c,r.top=i.pos[0]-c,r.bottom=""),o>0&&u>0&&(u=Math.min(o,u),n=i.resizeableH.clientHeight-u),l>0&&d>0&&(d=Math.min(l,d),l-=d,r.left=i.pos[1]-d,r.right=""),l>0&&f>0&&(f=Math.min(l,f),s=i.resizeableW.clientWidth-f),s!==!1&&setStyle(i.resizeableW,"width",s),n!==!1&&setStyle(i.resizeableH,"height",n),setStyle(i.wrap,r),i._update_pos(),i.options.onResize&&i.options.onResize(i.resizeableH.clientHeight,i.resizeableW.clientWidth))},_cont_mdown:function(e){var t=curRBox.active!=this.id;return t&&(this.focus(e),!hasClass(e.target,"fc_editable"))?cancelEvent(e):void 0},_focus:function(){var e=this,t=indexOf(curRBox.focused,e.id),a=curRBox.active,r=a&&curRBox.tabs[a];if(a!=e.id){r&&isFunction(r.options.onBlur)&&r.options.onBlur(),-1!=t&&curRBox.focused.splice(t,1),curRBox.focused.unshift(e.id);var n=i+curRBox.focused.length,s=!0;each(curRBox.focused,function(e,t){var a=curRBox.tabs[t].wrap;s?(addClass(a,"rb_active"),removeClass(a,"rb_inactive"),curRBox.active=t,s=!1):(removeClass(a,"rb_active"),addClass(a,"rb_inactive")),setStyle(a,"zIndex",n),n--})}},_hide_click:function(){this.hide()},minimize:function(e){var t=this,a=t.wrap;return t.options.fixed?!1:(addClass(a,"rb_minimized"),t.minimized=!0,t._update_pos(),void(e&&t.options.onMinimize&&t.options.onMinimize(0)))},unminimize:function(e){var t=this,a=t.wrap,i=getWndInner();removeClass(a,"rb_minimized"),t.minimized=!1,t._update_pos(),t._wnd_resize(i[0],i[1],!0),curRBox.active=!1,t.focus(),e&&t.options.onMinimize&&t.options.onMinimize(1)},_min_toggle:function(e){var t=this;setTimeout(function(){t.minimized?t.unminimize(!0):t.minimize(!0)},50)},destroy:function(){var e=this,t=indexOf(curRBox.focused,e.id);-1!=t&&curRBox.focused.splice(t,1),cleanElems(e.wrap,e.resizeWrap,e.content,e.options.movable,e.options.closer,e.options.hider),re(e.wrap),delete curRBox.tabs[e.id]},_close_mdown:function(e){(e.originalEvent||e).cancelBubble=!0},_close_click:function(e){this.close()},_close:function(e){this.destroy(),curRBox.focused[0]&&e!==!0&&curRBox.tabs[curRBox.focused[0]].focus()},focus:function(e){var t=this,a=curRBox.active!=t.id||!0;return t._focus(),a&&isFunction(t.options.onFocus)&&t.options.onFocus(e),a},close:function(){var e=this,t=e.pos;e._close(),isFunction(e.options.onClose)&&e.options.onClose(t)}}),window.RBox=a},,,,function(e,t,a){var i=a(125)("keys"),r=a(25);e.exports=function(e){return i[e]||(i[e]=r(e))}},,function(e,t,a){var i=a(129)("iterator"),r=!1;try{var n=[7][i]();n["return"]=function(){r=!0},Array.from(n,function(){throw 2})}catch(s){}e.exports=function(e,t){if(!t&&!r)return!1;var a=!1;try{var n=[7],s=n[i]();s.next=function(){a=!0},n[i]=function(){return s},e(n)}catch(o){}return a}},function(e,t){var a=e.exports={version:"2.2.1"};"number"==typeof __e&&(__e=a)},function(e,t,a){var i=a(93),r="__core-js_shared__",n=i[r]||(i[r]={});e.exports=function(e){return n[e]||(n[e]={})}},,function(e,t){"use strict";function a(e,t,a){return new Promise(function(i,r){ajax.post(e,t,{timeout:a,onDone:function(){i.apply(null,[[].concat(Array.prototype.slice.call(arguments))])},onFail:function(){return r.apply(null,arguments),!0}})})}function i(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=r(e,t,a),n=i.request;return i.cancel,n}function r(e,t){function a(){r.abort()}var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=void 0;r=window.XDomainRequest?new XDomainRequest:ajax._getreq();var n=new Promise(function(a,n){var s,o=Date.now(),c=i.timeout||60,u=ajx2q(t);if(window.XDomainRequest)r.open("get",e+"?"+u),r.ontimeout=function(){n("",{})},r.onerror=function(){n("",{})},r.onload=function(){a(r.responseText)},setTimeout(function(){r.send()},0);else{r.onreadystatechange=function(){4==r.readyState&&(clearInterval(s),r.status>=200&&r.status<300?a(r.responseText,r):n(r.responseText,r))};try{r.open("GET",e+"?"+u,!0)}catch(l){return n(l)}r.send()}s=setInterval(function(){Date.now()-o>1e3*c&&(n("",{}),clearInterval(s))},1e3)});return{request:n,cancel:a}}Object.defineProperty(t,"__esModule",{value:!0}),t.post=a,t.plainget=i,t.plaingetCancelable=r,t.CONTROLLER="al_im.php"},,function(e,t,a){var i=a(125)("wks"),r=a(25),n=a(93).Symbol,s="function"==typeof n;e.exports=function(e){return i[e]||(i[e]=s&&n[e]||(s?n:r)("Symbol."+e))}},function(e,t,a){var i=a(30);e.exports=function(e,t,a){for(var r in t)i(e,r,t[r],a);return e}},,function(e,t,a){var i=a(129)("unscopables"),r=Array.prototype;void 0==r[i]&&a(96)(r,i,{}),e.exports=function(e){r[i][e]=!0}},function(e,t,a){var i=a(69),r=a(99),n=a(100);e.exports=a(50)?Object.defineProperties:function(e,t){r(e);for(var a,s=n(t),o=s.length,c=0;o>c;)i.f(e,a=s[c++],t[a]);return e}},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t,a){var i=a(59),r=a(82),n=a(121)("IE_PROTO"),s=Object.prototype;e.exports=Object.getPrototypeOf||function(e){return e=r(e),i(e,n)?e[n]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?s:null}},function(e,t){"use strict";function a(e){this.started=!1,this.is_idle=!0,this.is_activated=!1,this.activeTimeStart=null,this.cbActiveB=this.cbActive.bind(this),this.cbInactiveB=this.cbInactive.bind(this),this.cbInactiveB=this.cbInactive.bind(this),this.opts=extend({triggerEvents:"mousemove keydown",onIdleCb:function(){},onUnIdleCb:function(){},focusElement:e.element,element:null,idleTimeout:3e4},e)}extend(a.prototype,EventEmitter.prototype),extend(a.prototype,{stop:function(){this.started=!1,removeEvent(this.opts.element,this.opts.triggerEvents,this.cbActiveB),removeEvent(this.opts.focusElement,"focus",this.cbActiveB),removeEvent(this.opts.focusElement,"blur",this.cbInactiveB),clearTimeout(this.setIdleTo),clearTimeout(this.checkIdleCbTo),clearTimeout(this.sendCbTO),this.is_idle=!0,this.opts.parentManager&&this.opts.parentManager.off("idle",this.cbInactiveB)},idle:function(e){this.is_idle=!0,e||this.opts.onIdleCb(),this.emit("idle")},unidle:function(e){this.is_idle=!1,e||this.opts.onUnIdleCb(),this.emit("unidle")},activate:function(){this.is_idle=!1,this.is_activated=!0},start:function(){this.started=!0,browser.mobile||(this.opts.parentManager&&this.opts.parentManager.on("idle",this.cbInactiveB),addEvent(this.opts.focusElement,"focus",this.cbActiveB),addEvent(this.opts.focusElement,"blur",this.cbInactiveB),clearTimeout(this.checkIdleCbTo),this.checkIdleCb(),this.checkIdleCbTo=setTimeout(this.checkIdleCb.bind(this),this.opts.idleTimeout))},checkIdleCb:function(){this.started&&(addEvent(this.opts.element,this.opts.triggerEvents,this.cbActiveB),clearTimeout(this.setIdleTo),this.setIdleTo=setTimeout(this.cbInactiveB,this.opts.idleTimeout))},cbActive:function(){this.started&&(this.activeTimeStart=(new Date).getTime(),clearTimeout(this.setIdleTo),this.is_idle&&(this.is_idle=!1,clearTimeout(this.sendCbTO),this.sendCbTO=setTimeout(function(){this.emit("unidle"),this.opts.onUnIdleCb&&this.opts.onUnIdleCb()}.bind(this),100)),removeEvent(this.opts.element,this.opts.triggerEvents,this.cbActiveB),clearTimeout(this.checkIdleCbTo),this.checkIdleCbTo=setTimeout(this.checkIdleCb.bind(this),this.opts.idleTimeout))},cbInactive:function(){this.started&&(this.activeTimeStart=null,this.is_idle||(this.is_idle=!0,clearTimeout(this.sendCbTO),this.sendCbTO=setTimeout(function(){this.emit("idle"),this.opts.onIdleCb&&this.opts.onIdleCb()}.bind(this),100)),clearTimeout(this.checkIdleCbTo),removeEvent(this.opts.element,this.opts.triggerEvents,this.cbActiveB),addEvent(this.opts.element,this.opts.triggerEvents,this.cbActiveB),this.checkIdleCbTo=setTimeout(this.checkIdleCb,this.opts.idleTimeout))},getActiveTime:function(){return!this.is_idle&&this.activeTimeStart?(new Date).getTime()-this.activeTimeStart:0}}),window.IdleManager=a},function(e,t,a){var i=a(38),r=a(99),n=function(e,t){if(r(e),!i(t)&&null!==t)throw TypeError(t+": can't set as prototype!")};e.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(e,t,i){try{i=a(67)(Function.call,a(5).f(Object.prototype,"__proto__").set,2),i(e,[]),t=!(e instanceof Array)}catch(r){t=!0}return function(e,a){return n(e,a),t?e.__proto__=a:i(e,a),e}}({},!1):void 0),check:n}},function(e,t,a){"use strict";var i=a(93),r=a(75),n=a(30),s=a(130),o=a(48),c=a(43),u=a(23),l=a(38),d=a(80),f=a(123),h=a(54),p=a(61);e.exports=function(e,t,a,_,m,g){var v=i[e],b=v,C=m?"set":"add",y=b&&b.prototype,w={},N=function(e){var t=y[e];n(y,e,"delete"==e?function(e){return g&&!l(e)?!1:t.call(this,0===e?0:e)}:"has"==e?function(e){return g&&!l(e)?!1:t.call(this,0===e?0:e)}:"get"==e?function(e){return g&&!l(e)?void 0:t.call(this,0===e?0:e)}:"add"==e?function(e){return t.call(this,0===e?0:e),this}:function(e,a){return t.call(this,0===e?0:e,a),this})};if("function"==typeof b&&(g||y.forEach&&!d(function(){(new b).entries().next()}))){var T=new b,F=T[C](g?{}:-0,1)!=T,k=d(function(){T.has(1)}),E=f(function(e){new b(e)}),S=!g&&d(function(){for(var e=new b,t=5;t--;)e[C](t,t);return!e.has(-0)});E||(b=t(function(t,a){u(t,b,e);var i=p(new v,t,b);return void 0!=a&&c(a,m,i[C],i),i}),b.prototype=y,y.constructor=b),(k||S)&&(N("delete"),N("has"),m&&N("get")),(S||F)&&N(C),g&&y.clear&&delete y.clear}else b=_.getConstructor(t,e,m,C),s(b.prototype,a),o.NEED=!0;return h(b,e),w[e]=b,r(r.G+r.W+r.F*(b!=v),w),g||_.setStrong(b,e,m),b}},function(e,t,a){"use strict";var i=a(63),r=a(75),n=a(30),s=a(96),o=a(59),c=a(2),u=a(109),l=a(54),d=a(135),f=a(129)("iterator"),h=!([].keys&&"next"in[].keys()),p="@@iterator",_="keys",m="values",g=function(){return this};e.exports=function(e,t,a,v,b,C,y){u(a,t,v);var w,N,T,F=function(e){if(!h&&e in x)return x[e];switch(e){case _:return function(){return new a(this,e)};case m:return function(){return new a(this,e)}}return function(){return new a(this,e)}},k=t+" Iterator",E=b==m,S=!1,x=e.prototype,L=x[f]||x[p]||b&&x[b],I=L||F(b),O=b?E?F("entries"):I:void 0,M="Array"==t?x.entries||L:L;if(M&&(T=d(M.call(new e)),T!==Object.prototype&&(l(T,k,!0),i||o(T,f)||s(T,f,g))),E&&L&&L.name!==m&&(S=!0,I=function(){return L.call(this)}),i&&!y||!h&&!S&&x[f]||s(x,f,I),c[t]=I,c[k]=g,b)if(w={values:E?I:F(m),keys:C?I:F(_),entries:O},y)for(N in w)N in x||n(x,N,w[N]);else r(r.P+r.F*(h||S),t,w);return w}},function(e,t,a){var i=a(77),r=a(129)("iterator"),n=a(2);e.exports=a(124).getIteratorMethod=function(e){return void 0!=e?e[r]||e["@@iterator"]||n[i(e)]:void 0}}]);